% ------------------------------------------------------------  
% Based on an autogenerated LaTeX file from the DocBook specs
% ------------------------------------------------------------  
\ifx\pdfoutput\undefined
\documentclass[a4paper,10pt,twoside,openright]{scidoc}
\else
\documentclass[pdftex,,a4paper,10pt,twoside,openright]{scidoc}
\fi
\label{id2423053}\usepackage{ifthen}
% --------------------------------------------
% Check for PDFLaTeX/LaTeX 
% --------------------------------------------
\newif\ifpdf
\ifx\pdfoutput\undefined
\pdffalse % we are not running PDFLaTeX
\else
\pdfoutput=1 % we are running PDFLaTeX
\pdftrue
\fi
% --------------------------------------------
% Load graphicx package with pdf if needed 
% --------------------------------------------
\ifpdf
\usepackage[pdftex]{graphicx}
\pdfcompresslevel=9
\else
\usepackage{graphicx}
\fi
\usepackage{anysize}
\marginsize{3cm}{2cm}{1.25cm}{1.25cm}

\makeatletter
% redefine the listoffigures and listoftables so that the name of the chapter
% is printed whenever there are figures or tables from that chapter. encourage
% pagebreak prior to the name of the chapter (discourage orphans).
\let\save@@chapter\@chapter
\let\save@@l@figure\l@figure
\let\the@l@figure@leader\relax
\def\@chapter[#1]#2{\save@@chapter[{#1}]{#2}%
\addtocontents{lof}{\protect\def\the@l@figure@leader{\protect\pagebreak[0]\protect\contentsline{chapter}{\protect\numberline{\thechapter}#1}{}{\thepage}}}%
\addtocontents{lot}{\protect\def\the@l@figure@leader{\protect\pagebreak[0]\protect\contentsline{chapter}{\protect\numberline{\thechapter}#1}{}{\thepage}}}%
}
\usepackage{longtable}
\renewcommand*\l@figure{\the@l@figure@leader\let\the@l@figure@leader\relax\save@@l@figure}
\let\l@table\l@figure
\makeatother
\usepackage{fancyhdr}
\renewcommand{\headrulewidth}{0.4pt}
\renewcommand{\footrulewidth}{0.4pt}
% Safeguard against long headers.
\IfFileExists{truncate.sty}{
\usepackage{truncate}
% Use an ellipsis when text would be larger than x% of the text width.
% Preserve left/right text alignment using \hfill (works for English).
\fancyhead[ol]{\truncate{0.49\textwidth}{\sl\leftmark}}
\fancyhead[er]{\truncate{0.49\textwidth}{\hfill\sl\rightmark}}
\fancyhead[el]{\truncate{0.49\textwidth}{\sl\leftmark}}
\fancyhead[or]{\truncate{0.49\textwidth}{\hfill\sl\rightmark}}
}{\typeout{WARNING: truncate.sty wasn't available and functionality was skipped.}}
\pagestyle{fancy}
% ---------------------- 
% Most Common Packages   
% ---------------------- 
\usepackage{latexsym}         
\usepackage{enumerate}         
\usepackage{booktabs}
\usepackage{fancybox}      
\usepackage{float}       
\usepackage{ragged2e}       
\usepackage{fancyvrb}         
\makeatletter\@namedef{FV@fontfamily@default}{\def\FV@FontScanPrep{}\def\FV@FontFamily{}}\makeatother
\fvset{obeytabs=true,tabsize=3}
\makeatletter
\let\dblatex@center\center\let\dblatex@endcenter\endcenter
\def\dblatex@nolistI{\leftmargin\leftmargini\topsep\z@ \parsep\parskip \itemsep\z@}
\def\center{\let\@listi\dblatex@nolistI\@listi\dblatex@center\let\@listi\@listI\@listi}
\def\endcenter{\dblatex@endcenter}
\makeatother
\usepackage{rotating}         
\usepackage{subfigure}         
\usepackage{tabularx}         
\usepackage{url}         
% --------------------------------------------
% Math support                                
% --------------------------------------------
\usepackage{amsmath,amsthm, amsfonts, amssymb, amsxtra,amsopn}
%\newtheorem{thm}{Theorem}[section]
%\newtheorem{cor}[section]{Corollary}
%\newtheorem{lem}[section]{Lemma}
%\newtheorem{defn}[section]{Definition}
%\newtheorem{prop}[section]{Proposition}
%\newtheorem{ax}{Axiom}
%\newtheorem{theorem}[section]{Theorem}
%\newtheorem{corollary}{Corollary}
%\newtheorem{lemma}{Lemma}
%\newtheorem{proposition}{Proposition}
%\theoremstyle{definition}
%\newtheorem{definition}{Definition}
%\theoremstyle{remark}
%\newtheorem{rem}{Remark}
%\newtheorem*{notation}{Notation}
%\newcommand{\ntt}{\normalfont\ttfamily}
%\newcommand{\thmref}[1]{Theorem~\ref{#1}}
%\newcommand{\secref}[1]{\P\ref{#1}}
%\newcommand{\lemref}[1]{Lemma~\ref{#1}}
 \newcommand{\bysame}{\mbox{\rule{3em}{.4pt}}\,}
 \newcommand{\A}{\mathcal{A}}
 \newcommand{\B}{\mathcal{B}}
 \newcommand{\XcY}{{(X,Y)}}
 \newcommand{\SX}{{S_X}}
 \newcommand{\SY}{{S_Y}}
 \newcommand{\SXY}{{S_{X,Y}}}
 \newcommand{\SXgYy}{{S_{X|Y}(y)}}
 \newcommand{\Cw}[1]{{\hat C_#1(X|Y)}}
 \newcommand{\G}{{G(X|Y)}}
 \newcommand{\PY}{{P_{\mathcal{Y}}}}
 \newcommand{\X}{\mathcal{X}}
 \newcommand{\wt}{\widetilde}
 \newcommand{\wh}{\widehat}

%-----------------------------------------------------------
% Use the following macros for typesetting specific stuff:

 \newcommand{\tuple}[1]{\langle #1 \rangle}
 \newcommand{\resource}[1]{\texttt{#1}}
 \newcommand{\nat}{\mathbb{N}}
 \newcommand{\bool}{\mathbb{B}}
 \newcommand{\Btt}{\textrm{tt}}
 \newcommand{\Bff}{\textrm{ff}}
 \newcommand{\Node}{\textsc{Node}}

 % --------------------------------------------
 %\DeclareMathOperator{\per}{per}
 \DeclareMathOperator{\cov}{cov}
 \DeclareMathOperator{\non}{non}
 \DeclareMathOperator{\cf}{cf}
 \DeclareMathOperator{\add}{add}
 \DeclareMathOperator{\Cham}{Cham}
 \DeclareMathOperator{\IM}{Im}
 \DeclareMathOperator{\esssup}{ess\,sup}
 \DeclareMathOperator{\meas}{meas}
 \DeclareMathOperator{\seg}{seg}
% --------------------------------------------
% ---------------
% Document Font  
% ---------------
\usepackage{palatino}
% --------------------------------------------
% Load hyperref package with pdf if needed 
% --------------------------------------------
\ifpdf
\usepackage[pdftex,bookmarksnumbered,colorlinks,backref,bookmarks,breaklinks,linktocpage,plainpages=false,pdfstartview=FitH]{hyperref}
\else
\usepackage[bookmarksnumbered,colorlinks,backref,bookmarks,breaklinks,linktocpage,plainpages=false,]{hyperref}
\fi
% --------------------------------------------
% ----------------------------------------------
% Define a new LaTeX environment (adminipage)
% ----------------------------------------------
\newenvironment{admminipage}%
{ % this code corresponds to the \begin{adminipage} command
 \begin{Sbox}%
 \begin{minipage}%
} %done
{ % this code corresponds to the \end{adminipage} command
 \end{minipage}
 \end{Sbox}
 \fbox{\TheSbox}
} %done
% ----------------------------------------------
% Define a new LaTeX length (admlength)
% ----------------------------------------------
\newlength{\admlength}
% ----------------------------------------------
% Define a new LaTeX environment (admonition)
% With 2 parameters:
% #1 The file (e.g. note.pdf)
% #2 The caption
% ----------------------------------------------
\newenvironment{admonition}[2] 
{ % this code corresponds to the \begin{admonition} command
 \hspace{0mm}\newline\hspace*\fill\newline
 \noindent
 \setlength{\fboxsep}{5pt}
 \setlength{\admlength}{\linewidth}
 \addtolength{\admlength}{-10\fboxsep}
 \addtolength{\admlength}{-10\fboxrule}
 \admminipage{\admlength}
 {\bfseries \sc\large{#2}} \newline
 \\[1mm]
 \sffamily
 \includegraphics[width=1cm]{#1}
 \addtolength{\admlength}{-1cm}
 \addtolength{\admlength}{-20pt}
 \begin{minipage}[lt]{\admlength}
 \parskip=0.5\baselineskip \advance\parskip by 0pt plus 2pt
} %done
{ % this code corresponds to the \end{admonition} command
 \vspace{5mm} 
 \end{minipage}
 \endadmminipage
 \vspace{.5em}
 \par
}
% --------------------------------------------
% Commands to manage/style/create floats      
% figures, tables, algorithms, examples, eqn  
% --------------------------------------------
 \floatstyle{ruled}
 \restylefloat{figure}
 \floatstyle{ruled}
 \restylefloat{table}
 \floatstyle{ruled}
 \newfloat{program}{ht}{lop}[section]
 \floatstyle{ruled}
 \newfloat{example}{ht}{loe}[section]
 \floatname{example}{Exemple}
 \floatstyle{ruled}
 \newfloat{dbequation}{ht}{loe}[section]
 \makeatletter\def\toclevel@dbequation{0}\makeatother
 \floatname{dbequation}{Equation}
 \floatstyle{boxed}
 \newfloat{algorithm}{ht}{loa}[section]
 \floatname{algorithm}{Algorithm}
\ifpdf
\DeclareGraphicsExtensions{.pdf,.png,.jpg}
\else
\DeclareGraphicsExtensions{.eps}
\fi
% --------------------------------------------
% $latex.caption.swapskip enabled for $formal.title.placement support
\newlength{\docbooktolatextempskip}
\newcommand{\captionswapskip}{\setlength{\docbooktolatextempskip}{\abovecaptionskip}\setlength{\abovecaptionskip}{\belowcaptionskip}\setlength{\belowcaptionskip}{\docbooktolatextempskip}}
% Guard against a problem with old package versions.
\makeatletter
\AtBeginDocument{
\DeclareRobustCommand\ref{\@refstar}
\DeclareRobustCommand\pageref{\@pagerefstar}
}
\makeatother
% --------------------------------------------
\makeatletter
\newcommand{\dbz}{\penalty \z@}
\newcommand{\docbooktolatexpipe}{\ensuremath{|}\dbz}
\newskip\docbooktolatexoldparskip
\newcommand{\docbooktolatexnoparskip}{\docbooktolatexoldparskip=\parskip\parskip=0pt plus 1pt}
\newcommand{\docbooktolatexrestoreparskip}{\parskip=\docbooktolatexoldparskip}
\def\cleardoublepage{\clearpage\if@twoside \ifodd\c@page\else\hbox{}\thispagestyle{empty}\newpage\if@twocolumn\hbox{}\newpage\fi\fi\fi}
\usepackage[latin1]{inputenc}

\ifx\dblatex@chaptersmark\@undefined\def\dblatex@chaptersmark#1{\markboth{\MakeUppercase{#1}}{}}\fi
\let\save@makeschapterhead\@makeschapterhead
\def\dblatex@makeschapterhead#1{\vspace*{-80pt}\save@makeschapterhead{#1}}
\def\@makeschapterhead#1{\dblatex@makeschapterhead{#1}\dblatex@chaptersmark{#1}}

                        
\AtBeginDocument{\ifx\refname\@undefined\let\docbooktolatexbibname\bibname\def\docbooktolatexbibnamex{\bibname}\else\let\docbooktolatexbibname\refname\def\docbooktolatexbibnamex{\refname}\fi}
% Facilitate use of \cite with \label
\newcommand{\docbooktolatexbibaux}[2]{%
  \protected@write\@auxout{}{\string\global\string\@namedef{docbooktolatexcite@#1}{#2}}
}
% Provide support for bibliography `subsection' environments with titles
\newenvironment{docbooktolatexbibliography}[3]{
   \begingroup
   \let\save@@chapter\chapter
   \let\save@@section\section
   \let\save@@@mkboth\@mkboth
   \let\save@@bibname\bibname
   \let\save@@refname\refname
   \let\@mkboth\@gobbletwo
   \def\@tempa{#3}
   \def\@tempb{}
   \ifx\@tempa\@tempb
      \let\chapter\@gobbletwo
      \let\section\@gobbletwo
      \let\bibname\relax
   \else
      \let\chapter#2
      \let\section#2
      \let\bibname\@tempa
   \fi
   \let\refname\bibname
   \begin{thebibliography}{#1}
}{
   \end{thebibliography}
   \let\chapter\save@@chapter
   \let\section\save@@section
   \let\@mkboth\save@@@mkboth
   \let\bibname\save@@bibname
   \let\refname\save@@refname
   \endgroup
}

                
                        
%\usepackage{cite}
%\renewcommand\citeleft{(}  % parentheses around list
%\renewcommand\citeright{)} % parentheses around list
\newcommand{\docbooktolatexcite}[2]{%
  \@ifundefined{docbooktolatexcite@#1}%
  {\cite{#1}}%
  {\def\@docbooktolatextemp{#2}\ifx\@docbooktolatextemp\@empty%
   \cite{\@nameuse{docbooktolatexcite@#1}}%
   \else\cite[#2]{\@nameuse{docbooktolatexcite@#1}}%
   \fi%
  }%
}
\newcommand{\docbooktolatexbackcite}[1]{%
  \ifx\Hy@backout\@undefined\else%
    \@ifundefined{docbooktolatexcite@#1}{%
      % emit warning?
    }{%
      \ifBR@verbose%
        \PackageInfo{backref}{back cite \string`#1\string' as \string`\@nameuse{docbooktolatexcite@#1}\string'}%
      \fi%
      \Hy@backout{\@nameuse{docbooktolatexcite@#1}}%
    }%
  \fi%
}

                
                        
% --------------------------------------------
% A way to honour <footnoteref>s
% Blame j-devenish (at) users.sourceforge.net
% In any other LaTeX context, this would probably go into a style file.
\newcommand{\docbooktolatexusefootnoteref}[1]{\@ifundefined{@fn@label@#1}%
  {\hbox{\@textsuperscript{\normalfont ?}}%
    \@latex@warning{Footnote label `#1' was not defined}}%
  {\@nameuse{@fn@label@#1}}}
\newcommand{\docbooktolatexmakefootnoteref}[1]{%
  \protected@write\@auxout{}%
    {\global\string\@namedef{@fn@label@#1}{\@makefnmark}}%
  \@namedef{@fn@label@#1}{\hbox{\@textsuperscript{\normalfont ?}}}%
  }

                
                        
% index labeling helper
\newif\ifdocbooktolatexprintindex\docbooktolatexprintindextrue
\let\dbtolatex@@theindex\theindex
\let\dbtolatex@@endtheindex\endtheindex
\def\theindex{\relax}
\def\endtheindex{\relax}
\newenvironment{dbtolatexindex}[1]
   {
\if@openright\cleardoublepage\else\clearpage\fi
\let\dbtolatex@@indexname\indexname
\def\dbtolatex@indexlabel{%
 \ifnum \c@secnumdepth >\m@ne \refstepcounter{chapter}\fi%
 \label{#1}\hypertarget{#1}{\dbtolatex@@indexname}%
 \global\docbooktolatexprintindexfalse}
\def\indexname{\ifdocbooktolatexprintindex\dbtolatex@indexlabel\else\dbtolatex@@indexname\fi}
\dbtolatex@@theindex
   }
   {
\dbtolatex@@endtheindex\let\indexname\dbtolatex@@indexname
   }

\newlength\saveparskip \newlength\saveparindent
\newlength\tempparskip \newlength\tempparindent

                
\def\docbooktolatexgobble{\expandafter\@gobble}
% Prevent multiple openings of the same aux file
% (happens when backref is used with multiple bibliography environments)
\ifx\AfterBeginDocument\undefined\let\AfterBeginDocument\AtBeginDocument\fi
\AfterBeginDocument{
   \let\latex@@starttoc\@starttoc
   \def\@starttoc#1{%
      \@ifundefined{docbooktolatex@aux#1}{%
         \global\@namedef{docbooktolatex@aux#1}{}%
         \latex@@starttoc{#1}%
      }{}
   }
}
% --------------------------------------------
% Hacks for honouring row/entry/@align
% (\hspace not effective when in paragraph mode)
% Naming convention for these macros is:
% 'docbooktolatex' 'align' {alignment-type} {position-within-entry}
% where r = right, l = left, c = centre
\newcommand{\docbooktolatex@align}[2]{\protect\ifvmode#1\else\ifx\LT@@tabarray\@undefined#2\else#1\fi\fi}
\newcommand{\docbooktolatexalignll}{\docbooktolatex@align{\raggedright}{}}
\newcommand{\docbooktolatexalignlr}{\docbooktolatex@align{}{\hspace*\fill}}
\newcommand{\docbooktolatexaligncl}{\docbooktolatex@align{\centering}{\hfill}}
\newcommand{\docbooktolatexaligncr}{\docbooktolatex@align{}{\hspace*\fill}}
\newcommand{\docbooktolatexalignrl}{\protect\ifvmode\raggedleft\else\hfill\fi}
\newcommand{\docbooktolatexalignrr}{}

\newcommand{\kfuncparamlist}{\textbf{Parameters:}\\}
\newcommand{\kfuncparam}[1]{\textit{#1}}
\newcommand{\kfuncty}[1]{$: \textbf{#1}$}

\ifx\captionswapskip\@undefined\newcommand{\captionswapskip}{}\fi
\makeatother
\title{\bfseries The Sierra Creative Interpreter}
\author{Lars Skovlund, Christoph Reichenbach, Ravi Iyengar,\\ Rickard Lind, Vladimir Gneushev, Petr Vyhnak, \\ Dark Minister, Francois Boyer, Carl Muckenhoupt}
% --------------------------------------------
\makeindex
\makeglossary
% --------------------------------------------
\setcounter{tocdepth}{4}
\setcounter{secnumdepth}{4}
\begin{document}

\InputIfFileExists{title}{\typeout{WARNING: Using cover page title}}{\maketitle\pagestyle{fancy}
\thispagestyle{empty}}

{\if@twocolumn
\noindent\small\textit{
Legal notice}\/\bfseries---$\!$%
\else
\noindent\begin{center}\small\bfseries 
Legal notice\end{center}\begin{quote}\small
\fi

Copyright (C) 1999, 2000, 2001, 2002 by the authors

Permission is hereby granted, free of charge, to any person obtaining a copy of this documentation to deal in the Documentation without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Documentation, and to permit persons to whom the Documentation is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Documentation.

THE DOCUMENTATION IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE DOCUMENTATION OR THE USE OR OTHER DEALINGS IN THE DOCUMENTATION.

The Sierra Creative Interpreter was originally developed by Sierra On-Line, Inc. "Sierra On-Line Inc.\texttrademark" is a registered trademark of Sierra On-Line, Inc. "Quest for Glory: So You Want To Be A Hero", "Quest For Glory 2: Trial By Fire" and "Space Quest 3: The Pirates of Pestulon" are trademarks of Sierra On-Line, Inc.
\vspace{0.6em}\par\if@twocolumn\else\end{quote}\fi}

% --------------------------------------------
% Abstract 
% --------------------------------------------
\begin{abstract}

This book describes the Sierra Creative Interpreter, versions 0.xxx and 1.xxx to the extent known to the general public, as well as the FreeSCI interpreter for those games. Please contact the author if you find that anything is being described incorrectly or missing. 

\textbf{NOTE:} This version of the documentation is incomplete and covers only some parts of SCI0.


\end{abstract}

% -------------------------------------------------------------
% Preface 
% -------------------------------------------------------------
\chapter*{Preface}%
\label{id2428713}\hypertarget{id2428713}{}%

Throughout the documentation, the term SCI will be used to describe the original Sierra Creative Interpreter, in any version. SCI0 will refer to all games using the SCI version 0.xxx, except for those games who use the 'in-between' game engine referred to as SCI01 (such as Quest for Glory 2). SCI1 will refer to the interpreter version 1.xxx. FreeSCI will refer specifically to either implementation details of the FreeSCI engine or to extensions of the original SCI engine specific to FreeSCI.

I would like to take this opportunity to thank the members of the FreeSCI and SCI Decoding Projects and their supporters, as well as Carl Muckenhoupt, who took the first steps of SCI decoding, for their valuable help and support.

Please note that some of the text contributions have been cut, reformatted or slightly modified in an attempt to improve the general quality of this document.

% -------------------------------------------------------------
% Chapter Introduction 
% -------------------------------------------------------------         
\chapter{Introduction}
\label{id2428744}\hypertarget{id2428744}{}%

% ------------------------   
% Section 
\section{The basics}
\label{id2428750}\hypertarget{id2428750}{}%

The Sierra Creative Interpreter is a stack-based virtual machine ("P-Machine"). In addition to its roughly 125 basic opcodes, it provides a set of extended functions for displaying graphics, playing sound, receiving input, writing and reading data to and from the hard disk, and handling complex arithmetical and logical functions. In version 0.xxx of the interpreter, Sierra split the game data into nine different types of information: 

\begin{itemize}
\item \textit{script data}: SCI scripts and local data 
\item \textit{vocab data}: Parser data and debug information 
\item \textit{patch data}: Information pertaining to specific audio output devices 
\item \textit{sound data}: MIDI music tracks  
\item \textit{cursor data}: Mouse pointer shapes  
\item \textit{view data}: Sets of sets of image and hotspot information  
\item \textit{pic data}: Background images and metadata  
\item \textit{font data}: Bitmap fonts  
\item \textit{text data}: Plain text information  
\end{itemize}


Each game may contain up to 1000 different elements of each data type; these elements are referred to as "resources". The index numbers of the various resources need not be in sequence; they are usually assigned arbitrarily. \label{id2428814}\begingroup\catcode`\#=12\footnote{
With several notable exceptions, such as script 0 and most vocab resources.
}\endgroup\docbooktolatexmakefootnoteref{id2428814}

% ------------------------   
% Section 
\section{Resource storage}
\label{id2428822}\hypertarget{id2428822}{}%

Individual resources can be stored in one of two ways: Either in
resource files (which, surprisingly, are called something like
"resource.000" or "resource.001"), or in external patch files (not to
be confused with "patch" resources). The external files are called
something like "pic.100" or "script.000", and they take precedence
over data from resource files.

There is also a file called "resource.map", which contains a lookup
table for the individual resources, and another file, "resource.cfg",
which contains configuration information; neither of those is used by
FreeSCI.

Resource information stored in external patch files is not compressed
and therefore easily readable. It is, however, preceeded by two bytes:
The first byte contains the resource type ORed with 0x80, the purpose
of the second byte is unknown (but it appears to be ignored by the
original SCI version 0 engine).

As stated before, external patch files take precedence over resource
resource files. Applying those external files as patches is an option
since FreeSCI version 0.2.2.

The resource files, however, are more complicated. Each of them
contains a sequence of resources preceeded by a header; these
resources may be compressed. It is, also, quite common to find
resources shared by several resource files. The reason for this
appears to be that that, back when hard disks were rare and hard to
come by, the games had to be playable from floppy disks. To prevent
unneccessary disk-jockeying, common stuff was placed in several
resource files, each of which was then stored on one disk.


% ------------------------   
% Section 
\section{The individual resources: A summary}
\label{id2428872}\hypertarget{id2428872}{}%

The resource types of SCI0 can be roughly grouped into four sets: 
\begin{itemize}
%--- Item
\item 
Graphics (pic, view, font, cursor)


%--- Item
\item 
Sound (patch, sound)


%--- Item
\item 
Logic (script, vocab)


%--- Item
\item 
Text

\end{itemize}
\noindent  Text resources are nothing more than a series of ASCIIZ strings; but the other resources deserve further discussion.
\subsection{Graphical resources summarized}
\label{id2428906}\hypertarget{id2428906}{}%

The screen graphics are compromised of the four graphics resources. The background pictures are drawn using vector-oriented commands from at least one pic resource (several resources may be overlaid). The fact that vector graphics were used for SCI0 allows for several interesting picture quality improvements. Pic resources also include two additional "maps": The priority map, which marks parts of the pictures with a certain priority, so that other things with less priority can be fully or partially covered by them even if they are drawn at a later time, and the control map, which delimits the walking area and some special places used by the game logic. FreeSCI uses a fourth auxiliary map for during drawing time (this is a heritage from Carl Muckenhoupt's original code).

View resources contain most of the games' pixmaps (multi-color bitmaps). Each view contains a list of loops, and each loop contains a list of cels. The cels themselves contain the actual image information: RLE encoded pixmaps with transparency information, and relative offsets.

View resources are used for foreground images as well as for background images (for example, the "Spielburg" sign in QfG1 (EGA) is stored in a view resource and added to the background picture after it is drawn).

The cursor resource contains simple bitmaps for drawing the mouse pointer. It only allows for black, white, and transparent pixels in SCI0.

The fourth graphics resource is font data. It contains bitmapped fonts which are used to draw most of the text in the games. Text is used in one of four places: Text boxes, Text input fields, the title bar menu, and occasionally on-screen.
\subsection{Sound resources summarized}
\label{id2428960}\hypertarget{id2428960}{}%

SCI0 uses two types of resources for sound: Patch resources, and sound resources. Sound resources contain a rather simple header, and music data stored in a slightly modified version of the MIDI standard.

Patch resources contain device-dependant instrument mapping information for the instruments used in the sound resources. SCI0 sound resources do not adhere to the General Midi (GM) standard (which was, to my knowledge, written several years after the first SCI0 game was released), though later SCI versions may do so.
\subsection{Logic resources summarized}
\label{id2428982}\hypertarget{id2428982}{}%

Whenever the parser needs to look up a word, it looks for it in one of the vocab resources. This is not the sole purpose of the vocab resources, though; they provide information required by the debugger, including the help text for the debugger help menu and the names of the various SCI opcodes and kernel functions.

Script resources are the heart (or, rather, the brains) of the game. Consqeuently, they also are its most complex aspects, containing class and object information, local data, pointer relocation tables, and, of course, SCI bytecode.

To run the game, scripts are loaded on the SCI stack, their pointers are relocated appropriately, and their functions are executed by a virtual machine. They use a set of 0x7d opcodes, which may take either 8 or 16 bit parameters (so, effectively, there is twice the amount of commands). The functions may refer to global data, local temporary data, local function parameter data, or object data (selectors). They may, additionally, indirectly refer to "hunk" data, which is stored outside of the SCI heap. Since the whole design is object oriented, functions may re-use or overload the functions of their superclasses.

% ------------------------   
% Section 
\section{SCI01 extensions}
\label{id2429018}\hypertarget{id2429018}{}%

SCI01 differs only in very few respects: It uses different compression algorithms (all of which are supported since FreeSCI 0.2.1), and a different type of sound resources, which may contain digitized sound effects (PCM data). The basic music data, however, still resembles MIDI data.

Also, scripts are split into two parts when loaded: A dynamic part, which resides in the heap as before, and a static part, which is stored externally to conserve heap space. \label{id2429037}\begingroup\catcode`\#=12\footnote{
The background for this is that heap space started running out in Quest for Glory 2. In order to compensate for this, changes were made to both the script library and the interpreter.
}\endgroup\docbooktolatexmakefootnoteref{id2429037}

% ------------------------   
% Section 
\section{SCI1 extensions}
\label{id2429049}\hypertarget{id2429049}{}%

SCI1, which is not covered by FreeSCI at the moment, introduces new concepts like Palettes, scaled bitmap images and several new compression algorithms. In SCI1.0, the resource limit was first increased to 16383 \label{id2429061}\begingroup\catcode`\#=12\footnote{
This {\em{appears}} to be the limit- none of the SCI1.0 games I tested used resource numbers beyond 16383
}\endgroup\docbooktolatexmakefootnoteref{id2429061} , and then to 65535 in SCI1. Because of the inherent limitations of the FAT file system the primary target OS of Sierra's SCI interpreter was limited to, patch file names were altered accordingly, with the resource number (not padded) before the dot and a three-letter resource ID behind it; examples are "0.scr" or "100.v56".

The complete list of suffixes is as follows: 

\begin{tabular}{l}
80: v56: 256 color views  \\
81: p56: 256 color background pictures  \\
82: scr: Scripts (static data)  \\
83: tex: Texts (apparently deprecated in favor of messages)  \\
84: snd: Sound data (MIDI music)  \\
86\label{id2429108}\begingroup\catcode`\#=12\footnote{
Type 0x85 resources are 'memory' resources, which are only used internally.
}\endgroup\docbooktolatexmakefootnoteref{id2429108} :voc: Vocabulary (not used)  \\
87: fon: Fonts  \\
88: cur: Mouse cursors (deprecated in favor of v56-based cursors)  \\
89: pat: Audio patch files  \\
8a: bit: Bitmap files (purpose unknown)  \\
8b: pal: 256 color palette files  \\
8c: cda: CD Audio resources  \\
8d: aud: Audio resources (probably sound effects)  \\
8e: syn: Sync (purpose unknown)  \\
8f: msg: Message resources: Text plus metadata  \\
90: map: Map (purpose unknown)  \\
91: hep: Heap resources: Dynamic script data  \\
\end{tabular}

 Apparently, the script resource split introduced in SCI01 was incorporated into the actual resource layout in SCI1.

% ------------------------   
% Section 
\section{Sierra SCI games}
\label{id2429164}\hypertarget{id2429164}{}%

Paul David Doherty, Vladimir Gneushev

The listing here is almost certainly incomplete. Thanks to the information provided by Vladimir, game information now includes some features of certain versions the interpreter shipped with, they are listed below:

% tabular ------------------------------------------------------
\begin{center}
\label{id2429192}\hypertarget{id2429192}{}%

\begin{tabular}{|c|c|}
\hline 
{{Symbol}} & {{Meaning}} \tabularnewline
 \hline 
{{{\em{Rn}}}} & {{Resource patches identified by name (script.256)}} \tabularnewline
 \hline 
{{{\em{Re}}}} & {{Resource patches identified by extension (256.scr)}} \tabularnewline
 \hline 
{{{\em{Dd}}}} & {{Built-in debugger}} \tabularnewline
 \hline 
{{{\em{D*}}}} & {{Interpreter binary shipped with debug symbols}} \tabularnewline
 \hline 
{{{\em{Ss}}}} & {{Scripts consist of script resources only}} \tabularnewline
 \hline 
{{{\em{Sh}}}} & {{Scripts use heap and script resources}} \tabularnewline
 \hline 
{{{\em{Sc}}}} & {{Scripts use 'csc' resources}} \tabularnewline
\hline 
\end{tabular}
\end{center}

\subsection{SCI0}
\label{id2429641}\hypertarget{id2429641}{}%

% tabular ------------------------------------------------------
\begin{center}
\label{id2429623}\hypertarget{id2429623}{}%

\begin{longtable}{|c|c|c|c|c|c|}
\hline 
{{Game name}} & {{ID}} & {{interpreter version}} & {{Parser}} & {{Map file ver.}} & {{More}} \tabularnewline
 \hline 
{{Season's Greetings (1988)}} & {{DEMO}} & {{0.000.294}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Leisure Suit Larry 2}} & {{LSL2}} & {{0.000.343}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Police Quest 2}} & {{PQ2}} & {{0.000.395}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Leisure Suit Larry 2}} & {{LSL2}} & {{0.000.409}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Space Quest 3}} & {{SQ3}} & {{0.000.453}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Police Quest 2}} & {{PQ2}} & {{0.000.490}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{King's Quest 4}} & {{KQ4}} & {{0.000.502}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Fun Seeker's Guide}} & {{emc}} & {{0.000.506}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Hoyle's Book of Games 1}} & {{cardGames}} & {{0.000.530}} & {{?}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Hero's Quest 1}} & {{HQ}} & {{0.000.566}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Leisure Suit Larry 3}} & {{LSL3}} & {{0.000.572}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Hoyle's Book of Games 2}} & {{solitare}} & {{0.000.572}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Quest for Glory 1}} & {{Glory}} & {{0.000.629}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{The Colonel's Bequest}} & {{CB1}} & {{0.000.631}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Codename: Iceman}} & {{iceMan}} & {{0.000.668}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Hoyle's Book of Games 1}} & {{cardGames}} & {{0.000.685}} & {{?}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Conquest of Camelot}} & {{ARTHUR}} & {{0.000.685}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Codename: Iceman}} & {{iceMan}} & {{0.000.685}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Space Quest 3}} & {{SQ3}} & {{0.000.685}} & {{yes}} & {{0}} & {{Re Dd Ss}} \tabularnewline
\hline 
\end{longtable}
\end{center}

\subsection{SCI01}
\label{id2489560}\hypertarget{id2489560}{}%

% tabular ------------------------------------------------------
\begin{center}
\label{id2489564}\hypertarget{id2489564}{}%

\begin{tabular}{|c|c|c|c|c|c|}
\hline 
{{Game name}} & {{ID}} & {{interpreter version}} & {{Parser}} & {{Map file ver.}} & {{More}} \tabularnewline
 \hline 
{{King's Quest I}} & {{KQ1}} & {{S.old.010}} & {{yes}} & {{?}} & {{Dd Ss}} \tabularnewline
 \hline 
{{Quest for Glory 2}} & {{Trial}} & {{1.000.072}} & {{yes}} & {{0}} & {{Re Ss}} \tabularnewline
 \hline 
{{[Christmas greeting card 1990]}} & {{?}} & {{1.000.172}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{[Christmas greeting card 1990]}} & {{?}} & {{1.000.174}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Space Quest 3 german}} & {{SQ3}} & {{?}} & {{bilingual}} & {{0}} & {{Re Dd Ss}} \tabularnewline
\hline 
\end{tabular}
\end{center}

\subsection{SCI1}
\label{id2489678}\hypertarget{id2489678}{}%

% tabular ------------------------------------------------------
\begin{center}
\label{id2489682}\hypertarget{id2489682}{}%

\begin{tabular}{|c|c|c|c|c|c|}
\hline 
{{Game name}} & {{ID}} & {{interpreter version}} & {{Parser}} & {{Map file ver.}} & {{More}} \tabularnewline
 \hline 
{{King's Quest 5}} & {{?}} & {{1.000.060}} & {{no}} & {{0}} & {{Re Ss}} \tabularnewline
 \hline 
{{Leisure suit Larry 1 demo}} & {{?}} & {{1.000.084}} & {{no}} & {{0}} & {{Rn Ss}} \tabularnewline
 \hline 
{{Conquest of the long bow}} & {{?}} & {{1.000.168}} & {{no}} & {{1}} & {{Rn Ss}} \tabularnewline
 \hline 
{{Space Quest 1 demo}} & {{?}} & {{1.000.181}} & {{no}} & {{0}} & {{Rn Ss}} \tabularnewline
 \hline 
{{Leisure Suit Larry 1 (VGA)}} & {{?}} & {{1.000.577}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{King's Quest 5}} & {{?}} & {{1.000.784}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Space Quest 4}} & {{?}} & {{1.000.753}} & {{no}} & {{0}} & {{Re Ss}} \tabularnewline
\hline 
\end{tabular}
\end{center}

\subsection{SCI1-T.A series}
\label{id2489827}\hypertarget{id2489827}{}%

% tabular ------------------------------------------------------
\begin{center}
\label{id2489832}\hypertarget{id2489832}{}%

\begin{tabular}{|c|c|c|c|c|c|}
\hline 
{{Game name}} & {{ID}} & {{interpreter version}} & {{Parser}} & {{Map file ver.}} & {{More}} \tabularnewline
 \hline 
{{Police Quest 3 demo}} & {{?}} & {{T.A00.052}} & {{no}} & {{1}} & {{Rn Ss}} \tabularnewline
 \hline 
{{Space Quest 1 (VGA)}} & {{?}} & {{T.A00.081}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Leisure suit Larry 5}} & {{?}} & {{T.A00.169}} & {{no}} & {{1}} & {{Rn Ss}} \tabularnewline
 \hline 
{{Police Quest 3}} & {{?}} & {{T.A00.178}} & {{?}} & {{?}} & {{}} \tabularnewline
\hline 
\end{tabular}
\end{center}

\subsection{SCI1 suspected forks}
\label{id2489928}\hypertarget{id2489928}{}%

% tabular ------------------------------------------------------
\begin{center}
\label{id2489933}\hypertarget{id2489933}{}%

\begin{tabular}{|c|c|c|c|c|c|}
\hline 
{{Game name}} & {{ID}} & {{interpreter version}} & {{Parser}} & {{Map file ver.}} & {{More}} \tabularnewline
 \hline 
{{Jones in the Fast Lane}} & {{?}} & {{x.yyy.zzz}} & {{no}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Mixed-up mother goose demo win}} & {{?}} & {{x.yyy.zzz}} & {{no}} & {{0}} & {{Re Dd Ss}} \tabularnewline
 \hline 
{{Eco Quest 1}} & {{?}} & {{1.ECO.013}} & {{no}} & {{1}} & {{Rn Ss}} \tabularnewline
 \hline 
{{Mixed-up fairy tales demo}} & {{?}} & {{?????????}} & {{no}} & {{1}} & {{Rn Ss}} \tabularnewline
\hline 
\end{tabular}
\end{center}

\subsection{SCI1.1}
\label{id2490032}\hypertarget{id2490032}{}%

% tabular ------------------------------------------------------
\begin{center}
\label{id2490037}\hypertarget{id2490037}{}%

\begin{longtable}{|c|c|c|c|c|c|}
\hline 
{{Game name}} & {{ID}} & {{interpreter version}} & {{Parser}} & {{Map file ver.}} & {{More}} \tabularnewline
 \hline 
{{Eco Quest 1 demo}} & {{?}} & {{x.yyy.zzz}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Laura Bow 2 demo}} & {{?}} & {{x.yyy.zzz}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Hoyle's Book of Games 3}} & {{?}} & {{x.yyy.zzz}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Quest for Glory 3 demo}} & {{?}} & {{1.001.021}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{LSL: Crazy Nick's Budget Picks}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Robin Hood's Games of Skill and Chance}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Parlor Games with Laura Bow}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{King Graham's Board Game Challenge}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Leisure Suit Larry's Casino}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Roger Wilco's Spaced Out Game Pack}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Police Quest 1}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Quest for Glory 1 demo}} & {{?}} & {{1.001.029}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Quest for Glory 3}} & {{?}} & {{1.001.050}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Island of Dr. Brain 1}} & {{?}} & {{1.001.053}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Island of Dr. Brain 2}} & {{?}} & {{1.001.053}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Island of Dr. Brain 2 demo}} & {{?}} & {{1.001.053}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{King's Quest 6}} & {{?}} & {{1.001.054}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{King's Quest 6 demo}} & {{?}} & {{1.001.055}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Eco Quest 2 demo}} & {{?}} & {{1.001.055}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{[Christmas greeting card 1992]}} & {{?}} & {{1.001.055}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Space Quest 4 windows}} & {{?}} & {{1.001.064}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Eco Quest 2}} & {{?}} & {{1.001.065}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Space Quest 5}} & {{?}} & {{1.001.068}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Space Quest 5 french}} & {{?}} & {{1.001.068}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Space Quest 5 german}} & {{?}} & {{1.001.068}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Freddy Pharkas demo}} & {{?}} & {{1.001.069}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Leisure suit Larry 6 dos+win}} & {{?}} & {{1.001.069}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{Twisty history demo dos+win}} & {{?}} & {{1.001.069}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Twisty history demo dos+win}} & {{?}} & {{1.001.070}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Pepper's adventures in time}} & {{?}} & {{1.001.072}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Laura Bow 2}} & {{?}} & {{1.001.072}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Freddy Pharkas}} & {{?}} & {{1.cfs.081}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Gabriel Knight 1 demo}} & {{?}} & {{1.001.092}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Freddy Pharkas demo win}} & {{?}} & {{1.001.095}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Leisure suit Larry 6 dos+win}} & {{?}} & {{1.001.113}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
 \hline 
{{King's Quest 6}} & {{?}} & {{1.cfs.158}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Laura Bow 2}} & {{?}} & {{2.000.274}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Quest for Glory 1 vga}} & {{?}} & {{L.rry.021}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Quest for Glory 3 german}} & {{?}} & {{L.rry.083}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Quest for Glory 1 vga}} & {{?}} & {{2.000.411}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Quest for Glory 4 demo}} & {{?}} & {{No number}} & {{no}} & {{1}} & {{Rn D* Sh}} \tabularnewline
\hline 
\end{longtable}
\end{center}

\subsection{SCI32}
\label{id2490718}\hypertarget{id2490718}{}%

% tabular ------------------------------------------------------
\begin{center}
\label{id2490723}\hypertarget{id2490723}{}%

\begin{longtable}{|c|c|c|c|c|c|}
\hline 
{{Game name}} & {{ID}} & {{interpreter version}} & {{Parser}} & {{Map file ver.}} & {{More}} \tabularnewline
 \hline 
{{Police Quest 4 floppy dos+win}} & {{?}} & {{?}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{LightHouse}} & {{?}} & {{?}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{LightHouse demo w9x (another)}} & {{?}} & {{?}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Space Quest 6}} & {{?}} & {{?}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Quest for Glory 4 floppy}} & {{?}} & {{2.000.000}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Quest for Glory 4 demo (another)}} & {{?}} & {{2.000.000}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Gabriel Knight 1}} & {{?}} & {{2.000.000}} & {{no}} & {{1}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Torin's passage dos+win}} & {{?}} & {{2.100.002}} & {{no}} & {{3}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Gabriel Knight 2 dos+win}} & {{?}} & {{2.100.002}} & {{no}} & {{3}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Police Quest: SWAT demo win}} & {{?}} & {{2.100.002}} & {{no}} & {{3}} & {{Rn Sh}} \tabularnewline
 \hline 
{{King's Quest 7 win+w9x}} & {{?}} & {{2.100.002}} & {{no}} & {{3}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Phantasmagoria}} & {{?}} & {{2.100.002}} & {{?}} & {{?}} & {{}} \tabularnewline
 \hline 
{{Quest for Glory 4 cd dos+win}} & {{?}} & {{2.100.002}} & {{no}} & {{3}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Shivers win}} & {{?}} & {{2.100.002}} & {{no}} & {{3}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Shivers demo win}} & {{?}} & {{2.100.002}} & {{no}} & {{3}} & {{Rn Sh}} \tabularnewline
 \hline 
{{Phantasmagoria 2 w9x}} & {{?}} & {{3.000.000}} & {{no}} & {{3}} & {{Rn Sc}} \tabularnewline
 \hline 
{{Leisure suit Larry 7 dos+w9x}} & {{?}} & {{3.000.000}} & {{no}} & {{3}} & {{Rn Sc}} \tabularnewline
 \hline 
{{LightHouse demo w9x}} & {{?}} & {{3.000.000}} & {{no}} & {{3}} & {{Rn Sc}} \tabularnewline
 \hline 
{{RAMA}} & {{?}} & {{3.000.000}} & {{no}} & {{3}} & {{Rn Sc}} \tabularnewline
 \hline 
{{Shivers 2}} & {{?}} & {{3.000.000}} & {{no}} & {{3}} & {{Rn Sc}} \tabularnewline
\hline 
\end{longtable}
\end{center}


% -------------------------------------------------------------
% Chapter Resource files 
% -------------------------------------------------------------         
\chapter{Resource files}
\label{id2492091}\hypertarget{id2492091}{}%

with significant contributions from Petr Vyhnak and Vladimir Gneushev

In order to allow games to be both distributeable and playable from
several floppy disks, SCI was designed to support multi-volume
data. The data itself could therefore be spread into separate files,
with some of the more common resources present in more than one of
them. The global index for these files was a "resource.map" file,
which was read during startup and present on the same disk as the
interpreter itself. This file contained a linear lookup table that
mapped resource type/number tuples to a set of resource number/ offset
tuples, which they could subsequently be read from.

% ------------------------   
% Section 
\section{SCI0 resources}
\label{id2429329}\hypertarget{id2429329}{}%
\subsection{resource.map}
\label{id2492132}\hypertarget{id2492132}{}%

The SCI0 map file format is pretty simple: It consists of 6-byte
entries, terminated by a six-tuple of 0xff values. The first 2
bytes, interpreted as little endian 16 bit integer, encode resource
type (high 5 bits) and number (low 11 bits). The next 4 bytes are a 32
bit LE integer that contains the resource file number in the high 6
bits, and the absolute offset within the file in the low 26 bits. SCI0
performs a linear search to find the resource; however, multiple
entries may match the search, since resources may be present more than
once (the inverse mapping is not injective).

Early SCI01 (namely certain VGA games not using the later SCI1
resource.map format) uses a slight variation on this, which is almost
identical: The first two bytes are unchanged, but the latter four only
use the most significant 4 bits for storing the file number, and
(consequently) 28 bits for the file offset.

\subsection{resource.\textless{}nr\textgreater{}}
\label{id2492153}\hypertarget{id2492153}{}%

SCI0 resource entries start with a four-tuple of little endian 16 bit
words, which we will call ({\texttt{{id}}},
{\texttt{{comp\_\dbz{}size}}}, {\texttt{{decomp\_\dbz{}size}}},
{\texttt{{method}}}). {\texttt{{id}}} has the usual SCI0 semantics
(high 5 are the resource type, low 11 are its
number). {\texttt{{comp\_\dbz{}size}}} and
{\texttt{{decomp\_\dbz{}size}}} are the size of the compressed and the
decompressed resource, respectively. The compressed size actually
starts counting at the record position of
{\texttt{{decomp\_\dbz{}size}}}, so it counts four bytes in addition
to the actual content. {\texttt{{method}}}, finally, is the
compression method used to store the data.

% ------------------------   
% Section 
\section{SCI1 resources}
\label{id2492224}\hypertarget{id2492224}{}%
\subsection{resource.map}
\label{id2492230}\hypertarget{id2492230}{}%

The SCI1 resource.map starts with an array of 3-byte structures where
the 1st byte is the resource type (0x80 ... 0x91) and next 2 bytes
(interpreted as little-endian 16 bit integer) represent the absolute
offset of the resource's lookup table (within resource.map). This
first array is terminated by a 3-byte entry with has 0xFF as a type
and the offset pointing to the first byte after the last resource
type's lookup table. SCI1 first goes through this list to find the
start of list for the correct resource type and remember this offset
and the offset from the next entry to know where it ends. The
resulting interval contains a sorted list of 6-byte structures, where
the first LE 16 bit integer is the resource number, and the next LE 32
bit integer contains the resource file number in its high 4 bits and
the absolute resource offset (in the indicated resource file) in its
low 28 bits. Because the list is sorted and its length is known,
Sierra SCI can use binary search to locate the resource ID it is
looking for.
\subsection{resource.\textless{}nr\textgreater{}}
\label{id2492257}\hypertarget{id2492257}{}%

Later versions of SCI1 changed the resource file structure slightly:
The resource header now contains a byte describing the resource's
type, and a four-tuple ({\texttt{{res\_\dbz{}nr}}},
{\texttt{{comp\_\dbz{}size}}}, {\texttt{{decomp\_\dbz{}size}}},
{\texttt{{method}}}), where {\texttt{{comp\_\dbz{}size}}},
{\texttt{{decomp\_\dbz{}size}}}, and {\texttt{{method}}} have the same
meanings as before (with the exception of {\texttt{{method}}}
referring to different algorithms), while res\_nr is simply the
resource's number.

Rumor has it that late versions of SCI1 also stored the offsets
shifted to the right by two bits (thus, all resources are always
stored at word-aligned offsets in these games).

% ------------------------   
% Section 
\section{Decompression algorithms}
\label{id2492320}\hypertarget{id2492320}{}%

The decompression algorithms used in SCI are as follows: 
% table ------------------------------------------------------
\begin{table}[htb]
\begin{center}%
\hypertarget{id2492330}{}%
\captionswapskip{}{{\caption{SCI0 compression algorithms}\label{id2492330}}}

\captionswapskip{}\begin{tabular}{|c|c|}
\hline 
{{method}} & {{algorithm}} \tabularnewline
 \hline 
{{0}} & {{uncompressed}} \tabularnewline
 \hline 
{{1}} & {{LZW}} \tabularnewline
 \hline 
{{2}} & {{HUFFMAN}} \tabularnewline
\hline 
\end{tabular}
\end{center}
\end{table}

 
% table ------------------------------------------------------
\begin{table}[htb]
\begin{center}%
\hypertarget{id2492390}{}%
\captionswapskip{}{{\caption{SCI01 compression algorithms}\label{id2492390}}}

\captionswapskip{}\begin{tabular}{|c|c|}
\hline 
{{method}} & {{algorithm}} \tabularnewline
 \hline 
{{0}} & {{uncompressed}} \tabularnewline
 \hline 
{{1}} & {{LZW}} \tabularnewline
 \hline 
{{2}} & {{COMP3}} \tabularnewline
 \hline 
{{3}} & {{HUFFMAN}} \tabularnewline
\hline 
\end{tabular}
\end{center}
\end{table}

 
% table ------------------------------------------------------
\begin{table}[htb]
\begin{center}%
\hypertarget{id2492460}{}%
\captionswapskip{}{{\caption{SCI1.0 compression algorithms}\label{id2492460}}}

\captionswapskip{}\begin{tabular}{|c|c|}
\hline 
{{method}} & {{algorithm}} \tabularnewline
 \hline 
{{0}} & {{uncompressed}} \tabularnewline
 \hline 
{{1}} & {{LZW}} \tabularnewline
 \hline 
{{2}} & {{COMP3}} \tabularnewline
 \hline 
{{3}} & {{UNKNOWN-0}} \tabularnewline
 \hline 
{{4}} & {{UNKNOWN-1}} \tabularnewline
\hline 
\end{tabular}
\end{center}
\end{table}

 
% table ------------------------------------------------------
\begin{table}[htb]
\begin{center}%
\hypertarget{id2492540}{}%
\captionswapskip{}{{\caption{SCI1.1 compression algorithms}\label{id2492540}}}

\captionswapskip{}\begin{tabular}{|c|c|}
\hline 
{{method}} & {{algorithm}} \tabularnewline
 \hline 
{{0}} & {{uncompressed}} \tabularnewline
 \hline 
{{18}} & {{DCL-EXPLODE}} \tabularnewline
 \hline 
{{19}} & {{DCL-EXPLODE}} \tabularnewline
 \hline 
{{20}} & {{DCL-EXPLODE}} \tabularnewline
\hline 
\end{tabular}
\end{center}
\end{table}

 As reported by Vladimir Gneushev, SCI32 uses STACpack (as described in RFC 1974) explicitly, determining whether there is a need for compression by comparing the size of the compressed data block with that of the uncompressed.
\subsection{Decompression algorithm LZW}
\label{id2492615}\hypertarget{id2492615}{}%

The LZW algorithm itself, when used for compression or decompression in an apparatus (sic) designed for compression and decompression, has been patented by Unisys in Japan, Europe, and the United States. Fortunately, FreeSCI only needs LZW decompression, which means that it does not match the description of the apparatus as given above. (Further, patents on software are (at the time of this writing) not enforceable in Europe, where the FreeSCI implementation of the LZW decompressor was written).

 WriteMe.
\subsection{Decompression algorithm HUFFMAN}
\label{decomp-huffman}\hypertarget{decomp-huffman}{}%

This is an implementation of a simple huffman token decoder, which looks up tokens in a huffman tree. A {\em{huffman tree}} is a hollow binary search tree. This means that all inner nodes, usually including the root, are empty, and have two siblings. The tree's leaves contain the actual information. 
\begin{Verbatim}[]

FUNCTION get_next_bit(): Boolean;
/* This function reads the next bit from the input stream. Reading starts at the MSB. */


FUNCTION get_next_byte(): Byte
VAR
    i: Integer;
    literal: Byte;
BEGIN
    literal := 0;
    FOR i := 0 to 7 DO
        literal := (literal << 1) | get_next_bit();
    OD
    RETURN literal;
END


FUNCTION get_next_char(nodelist : Array of Nodes, index : Integer): (Char, Boolean)
VAR
    left, right: Integer;
    literal : Char;
    node : Node;
BEGIN
    Node := nodelist[index];

    IF node.siblings == 0 THEN
        RETURN (node.value, False);
    ELSE BEGIN
       left := (node.siblings & 0xf0) >> 4;
       right := (node.siblings & 0x0f);

       IF get_next_bit() THEN BEGIN
           IF right == 0 THEN /* Literal token */
               literal := ByteToChar(get_next_byte());

               RETURN (literal, True);
           ELSE
               RETURN get_next_char(nodelist, index + right)
        END ELSE
                RETURN get_next_char(nodelist, index + left)
    END
END
        
\end{Verbatim}
 The function get\_next\_char() is executed until its second return value is True (i.e. if a value was read directly from the input stream) while the first return value equals a certain terminator character, which is the first byte stored in the compressed resource: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2492804}\hypertarget{id2492804}{}%

\begin{tabular}{c|c|c}
{{Offset}} & {{Name}} & {{Meaning}} \tabularnewline
 \hline 
{{0}} & {{terminator}} & {{Terminator character}} \tabularnewline
 \hline 
{{1}} & {{nodes}} & {{Number of nodes}} \tabularnewline
 \hline 
{{2 + i*2}} & {{nodelist[i].value}} & {{Value of node \#i (0 $\leq$; i $\leq$ nodes)}} \tabularnewline
 \hline 
{{3 + i*2}} & {{nodelist[i].siblings}} & {{Sibling nodes of node \#i}} \tabularnewline
 \hline 
{{2 + nodes*2}} & {{data[]}} & {{The actual compressed data}} \tabularnewline
\end{tabular}
\end{center}

 where nodelist[0] is the root node.
\subsection{Decompression algorithm COMP3}
\label{id2492909}\hypertarget{id2492909}{}%

 WriteMe.
\subsection{Decompression algorithm DCL-EXPLODE}
\label{id2492926}\hypertarget{id2492926}{}%

originally by Petr Vyhnak


This algorithm matches one or more of the UNKNOWN algorithms.


This algorithm is based on the Deflate algorithm described in the Internet RFC 1951 (see also RFC 1950 for related material).

The algorithm is quite similar to the explode algorithm (ZIP method \#6 - implode ) but there are differences. 
\begin{Verbatim}[]

        /* The first 2 bytes are parameters */

P1 = ReadByte(); /* 0 or 1 */
        /* I think this means 0=binary and 1=ascii file, but in RESOURCEs I saw always 0 */

P2 = ReadByte();
        /* must be 4,5 or 6 and it is a parameter for the decompression algorithm */


/* Now, a bit stream follows, which is decoded as described below: */


LOOP:
     read 1 bit (take bits from the lowest value (LSB) to the MSB i.e. bit 0, bit 1 etc ...)
         - if the bit is 0 read 8 bits and write it to the output as it is.
         - if the bit is 1 we have here a length/distance pair:
                 - decode a number with Hufmman Tree #1; variable bit length, result is 0x00 .. 0x0F -> L1
                   if L1 <= 7:
                         LENGTH = L1 + 2
                   if L1 > 7
                         read more (L1-7) bits -> L2
                         LENGTH = L2 + M[L1-7] + 2

                 - decode another number with Hufmann Tree #2 giving result 0x00..0x3F -> D1
                   if LENGTH == 2
                         D1 = D1 << 2
                         read 2 bits -> D2
                   else
                         D1 = D1 << P2  // the parameter 2
                         read P2 bits -> D2

                   DISTANCE = (D1 | D2) + 1

                 - now copy LENGTH bytes from (output_ptr-DISTANCE) to output_ptr
END LOOP

        
\end{Verbatim}
 The algorithm terminates as soon as it runs out of bits. The data structures used are as follows:
\subsubsection{M}
\label{id2493014}\hypertarget{id2493014}{}%

M is a constant array defined as M[0] = 7, M[n+1] = M[n]+ 2\textasciicircum{}n. That means M[1] = 8, M[2] = 0x0A, M[3] = 0x0E, M[4] = 0x16, M[5] = 0x26, etc.
\subsubsection{Huffman Tree \#1}
\label{id2493027}\hypertarget{id2493027}{}%

The first huffman tree (\hyperlink{decomp-huffman}{Section~{\ref{decomp-huffman}}}) contains the length values. It is described by the following table: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2493042}\hypertarget{id2493042}{}%

\begin{tabular}{|c|l|}
\hline 
{{value (hex)}} & {{code (binary)}} \tabularnewline
 \hline 
{{0}} & {{101}} \tabularnewline
 \hline 
{{1}} & {{11}} \tabularnewline
 \hline 
{{2}} & {{100}} \tabularnewline
 \hline 
{{3}} & {{011}} \tabularnewline
 \hline 
{{4}} & {{0101}} \tabularnewline
 \hline 
{{5}} & {{0100}} \tabularnewline
 \hline 
{{6}} & {{0011}} \tabularnewline
 \hline 
{{7}} & {{0010 1}} \tabularnewline
 \hline 
{{8}} & {{0010 0}} \tabularnewline
 \hline 
{{9}} & {{0001 1}} \tabularnewline
 \hline 
{{a}} & {{0001 0}} \tabularnewline
 \hline 
{{b}} & {{0000 11}} \tabularnewline
 \hline 
{{c}} & {{0000 10}} \tabularnewline
 \hline 
{{d}} & {{0000 01}} \tabularnewline
 \hline 
{{e}} & {{0000 001}} \tabularnewline
 \hline 
{{f}} & {{0000 000}} \tabularnewline
\hline 
\end{tabular}
\end{center}

 where bits should be read from the left to the right.
\subsubsection{Huffman Tree \#2}
\label{id2493334}\hypertarget{id2493334}{}%

The second huffman code tree contains the distance values. It can be built from the following table: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2493343}\hypertarget{id2493343}{}%

\begin{longtable}{|c|l|}
\hline 
{{value (hex)}} & {{code (binary)}} \tabularnewline
 \hline 
{{00}} & {{11}} \tabularnewline
 \hline 
{{01}} & {{1011}} \tabularnewline
 \hline 
{{02}} & {{1010}} \tabularnewline
 \hline 
{{03}} & {{1001 1}} \tabularnewline
 \hline 
{{04}} & {{1001 0}} \tabularnewline
 \hline 
{{05}} & {{1000 1}} \tabularnewline
 \hline 
{{06}} & {{1000 0}} \tabularnewline
 \hline 
{{07}} & {{0111 11}} \tabularnewline
 \hline 
{{08}} & {{0111 10}} \tabularnewline
 \hline 
{{09}} & {{0111 01}} \tabularnewline
 \hline 
{{0a}} & {{0111 00}} \tabularnewline
 \hline 
{{0b}} & {{0110 11}} \tabularnewline
 \hline 
{{0c}} & {{0110 10}} \tabularnewline
 \hline 
{{0d}} & {{0110 01}} \tabularnewline
 \hline 
{{0e}} & {{0110 00}} \tabularnewline
 \hline 
{{0f}} & {{0101 11}} \tabularnewline
 \hline 
{{10}} & {{0101 10}} \tabularnewline
 \hline 
{{11}} & {{0101 01}} \tabularnewline
 \hline 
{{12}} & {{0101 00}} \tabularnewline
 \hline 
{{13}} & {{0100 11}} \tabularnewline
 \hline 
{{14}} & {{0100 10}} \tabularnewline
 \hline 
{{15}} & {{0100 01}} \tabularnewline
 \hline 
{{16}} & {{0100 001}} \tabularnewline
 \hline 
{{17}} & {{0100 000}} \tabularnewline
 \hline 
{{18}} & {{0011 111}} \tabularnewline
 \hline 
{{19}} & {{0011 110}} \tabularnewline
 \hline 
{{1a}} & {{0011 101}} \tabularnewline
 \hline 
{{1b}} & {{0011 100}} \tabularnewline
 \hline 
{{1c}} & {{0011 011}} \tabularnewline
 \hline 
{{1d}} & {{0011 010}} \tabularnewline
 \hline 
{{1e}} & {{0011 001}} \tabularnewline
 \hline 
{{1f}} & {{0011 000}} \tabularnewline
 \hline 
{{20}} & {{0010 111}} \tabularnewline
 \hline 
{{21}} & {{0010 110}} \tabularnewline
 \hline 
{{22}} & {{0010 101}} \tabularnewline
 \hline 
{{23}} & {{0010 100}} \tabularnewline
 \hline 
{{24}} & {{0010 011}} \tabularnewline
 \hline 
{{25}} & {{0010 010}} \tabularnewline
 \hline 
{{26}} & {{0010 001}} \tabularnewline
 \hline 
{{27}} & {{0010 000}} \tabularnewline
 \hline 
{{28}} & {{0001 111}} \tabularnewline
 \hline 
{{29}} & {{0001 110}} \tabularnewline
 \hline 
{{2a}} & {{0001 101}} \tabularnewline
 \hline 
{{2b}} & {{0001 100}} \tabularnewline
 \hline 
{{2c}} & {{0001 011}} \tabularnewline
 \hline 
{{2d}} & {{0001 010}} \tabularnewline
 \hline 
{{2e}} & {{0001 001}} \tabularnewline
 \hline 
{{2f}} & {{0001 000}} \tabularnewline
 \hline 
{{30}} & {{0000 1111}} \tabularnewline
 \hline 
{{31}} & {{0000 1110}} \tabularnewline
 \hline 
{{32}} & {{0000 1101}} \tabularnewline
 \hline 
{{33}} & {{0000 1100}} \tabularnewline
 \hline 
{{34}} & {{0000 1011}} \tabularnewline
 \hline 
{{35}} & {{0000 1010}} \tabularnewline
 \hline 
{{36}} & {{0000 1001}} \tabularnewline
 \hline 
{{37}} & {{0000 1000}} \tabularnewline
 \hline 
{{38}} & {{0000 0111}} \tabularnewline
 \hline 
{{39}} & {{0000 0110}} \tabularnewline
 \hline 
{{3a}} & {{0000 0101}} \tabularnewline
 \hline 
{{3b}} & {{0000 0100}} \tabularnewline
 \hline 
{{3c}} & {{0000 0011}} \tabularnewline
 \hline 
{{3d}} & {{0000 0010}} \tabularnewline
 \hline 
{{3e}} & {{0000 0001}} \tabularnewline
 \hline 
{{3f}} & {{0000 0000}} \tabularnewline
\hline 
\end{longtable}
\end{center}

 where bits should be read from the left to the right.
\subsubsection{Huffman Tree \#3}
\label{id2494003}\hypertarget{id2494003}{}%

This tree describes literal values for ASCII mode, which adds another compression step to the algorithm. 
% tabular ------------------------------------------------------
\begin{center}
\label{id2494013}\hypertarget{id2494013}{}%

\begin{longtable}{|c|p{3cm}|}
\hline 
{{value (hex)}} & {{code (binary)}} \tabularnewline
 \hline 
{{00}} & {{0000 1001 001}} \tabularnewline
 \hline 
{{01}} & {{0000 0111 1111}} \tabularnewline
 \hline 
{{02}} & {{0000 0111 1110}} \tabularnewline
 \hline 
{{03}} & {{0000 0111 1101}} \tabularnewline
 \hline 
{{04}} & {{0000 0111 1100}} \tabularnewline
 \hline 
{{05}} & {{0000 0111 1011}} \tabularnewline
 \hline 
{{06}} & {{0000 0111 1010}} \tabularnewline
 \hline 
{{07}} & {{0000 0111 1001}} \tabularnewline
 \hline 
{{08}} & {{0000 0111 1000}} \tabularnewline
 \hline 
{{09}} & {{0001 1101}} \tabularnewline
 \hline 
{{0a}} & {{0100 011}} \tabularnewline
 \hline 
{{0b}} & {{0000 0111 0111}} \tabularnewline
 \hline 
{{0c}} & {{0000 0111 0110}} \tabularnewline
 \hline 
{{0d}} & {{0100 010}} \tabularnewline
 \hline 
{{0e}} & {{0000 0111 0101}} \tabularnewline
 \hline 
{{0f}} & {{0000 0111 0100}} \tabularnewline
 \hline 
{{10}} & {{0000 0111 0011}} \tabularnewline
 \hline 
{{11}} & {{0000 0111 0010}} \tabularnewline
 \hline 
{{12}} & {{0000 0111 0001}} \tabularnewline
 \hline 
{{13}} & {{0000 0111 0000}} \tabularnewline
 \hline 
{{14}} & {{0000 0110 1111}} \tabularnewline
 \hline 
{{15}} & {{0000 0110 1110}} \tabularnewline
 \hline 
{{16}} & {{0000 0110 1101}} \tabularnewline
 \hline 
{{17}} & {{0000 0110 1100}} \tabularnewline
 \hline 
{{18}} & {{0000 0110 1011}} \tabularnewline
 \hline 
{{19}} & {{0000 0110 1010}} \tabularnewline
 \hline 
{{1a}} & {{0000 0010 0100 1}} \tabularnewline
 \hline 
{{1b}} & {{0000 0110 1001}} \tabularnewline
 \hline 
{{1c}} & {{0000 0110 1000}} \tabularnewline
 \hline 
{{1d}} & {{0000 0110 0111}} \tabularnewline
 \hline 
{{1e}} & {{0000 0110 0110}} \tabularnewline
 \hline 
{{1f}} & {{0000 0110 0101}} \tabularnewline
 \hline 
{{20}} & {{1111}} \tabularnewline
 \hline 
{{21}} & {{0000 1010 01}} \tabularnewline
 \hline 
{{22}} & {{0001 1100}} \tabularnewline
 \hline 
{{23}} & {{0000 0110 0100}} \tabularnewline
 \hline 
{{24}} & {{0000 1010 00}} \tabularnewline
 \hline 
{{25}} & {{0000 0110 0011}} \tabularnewline
 \hline 
{{26}} & {{0000 1001 11}} \tabularnewline
 \hline 
{{27}} & {{0001 1011}} \tabularnewline
 \hline 
{{28}} & {{0100 001}} \tabularnewline
 \hline 
{{29}} & {{0100 000}} \tabularnewline
 \hline 
{{2a}} & {{0001 1010}} \tabularnewline
 \hline 
{{2b}} & {{0000 1101 1}} \tabularnewline
 \hline 
{{2c}} & {{0011 111}} \tabularnewline
 \hline 
{{2d}} & {{1001 01}} \tabularnewline
 \hline 
{{2e}} & {{0011 110}} \tabularnewline
 \hline 
{{2f}} & {{0001 1001}} \tabularnewline
 \hline 
{{30}} & {{0011 101}} \tabularnewline
 \hline 
{{31}} & {{1001 00}} \tabularnewline
 \hline 
{{32}} & {{0011 100}} \tabularnewline
 \hline 
{{33}} & {{0011 011}} \tabularnewline
 \hline 
{{34}} & {{0011 010}} \tabularnewline
 \hline 
{{35}} & {{0011 001}} \tabularnewline
 \hline 
{{36}} & {{0001 1000}} \tabularnewline
 \hline 
{{37}} & {{0011 000}} \tabularnewline
 \hline 
{{38}} & {{0010 111}} \tabularnewline
 \hline 
{{39}} & {{0001 0111}} \tabularnewline
 \hline 
{{3a}} & {{0001 0110}} \tabularnewline
 \hline 
{{3b}} & {{0000 0110 0010}} \tabularnewline
 \hline 
{{3c}} & {{0000 1001 000}} \tabularnewline
 \hline 
{{3d}} & {{0010 110}} \tabularnewline
 \hline 
{{3e}} & {{0000 1101 0}} \tabularnewline
 \hline 
{{3f}} & {{0000 1000 111}} \tabularnewline
 \hline 
{{40}} & {{0000 0110 0001}} \tabularnewline
 \hline 
{{41}} & {{1000 11}} \tabularnewline
 \hline 
{{42}} & {{0010 101}} \tabularnewline
 \hline 
{{43}} & {{1000 10}} \tabularnewline
 \hline 
{{44}} & {{1000 01}} \tabularnewline
 \hline 
{{45}} & {{1110 1}} \tabularnewline
 \hline 
{{46}} & {{0010 100}} \tabularnewline
 \hline 
{{47}} & {{0001 0101}} \tabularnewline
 \hline 
{{48}} & {{0001 0100}} \tabularnewline
 \hline 
{{49}} & {{1000 00}} \tabularnewline
 \hline 
{{4a}} & {{0000 1000 110}} \tabularnewline
 \hline 
{{4b}} & {{0000 1100 1}} \tabularnewline
 \hline 
{{4c}} & {{0111 11}} \tabularnewline
 \hline 
{{4d}} & {{0010 011}} \tabularnewline
 \hline 
{{4e}} & {{0111 10}} \tabularnewline
 \hline 
{{4f}} & {{0111 01}} \tabularnewline
 \hline 
{{50}} & {{0010 010}} \tabularnewline
 \hline 
{{51}} & {{0000 1000 101}} \tabularnewline
 \hline 
{{52}} & {{0111 00}} \tabularnewline
 \hline 
{{53}} & {{0110 11}} \tabularnewline
 \hline 
{{54}} & {{0110 10}} \tabularnewline
 \hline 
{{55}} & {{0010 001}} \tabularnewline
 \hline 
{{56}} & {{0000 1100 0}} \tabularnewline
 \hline 
{{57}} & {{0001 0011}} \tabularnewline
 \hline 
{{58}} & {{0000 1011 1}} \tabularnewline
 \hline 
{{59}} & {{0000 1011 0}} \tabularnewline
 \hline 
{{5a}} & {{0000 1000 100}} \tabularnewline
 \hline 
{{5b}} & {{0001 0010}} \tabularnewline
 \hline 
{{5c}} & {{0000 1000 011}} \tabularnewline
 \hline 
{{5d}} & {{0000 1010 1}} \tabularnewline
 \hline 
{{5e}} & {{0000 0110 0000}} \tabularnewline
 \hline 
{{5f}} & {{0001 0001}} \tabularnewline
 \hline 
{{60}} & {{0000 0101 1111}} \tabularnewline
 \hline 
{{61}} & {{1110 0}} \tabularnewline
 \hline 
{{62}} & {{0110 01}} \tabularnewline
 \hline 
{{63}} & {{0110 00}} \tabularnewline
 \hline 
{{64}} & {{0101 11}} \tabularnewline
 \hline 
{{65}} & {{1101 1}} \tabularnewline
 \hline 
{{66}} & {{0101 10}} \tabularnewline
 \hline 
{{67}} & {{0101 01}} \tabularnewline
 \hline 
{{68}} & {{0101 00}} \tabularnewline
 \hline 
{{69}} & {{1101 0}} \tabularnewline
 \hline 
{{6a}} & {{0000 1000 010}} \tabularnewline
 \hline 
{{6b}} & {{0010 000}} \tabularnewline
 \hline 
{{6c}} & {{1100 1}} \tabularnewline
 \hline 
{{6d}} & {{0100 11}} \tabularnewline
 \hline 
{{6e}} & {{1100 0}} \tabularnewline
 \hline 
{{6f}} & {{1011 1}} \tabularnewline
 \hline 
{{70}} & {{0100 10}} \tabularnewline
 \hline 
{{71}} & {{0000 1001 10}} \tabularnewline
 \hline 
{{72}} & {{1011 0}} \tabularnewline
 \hline 
{{73}} & {{1010 1}} \tabularnewline
 \hline 
{{74}} & {{1010 0}} \tabularnewline
 \hline 
{{75}} & {{1001 1}} \tabularnewline
 \hline 
{{76}} & {{0001 0000}} \tabularnewline
 \hline 
{{77}} & {{0001 111}} \tabularnewline
 \hline 
{{78}} & {{0000 1111}} \tabularnewline
 \hline 
{{79}} & {{0000 1110}} \tabularnewline
 \hline 
{{7a}} & {{0000 1001 01}} \tabularnewline
 \hline 
{{7b}} & {{0000 1000 001}} \tabularnewline
 \hline 
{{7c}} & {{0000 1000 000}} \tabularnewline
 \hline 
{{7d}} & {{0000 0101 1110}} \tabularnewline
 \hline 
{{7e}} & {{0000 0101 1101}} \tabularnewline
 \hline 
{{7f}} & {{0000 0101 1100}} \tabularnewline
 \hline 
{{80}} & {{0000 0010 0100 0}} \tabularnewline
 \hline 
{{81}} & {{0000 0010 0011 1}} \tabularnewline
 \hline 
{{82}} & {{0000 0010 0011 0}} \tabularnewline
 \hline 
{{83}} & {{0000 0010 0010 1}} \tabularnewline
 \hline 
{{84}} & {{0000 0010 0010 0}} \tabularnewline
 \hline 
{{85}} & {{0000 0010 0001 1}} \tabularnewline
 \hline 
{{86}} & {{0000 0010 0001 0}} \tabularnewline
 \hline 
{{87}} & {{0000 0010 0000 1}} \tabularnewline
 \hline 
{{88}} & {{0000 0010 0000 0}} \tabularnewline
 \hline 
{{89}} & {{0000 0001 1111 1}} \tabularnewline
 \hline 
{{8a}} & {{0000 0001 1111 0}} \tabularnewline
 \hline 
{{8b}} & {{0000 0001 1110 1}} \tabularnewline
 \hline 
{{8c}} & {{0000 0001 1110 0}} \tabularnewline
 \hline 
{{8d}} & {{0000 0001 1101 1}} \tabularnewline
 \hline 
{{8e}} & {{0000 0001 1101 0}} \tabularnewline
 \hline 
{{8f}} & {{0000 0001 1100 1}} \tabularnewline
 \hline 
{{90}} & {{0000 0001 1100 0}} \tabularnewline
 \hline 
{{91}} & {{0000 0001 1011 1}} \tabularnewline
 \hline 
{{92}} & {{0000 0001 1011 0}} \tabularnewline
 \hline 
{{93}} & {{0000 0001 1010 1}} \tabularnewline
 \hline 
{{94}} & {{0000 0001 1010 0}} \tabularnewline
 \hline 
{{95}} & {{0000 0001 1001 1}} \tabularnewline
 \hline 
{{96}} & {{0000 0001 1001 0}} \tabularnewline
 \hline 
{{97}} & {{0000 0001 1000 1}} \tabularnewline
 \hline 
{{98}} & {{0000 0001 1000 0}} \tabularnewline
 \hline 
{{99}} & {{0000 0001 0111 1}} \tabularnewline
 \hline 
{{9a}} & {{0000 0001 0111 0}} \tabularnewline
 \hline 
{{9b}} & {{0000 0001 0110 1}} \tabularnewline
 \hline 
{{9c}} & {{0000 0001 0110 0}} \tabularnewline
 \hline 
{{9d}} & {{0000 0001 0101 1}} \tabularnewline
 \hline 
{{9e}} & {{0000 0001 0101 0}} \tabularnewline
 \hline 
{{9f}} & {{0000 0001 0100 1}} \tabularnewline
 \hline 
{{a0}} & {{0000 0001 0100 0}} \tabularnewline
 \hline 
{{a1}} & {{0000 0001 0011 1}} \tabularnewline
 \hline 
{{a2}} & {{0000 0001 0011 0}} \tabularnewline
 \hline 
{{a3}} & {{0000 0001 0010 1}} \tabularnewline
 \hline 
{{a4}} & {{0000 0001 0010 0}} \tabularnewline
 \hline 
{{a5}} & {{0000 0001 0001 1}} \tabularnewline
 \hline 
{{a6}} & {{0000 0001 0001 0}} \tabularnewline
 \hline 
{{a7}} & {{0000 0001 0000 1}} \tabularnewline
 \hline 
{{a8}} & {{0000 0001 0000 0}} \tabularnewline
 \hline 
{{a9}} & {{0000 0000 1111 1}} \tabularnewline
 \hline 
{{aa}} & {{0000 0000 1111 0}} \tabularnewline
 \hline 
{{ab}} & {{0000 0000 1110 1}} \tabularnewline
 \hline 
{{ac}} & {{0000 0000 1110 0}} \tabularnewline
 \hline 
{{ad}} & {{0000 0000 1101 1}} \tabularnewline
 \hline 
{{ae}} & {{0000 0000 1101 0}} \tabularnewline
 \hline 
{{af}} & {{0000 0000 1100 1}} \tabularnewline
 \hline 
{{b0}} & {{0000 0101 1011}} \tabularnewline
 \hline 
{{b1}} & {{0000 0101 1010}} \tabularnewline
 \hline 
{{b2}} & {{0000 0101 1001}} \tabularnewline
 \hline 
{{b3}} & {{0000 0101 1000}} \tabularnewline
 \hline 
{{b4}} & {{0000 0101 0111}} \tabularnewline
 \hline 
{{b5}} & {{0000 0101 0110}} \tabularnewline
 \hline 
{{b6}} & {{0000 0101 0101}} \tabularnewline
 \hline 
{{b7}} & {{0000 0101 0100}} \tabularnewline
 \hline 
{{b8}} & {{0000 0101 0011}} \tabularnewline
 \hline 
{{b9}} & {{0000 0101 0010}} \tabularnewline
 \hline 
{{ba}} & {{0000 0101 0001}} \tabularnewline
 \hline 
{{bb}} & {{0000 0101 0000}} \tabularnewline
 \hline 
{{bc}} & {{0000 0100 1111}} \tabularnewline
 \hline 
{{bd}} & {{0000 0100 1110}} \tabularnewline
 \hline 
{{be}} & {{0000 0100 1101}} \tabularnewline
 \hline 
{{bf}} & {{0000 0100 1100}} \tabularnewline
 \hline 
{{c0}} & {{0000 0100 1011}} \tabularnewline
 \hline 
{{c1}} & {{0000 0100 1010}} \tabularnewline
 \hline 
{{c2}} & {{0000 0100 1001}} \tabularnewline
 \hline 
{{c3}} & {{0000 0100 1000}} \tabularnewline
 \hline 
{{c4}} & {{0000 0100 0111}} \tabularnewline
 \hline 
{{c5}} & {{0000 0100 0110}} \tabularnewline
 \hline 
{{c6}} & {{0000 0100 0101}} \tabularnewline
 \hline 
{{c7}} & {{0000 0100 0100}} \tabularnewline
 \hline 
{{c8}} & {{0000 0100 0011}} \tabularnewline
 \hline 
{{c9}} & {{0000 0100 0010}} \tabularnewline
 \hline 
{{ca}} & {{0000 0100 0001}} \tabularnewline
 \hline 
{{cb}} & {{0000 0100 0000}} \tabularnewline
 \hline 
{{cc}} & {{0000 0011 1111}} \tabularnewline
 \hline 
{{cd}} & {{0000 0011 1110}} \tabularnewline
 \hline 
{{ce}} & {{0000 0011 1101}} \tabularnewline
 \hline 
{{cf}} & {{0000 0011 1100}} \tabularnewline
 \hline 
{{d0}} & {{0000 0011 1011}} \tabularnewline
 \hline 
{{d1}} & {{0000 0011 1010}} \tabularnewline
 \hline 
{{d2}} & {{0000 0011 1001}} \tabularnewline
 \hline 
{{d3}} & {{0000 0011 1000}} \tabularnewline
 \hline 
{{d4}} & {{0000 0011 0111}} \tabularnewline
 \hline 
{{d5}} & {{0000 0011 0110}} \tabularnewline
 \hline 
{{d6}} & {{0000 0011 0101}} \tabularnewline
 \hline 
{{d7}} & {{0000 0011 0100}} \tabularnewline
 \hline 
{{d8}} & {{0000 0011 0011}} \tabularnewline
 \hline 
{{d9}} & {{0000 0011 0010}} \tabularnewline
 \hline 
{{da}} & {{0000 0011 0001}} \tabularnewline
 \hline 
{{db}} & {{0000 0011 0000}} \tabularnewline
 \hline 
{{dc}} & {{0000 0010 1111}} \tabularnewline
 \hline 
{{dd}} & {{0000 0010 1110}} \tabularnewline
 \hline 
{{de}} & {{0000 0010 1101}} \tabularnewline
 \hline 
{{df}} & {{0000 0010 1100}} \tabularnewline
 \hline 
{{e0}} & {{0000 0000 1100 0}} \tabularnewline
 \hline 
{{e1}} & {{0000 0010 1011}} \tabularnewline
 \hline 
{{e2}} & {{0000 0000 1011 1}} \tabularnewline
 \hline 
{{e3}} & {{0000 0000 1011 0}} \tabularnewline
 \hline 
{{e4}} & {{0000 0000 1010 1}} \tabularnewline
 \hline 
{{e5}} & {{0000 0010 1010}} \tabularnewline
 \hline 
{{e6}} & {{0000 0000 1010 0}} \tabularnewline
 \hline 
{{e7}} & {{0000 0000 1001 1}} \tabularnewline
 \hline 
{{e8}} & {{0000 0000 1001 0}} \tabularnewline
 \hline 
{{e9}} & {{0000 0010 1001}} \tabularnewline
 \hline 
{{ea}} & {{0000 0000 1000 1}} \tabularnewline
 \hline 
{{eb}} & {{0000 0000 1000 0}} \tabularnewline
 \hline 
{{ec}} & {{0000 0000 0111 1}} \tabularnewline
 \hline 
{{ed}} & {{0000 0000 0111 0}} \tabularnewline
 \hline 
{{ee}} & {{0000 0010 1000}} \tabularnewline
 \hline 
{{ef}} & {{0000 0000 0110 1}} \tabularnewline
 \hline 
{{f0}} & {{0000 0000 0110 0}} \tabularnewline
 \hline 
{{f1}} & {{0000 0000 0101 1}} \tabularnewline
 \hline 
{{f2}} & {{0000 0010 0111}} \tabularnewline
 \hline 
{{f3}} & {{0000 0010 0110}} \tabularnewline
 \hline 
{{f4}} & {{0000 0010 0101}} \tabularnewline
 \hline 
{{f5}} & {{0000 0000 0101 0}} \tabularnewline
 \hline 
{{f6}} & {{0000 0000 0100 1}} \tabularnewline
 \hline 
{{f7}} & {{0000 0000 0100 0}} \tabularnewline
 \hline 
{{f8}} & {{0000 0000 0011 1}} \tabularnewline
 \hline 
{{f9}} & {{0000 0000 0011 0}} \tabularnewline
 \hline 
{{fa}} & {{0000 0000 0010 1}} \tabularnewline
 \hline 
{{fb}} & {{0000 0000 0010 0}} \tabularnewline
 \hline 
{{fc}} & {{0000 0000 0001 1}} \tabularnewline
 \hline 
{{fd}} & {{0000 0000 0001 0}} \tabularnewline
 \hline 
{{fe}} & {{0000 0000 0000 1}} \tabularnewline
 \hline 
{{ff}} & {{0000 0000 0000 0}} \tabularnewline
\hline 
\end{longtable}
\end{center}

 where bits should be read from the left to the right.
\subsection{Decompression algorithm UNKNOWN}
\label{id2496606}\hypertarget{id2496606}{}%

The algorithms listed as UNKNOWN-x have not yet been mapped to actual algorithms but are known to be used by the games. For some of them, it is possible that they match one of the algorithms described above, but have not yet been added to FreeSCI in an appropriate way (refer to DCL-EXPLODE for a good example).

% -------------------------------------------------------------
% Chapter The Graphics subsystem 
% -------------------------------------------------------------         
\chapter{The Graphics subsystem}
\label{id2496624}\hypertarget{id2496624}{}%

% ------------------------   
% Section 
\section{General stuff}
\label{id2496630}\hypertarget{id2496630}{}%

The graphics in SCI are generated using four resource types: 
\begin{itemize}
%--- Item
\item 
Pic resources for background pictures


%--- Item
\item 
View resources for images


%--- Item
\item 
Font resources for drawing text


%--- Item
\item 
Cursor resources for displaying the mouse pointer

\end{itemize}
\noindent  Those resources are drawn on three distinct maps: 
\begin{itemize}
%--- Item
\item 
The visual map, used for displaying the actual pictures the player sees


%--- Item
\item 
The priority map, which keeps information about how the depth of the screen


%--- Item
\item 
The control map, which contains special information

\end{itemize}
\noindent 

% ------------------------   
% Section 
\section{SCI Ports}
\label{id2496685}\hypertarget{id2496685}{}%

Lars Skovlund

Version 1.0, 6. July 1999

Note that the observations made in this document are generally based
on SCI version 0.000.572 (the one that comes with LSL3), but should be
valid even for SCI01 and SCI1, as well. I know already about some
differences in the port system from SCI0 to SCI1, but I feel we should
have an interpreter running for SCI0 before dealing with SCI1.

This article discusses a key data structure in SCI graphics handling;
this data structure is called a port, and it is involved in most
graphics-related operations. The port is basically a graphics state
record, storing things like pen color, current font, cursor position
etc. Each port also has an origin and a size. The actual port data
structure has remained absolutely unchanged from SCI0 up to the latest
versions of SCI1.

The port can be viewed as a rectangle in which things are drawn. Every
drawing operation (even KDrawPic) is executed relative to the origin
coordinates of the current port (depending on the kernel function,
other parameters in the port structure are used as well), such that
coordinate (0, 0) in the "picture window" (such a thing really exists
in SCI!) is {\em{not}} the top of the screen, but rather the leftmost
point underneath the menu bar. The coordinate set (0,0) is called the
local coordinates, and its physical position on the screen, (0, 10),
is called the global coordinates. Kernel calls exist to ease
conversion between the two coordinate systems, but they are, it
appears, meant for event handlers to use, and not generally usable (I
think they take a pointer to an Event object as a parameter).

At least three ports are created and managed automatically by the SCI
interpreter. These are the "window manager" port, the menu port, and
the picture port (which is actually a window, see later). The latter
two should be fairly easy to understand. The menu bar is drawn in the
menu port, and the current room is drawn in the picture port. What may
be less obvious is that the window manager port is an "invisible"
port, on which the window backgrounds are drawn, although the windows
have a port themselves. If you are familiar with
Windows\texttrademark{} programming, the term "client rectangle" may
ring a bell here - SCI draws the window backgrounds, using values in
the window manager port, while the window's own port controls what is
drawn inside it. The window manager port covers the same bounding
rectangle as the picture window, but it is transparent so it doesn't
mess up the graphics.

I feel compelled to mention windows for a bit here, not in depth -
they are the subject of a later article - but just to mention that the
structure used to manage windows is just an extension of the port
structure. Whenever an SCI system call needs a pointer to a port
structure, a pointer to a window structure will do. This implicates
that the SysWindow class (which implements windows) has no "port"
property. Instead, its "window" property points to the extended
port/window structure which can safely be passed to KSetPort. Not
surprisingly, many of KNewWindow's arguments end up in the port part
of the window structure.

An SCI program can't directly instantiate a port. If a program wants
to access a specific part of the screen using ports, it has to
instantiate a transparent window. In fact, SCI creates the picture
window using RNewWindow, the same function that the kernel call
KNewWindow ends up calling, asking for an untitled window with a
transparent background - but more on that in a later article.

It must be stressed that ports are purely internal
structures. Although a program can select different ports to draw in,
the data structures themselves are absolutely off-limits to SCI
code. KNewWindow fills a port structure with user-supplied data, but
there is no way of changing that data, short of disposing the window
and instantiating it again. The structure is frequently changed by SCI
itself, though.

Only two kernel calls deal directly with ports:


\begin{tabular}{l}

KGetPort (see \hyperlink{KGetPort}{Section~{\ref{KGetPort}}})  \\
KSetPort (see \hyperlink{KSetPort}{Section~{\ref{KSetPort}}})  \\
\end{tabular}


These two functions are often used in pairs (also internally), like:


\begin{Verbatim}[]

var temp;

temp=KGetPort();  /* Save the old port */
KSetPort(...);      /* Activate some other port */
..                            /* Draw some stuff */
KSetPort(temp);    /* Reactivate the old port */

\end{Verbatim}


% ------------------------   
% Section 
\section{The Cursor resource}
\label{id2496841}\hypertarget{id2496841}{}%

This resource stores a simple bitmap describing the shape and texture of the mouse pointer. All information stored herein is little endian in byte order.


\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x00 - 0x01}]\null{}
X coordinate of the mouse cursor hot spot as a 16 bit integer. This variable is not used in SCI0.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x02 - 0x03}]\null{}
Y coordinate of the mouse cursor hot spot as a 16 bit integer. Only 0x03 is used in SCI0; here, if set, the hot spot is at (8,8), if not set, it is located at (0,0).
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x04 - 0x23}]\null{}
This is a list of 16 unsigned 16 bit integers constituting bitmasks for the mouse cursor's transparency map, with the MSB representing the leftmost pixel.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x24 - 0x43}]\null{}
This is another list of 16 unsigned 16 bit integers. Each of them represents another bitmask, determining whether the mouse cursor pixel should be drawn in black (not set) or white (set).
\end{description}
\noindent  To determine whether or not to draw a pixel, and, if it is to be drawn, in which color it should be drawn in, the corresponding bits of both bitmask lists mentioned above have to be examined. In the table below, A represents a bit from the first list, and B the corresponding bit from the lower list.
\subsection{Color mapping for the SCI0 mouse pointer}
\label{id2496908}\hypertarget{id2496908}{}%


% tabular ------------------------------------------------------
\begin{center}
\label{id2496917}\hypertarget{id2496917}{}%

\begin{tabular}{|c|c|}
\hline 
{{AB}} & {{Result}} \tabularnewline
 \hline 
{{00}} & {{Transparent}} \tabularnewline
 \hline 
{{01}} & {{Transparent}} \tabularnewline
 \hline 
{{10}} & {{0x00 (Black)}} \tabularnewline
 \hline 
{{11}} & {{0x0f (White)}} \tabularnewline
\hline 
\end{tabular}
\end{center}


\subsection{Color mapping for the SCI1 mouse pointer}
\label{id2496986}\hypertarget{id2496986}{}%

Since this method of doing things wastes one combination, the table was changed for SCI01 and SCI1: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2496996}\hypertarget{id2496996}{}%

\begin{tabular}{|c|c|}
\hline 
{{AB}} & {{Result}} \tabularnewline
 \hline 
{{00}} & {{Transparent}} \tabularnewline
 \hline 
{{01}} & {{0x0f (White)}} \tabularnewline
 \hline 
{{10}} & {{0x00 (Black)}} \tabularnewline
 \hline 
{{11}} & {{0x07 (Light Gray)}} \tabularnewline
\hline 
\end{tabular}
\end{center}



% ------------------------   
% Section 
\section{The SCI0 View Resource}
\label{id2497066}\hypertarget{id2497066}{}%

In SCI0, Views are collections of images or sprites. Each View resource contains a number of groups, which, in turn, contain one or more images. Usually, those groups contain a number of consecutive animation frames. It appears to be customary to store related animations or images in a single frame. For example, the basic movements of all protagonists (four or eight animation cycles (depending on the game)) are stored inside of a single View resource. Please note that the byte order of the following data is always little endian.
\subsection{The View Resource}
\label{id2497085}\hypertarget{id2497085}{}%


\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x00 - 0x01}]\null{}
The number of image groups available.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x02 - 0x03}]\null{}
A bitmask containing the 'mirrored' flag for each of the groups, with the LSB containing the 'mirrored' flag for group 0.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x04 - 0x07}]\null{}
- unknown -
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x08...}]\null{}
A list of indices pointing to the start of the cell list for each image group. The number of entries is equal to the number of cells as described in 0x00 - 0x01.
\end{description}
\noindent 
\subsection{Cell List}
\label{id2497137}\hypertarget{id2497137}{}%


\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x00 - 0x01}]\null{}
The number of image cells available for this group.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x02 - 0x03}]\null{}
- unknown -
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x04...}]\null{}
A list of 16 bit pointers indexing the start of the image cell structure for each image cell. The pointers are relative to the beginning of the resource data.
\end{description}
\noindent 
\subsection{Image Cell}
\label{id2497179}\hypertarget{id2497179}{}%


\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x00 - 0x01}]\null{}
The horizontal (X) size of the image.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x02 - 0x03}]\null{}
The vertical (Y) size of the image.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x04}]\null{}
The x placement modifier. This signed value determines the number of pixels a view cell is moved to the right before it is drawn.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x05}]\null{}
The y placement modifier. This signed value determines the number of pixels a view cell is moved downwards before it is drawn.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x06}]\null{}
The color key, i.e. the color number used for transparency in this cell.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{0x07...}]\null{}
A list of combined color/repeat count entries. Each byte contains a color entry (low nibble) and a repeat count (high nibble). If the color is equal to the color key from index 0x06, then no drawing should be performed, although [repeat] pixels still need to be skipped. It is not known whether this list is terminated; the FreeSCI drawing algorithm stops drawing as soon as the rectangle defined in the first two cell entries has been filled.
\end{description}
\noindent 

% ------------------------   
% Section 
\section{The SCI font resource}
\label{id2497256}\hypertarget{id2497256}{}%

SCI font resources remained unchanged during the SCI revisions and were still used in SCI32. Their format is relatively straightforward and completely sufficient for any 8 or even 16 bit character table:


% table ------------------------------------------------------
\begin{table}[htb]
\begin{center}%
\hypertarget{id2497271}{}%
\captionswapskip{}{{\caption{The SCI font resource data structure}\label{id2497271}}}

\captionswapskip{}\begin{tabular}{|c|c|p{6cm}|}
\hline 
{{Offset}} & {{Type}} & {{Meaning}} \tabularnewline
 \hline 
{{0}} & {{16 bit integer, little endian encoding}} & {{Always zero (?)}} \tabularnewline
 \hline 
{{2}} & {{16 bit integer, little endian encoding}} & {{NUMCHAR: Number of characters}} \tabularnewline
 \hline 
{{4}} & {{16 bit integer, little endian encoding}} & {{HEIGHT: Number of pixel lines per text line}} \tabularnewline
 \hline 
{{6 + NR * 2}} & {{16 bit integer, little endian encoding}} & {{Absolute offset of the character \#NR, where 0 \textless{}= NR \textless{} NUMCHAR}} \tabularnewline
\hline 
\end{tabular}
\end{center}
\end{table}



HEIGHT does not affect the height of a character, though- it only tells the interpreter how far to move downwards when displaying a line of text. The characters referenced to starting at offset 6 are encoded as follows: 
% table ------------------------------------------------------
\begin{table}[htb]
\begin{center}%
\hypertarget{id2497371}{}%
\captionswapskip{}{{\caption{The SCI font resource character data structure}\label{id2497371}}}

\captionswapskip{}\begin{tabular}{|c|c|c|}
\hline 
{{Offset}} & {{Type}} & {{Meaning}} \tabularnewline
 \hline 
{{0}} & {{unsigned 8 bit integer}} & {{character HEIGHT}} \tabularnewline
 \hline 
{{1}} & {{unsigned 8 bit integer}} & {{character WIDTH}} \tabularnewline
 \hline 
{{2...}} & {{bitmask, size HEIGHT * round\_up(WIDTH / 8)}} & {{Bitmask for the character}} \tabularnewline
\hline 
\end{tabular}
\end{center}
\end{table}

 The bitmap consists of HEIGHT lines of n bytes, where n equals the number of bytes required for storing WIDTH bits. Data is stored with the MSB first, in little-endian encoding (first byte describes the 8 leftmost pixels), where a pixel is drawn iff the bit it corresponds to is set.

% ------------------------   
% Section 
\section{The SCI0 and SCI01 pic resource}
\label{id2497455}\hypertarget{id2497455}{}%

The pic (background picture) resource format used in SCI0 is rather complex in comparison to the other graphical resource formats. It is best described as a sequence of drawing operations on a set of four 320x200 canvases, three of which are later used in the game (visual, priority, and control), and one of which is used during the drawing process for auxiliary purposes\label{id2497470}\begingroup\catcode`\#=12\footnote{
Due to the vector graphics nature of these drawing operations, they are inherently more scaleable than pixmaps.
}\endgroup\docbooktolatexmakefootnoteref{id2497470}

In order to describe the process, we will first need to define a set of operations we base them on:

\begin{Verbatim}[]

FUNCTION peek_input(): Byte; /* returns the byte pointed to by the input pointer */
FUNCTION get_input(): Byte; /* works like peek_input(), but also increminates the 
                            ** input pointer  */
FUNCTION skip_input(x): Byte; /* skips x input bytes */
      
\end{Verbatim}
 Using these pre-defined functions, we will now define additional helper functions used for reading specifically encoded data tuples: 
\begin{Verbatim}[]

FUNCTION GetAbsCoordinates(): (Integer, Integer)
VAR
        x, y, coordinate_prefix : Integer;
BEGIN
        coordinate_prefix := get_input();
        x := get_input();
        y := get_input();
        x |= (coordinate_prefix & 0xf0) << 4;
        y |= (coordinate_prefix & 0x0f) << 8;

        RETURN (x,y)
END


FUNCTION GetRelCoordinates(x : Integer, y: Integer): (Integer, Integer)
VAR
        input : Integer;
BEGIN
        input := get_input();
        IF (input & 0x80) THEN
                x -= (input >> 4);
        ELSE
                x += (input >> 4);
        FI

        IF (input & 0x08) THEN
                y -= (input & 0x7);
        ELSE
                y += (input & 0x7);
        FI

        RETURN (x,y)
END

      
\end{Verbatim}
 We also need some data types based on EGACOLOR and PRIORITY, which can be thought of as integers: 
\begin{Verbatim}[]

TYPE Palette = ARRAY[0..39] of EGACOLOR[0..1]
TYPE Priority_Table = ARRAY[0..39] of PRIORITY

Palette default_palette =
     <(0,0), (1,1), (2,2), (3,3), (4,4), (5,5), (6,6), (7,7),
      (8,8), (9,9), (a,a), (b,b), (c,c), (d,d), (e,e), (8,8),
      (8,8), (0,1), (0,2), (0,3), (0,4), (0,5), (0,6), (8,8),
      (8,8), (f,9), (f,a), (f,b), (f,c), (f,d), (f,e), (f,f),
      (0,8), (9,1), (2,a), (3,b), (4,c), (5,d), (6,e), (8,8)>;

#define DRAW_ENABLE_VISUAL   1
#define DRAW_ENABLE_PRIORITY 2
#define DRAW_ENABLE_CONTROL  4

#define PATTERN_FLAG_RECTANGLE 0x10
#define PATTERN_FLAG_USE_PATTERN 0x20
      
\end{Verbatim}
 And now for the actual algorithm: 
\begin{Verbatim}[]

FUNCTION DrawPic (cumulative, fill_in_black : Boolean; default_palette: Integer; visual_map, priority_map, control_map, aux_map : Map): Map^4
VAR
        palette : Array [0..3] of Palette;
        drawenable, priority, col1, col2, pattern_nr, pattern_code : Integer;
BEGIN
        palette := (default_palette * 4);
        drawenable := DRAW_ENABLE_VISUAL | DRAW_ENABLE_PRIORITY
        priority := 0;
        col1 := col2 := 0;
        pattern_nr := 0;
        pattern_code := 0;

        IF (!cumulative) THEN BEGIN
                visual_map := (0xf * 320 * 200);
                map control := map priority := map aux := (0 * 320 * 200);
        END

        FOREVER DO BEGIN

                opcode := get_input();

                COND opcode:
                        0xf0 => /* PIC_OP_SET_COLOR */
                                code := get_input();
                                (col1, col2) := palette[default_palette + (code / 40)][code % 40];
                                drawenable |= DRAW_ENABLE_VISUAL;

                        0xf1 => /* PIC_OP_DISABLE_VISUAL */
                                drawenable &= ~DRAW_ENABLE_VISUAL;

                        0xf2 => /* PIC_OP_SET_PRIORITY */
                                code := get_input();
                                priority := code & 0xf;
                                drawenable |= DRAW_ENABLE_PRIORITY;

                        0xf3 => /* PIC_OP_DISABLE_PRIORITY */
                                drawenable &= ~DRAW_ENABLE_PRIORITY;

                        0xf4 => /* PIC_OP_RELATIVE_PATTERNS */
                                IF (pattern_code & PATTERN_FLAG_USE_PATTERN) THEN
                                        pattern_nr := (get_input() >> 1) & 0x7f
                                FI

                                (x,y) := GetAbsCoordinates();

                                DrawPattern(x, y, col1, col2, priority, control, drawenable,
                                                 pattern_code & PATTERN_FLAG_USE_PATTERN,
                                                 pattern_size, pattern_nr, pattern_code & PATTERN_FLAG_RECTANGLE);

                                WHILE (peek_input() < 0xf0) DO BEGIN
                                        IF (pattern_code & PATTERN_FLAG_USE_PATTERN) THEN
                                                pattern_nr := (get_input() >> 1) & 0x7f
                                        FI
                                        (x,y) =  GetRelCoordinates(x,y);
                                        DrawPattern(x, y, col1, col2, priority, control, drawenable,
                                                         pattern_code & PATTERN_FLAG_USE_PATTERN,
                                                         pattern_size, pattern_nr, pattern_code & PATTERN_FLAG_RECTANGLE);
                                END

                        0xf5 => /* PIC_OP_RELATIVE_MEDIUM_LINES */
                                (oldx, oldy) := GetAbsCoordinates();
                                WHILE (peek_input() < 0xf0) DO BEGIN
                                        temp := get_input();
                                        IF (temp & 0x80) THEN
                                                y := oldy - (temp & 0x7f)
                                        ELSE
                                                y := oldy + temp
                                        FI
                                        x = oldx + get_input();
                                         DitherLine(oldx, oldy, x, y, col1, col2, priority, special, drawenable);
                                        (oldx, oldy) := (x, y);
                                END

                        0xf6 => /* PIC_OP_RELATIVE_LONG_LINES */
                                (oldx, oldy) :=  GetAbsCoordinates()
                                WHILE (peek_input() < 0xf0) DO BEGIN
                                        (x, y) := GetAbsCoordinates();
                                        DitherLine(oldx, oldy, x, y, col1, col2, priority, special, drawenable);
                                        (oldx, oldy) := (x, y);
                                END

                        0xf7 => /* PIC_OP_RELATIVE_SHORT_LINES */
                                (oldx, oldy) =  GetAbsCoordinates()
                                WHILE (peek_input() < 0xf0) DO BEGIN
                                        (x, y) := GetRelCoordinates(oldx, oldy);
                                        DitherLine(oldx, oldy, x, y, col1, col2, priority, special, drawenable);
                                        (oldx, oldy) := (x, y);
                                END

                        0xf8 => /* PIC_OP_FILL */
                                IF (fill_in_black) THEN
                                        (oldc1, oldc2) := (c1, c2);
                                FI

                                WHILE (peek_unput() < 0xf0) DO BEGIN
                                        (x, y) := GetAbsCoordinates();
                                        DitherFill(x, y, col1, col2, priority, special, drawenable);
                                END

                                IF (fill_in_black) THEN
                                        (c1, c2) := (oldc1, oldc2);
                                FI

                        0xf9 => /* PIC_OP_SET_PATTERN */
                                pattern_code := get_input() & 0x37;
                                pattern_size := pattern_code & 0x7;

                        0xfa => /* PIC_OP_ABSOLUTE_PATTERNS */
                                WHILE (peek_input() < 0xf0) DO
                                        IF (pattern_code & PATTERN_FLAG_USE_PATTERN)
                                                pattern_nr := (get_input() >> 1) & 0x7f
                                        FI
                                        (x, y) := GetAbsCoordinates();
                                        DrawPattern(x, y, col1, col2, priority, control, drawenable,
                                                         pattern_code & PATTERN_FLAG_USE_PATTERN,
                                                         pattern_size, pattern_nr, pattern_code & PATTERN_FLAG_RECTANGLE);
                                        END

                        0xfb => /* PIC_OP_SET_CONTROL */
                                control := get_input() & 0x0f;
                                drawenable |= DRAW_ENABLE_CONTROL;

                        0xfc => /* PIC_OP_DISABLE_CONTROL */
                                drawenable &= ~DRAW_ENABLE_CONTROL;

                        0xfd => /* PIC_OP_RELATIVE_MEDIUM_PATTERNS */
                                IF (pattern_code & PATTERN_FLAG_USE_PATTERN) THEN
                                        pattern_nr := (get_input() >> 1) & 0x7f;
                                FI

                                (oldx, oldy) := GetAbsCoordinates();

                                DrawPattern(x, y, col1, col2, priority, control, drawenable,
                                                 pattern_code & PATTERN_FLAG_USE_PATTERN,
                                                 pattern_size, pattern_nr, pattern_code & PATTERN_FLAG_RECTANGLE);

                                WHILE (peek_input() < 0xf0) DO BEGIN
                                        IF (pattern_code & PATTERN_FLAG_USE_PATTERN) THEN
                                                pattern_nr := (get_input() >> 1) & 0x7f;
                                        FI
                        
                                        temp := get_input();
                                        IF (temp & 0x80)
                                                y := oldy - (temp & 0x7f)
                                        ELSE
                                                y := oldy + temp
                                        FI
                                        x := oldx + get_input();
                                        DrawPattern(x, y, col1, col2, priority, control, drawenable,
                                                         pattern_code & PATTERN_FLAG_USE_PATTERN,
                                                         pattern_size, pattern_nr, pattern_code & PATTERN_FLAG_RECTANGLE);
                                END

                        0xfd => /* PIC_OP_OPX */
                                COND get_input():
                                        0x00 => /* PIC_OPX_SET_PALETTE_ENTRY */
                                                WHILE peek_input() < 0xf0 DO BEGIN
                                                        index := get_input();
                                                        color := get_input();
                                                        palette[index / 40][color % 40] := color;
                                                END

                                        0x01 => /* PIC_OPX_SET_PALETTE */
                                                palette_number := get_input();
                                                FOR i := 0 TO 39 DO
                                                        palette[palette_number][i] := get_input();
                                                OD

                                        0x02 => /* PIC_OPX_MONO0 */
                                                skip_input(41);

                                        0x03 => /* PIC_OPX_MONO1 */
                                                skip_input(1);

                                        0x04 => /* PIC_OPX_MONO2 */
                                        0x05 => /* PIC_OPX_MONO3 */
                                                skip_input(1);

                                        0x06 => /* PIC_OPX_MONO4 */
                                        0x07 => /* PIC_OPX_EMBEDDED_VIEW */ /* SCI01 operation */
                                        0x08 => /* PIC_OPX_SET_PRIORITY_TABLE */ /* SCI01 operation */

                        0xff => return (visual, control, priority, aux);
                END OF COND
      END
END
      
\end{Verbatim}
 This algorithm uses three auxiliary algorithms, DrawPattern, DitherLine, and DitherFill, which are sketched below. All of these functions are supposed to take the four maps as implicit parameters. 
\begin{Verbatim}[]

PROCEDURE DrawPattern(x, y, col1, col2, priority, control, drawenable : Integer;  solid : Boolean ;  pattern_size, pattern_nr : Integer; rectangle : Boolean)

Alters (x,y) so that 0 <= (x - pattern_size), 319 >= (x + pattern_size), 189 >= (y + pattern_size) and
0 <= (y - pattern_size), then draws a rectangle or a circle filled with col1, col2, priority, control,
as determined by drawenable.
If rectangle is not set, it will draw a rectangle, otherwise a circle of size pattern_size.
pattern_nr is used to specify the start index in the random bit table (256 random bits)



PROCEDURE DitherLine(x, y, xend, yend, color1, color2, priority, control, drawenable : Integer)

Draws a dithered line between (x, y+10) and (xend, yend+10). If the appropriate drawenable flags
are set, it draws 'priority' to the priority map, 'control' to the control map, and 'color1' and 'color2'
(alternating) to the visual map. The auxiliary map is bitwise-or'd with the drawenable flag while this is
done.



PROCEDURE DitherFill(x, y, col0, col1, priority, control, drawenable : Integer)
Fills all layers for which drawenable is set with the appropriate content.
Diagonal filling is not allowed.
Boundaries are determined as follows:
x<0, x>319, y<10, y>199 are hard boundaries. We now determine the
'boundary map' bound_map and the allowed color legal_color.
If bound_map[coordinates] = legal_color, then the pixel may be filled.

IF (drawenable & DRAW_ENABLE_VISUAL)
        bound_map = visual;
        legal_color = 0xf;
ELSIF (drawenable & DRAW_ENABLE_PRIORITY)
        bound_map = priority;
        legal_color = 0;
ELSIF (drawenable & DRAW_ENABLE_CONTROL)
        bound_map = control;
        legal_color = 0;
ELSE
        return;
FI
      
\end{Verbatim}

% ------------------------   
% Section 
\section{SCI1 palettes}
\section{Palette types}
There are two kinds of palettes in SCI: Local palettes and global
palettes. Local palettes are associated with a graphical resource,
while the global palette resides in a separate resource. In SCI1.0,
both kinds hold exactly 256 elements, and only
synchronous palette operations can be initiated by the VM. SCI1.1
changes the palette format radically and introduces the ability to
perform asynchronous palette cross-fades. The exact format of SCI1.1
palettes is not known and will not be described here, nor will the
associated kernel calls.

\noindent The global palette is updated on several occasions:
\begin{itemize}
\item On game startup, the global palette is loaded from the 999.pal resource. 
\item It may be replaced at any time using the appropriate kernel
  call. 
\item When a graphical resource is loaded for
display, its palette entries are merged into the global palette
(``installing'' it -- see section \ref{installmode} for more information), and all further operations are
carried out on the global palette. Functions that only return view
metadata do not touch the global palette.
\item The game may explicitly request installation of a view's palette
  (SCI1.1 only)
\end{itemize}

The local palette entries are usually placed in the right spot in the
local palette, such that installing them is a simple matter of
copying. This is not always the case, however.
\section{The palette format}
\noindent A SCI1.0 palette, whether global or local, consists of the following items:
\begin{enumerate}
\item A mapping of each color index into the global palette (the
  global palette and most, if not all, palettes on disk have the
  identity function here).
\item A 32-bit time stamp for internal use (it is always zero in the
  resources). 
\item A list of FRGB tuples where F is a flag byte telling if the index is in use and if it is the
  victim of an approximate mapping (see section \ref{installmode}). The
  flag bits are given in figure \ref{fig:palflagbits} -- the remaining bits
  were perhaps used during development.
\end{enumerate}

\begin{figure}[b!]
\begin{tabular}{cl}
Bit&Description\\
\hline
0&The entry is used\\
4&Another color has been inexactly mapped to this one\\
\end{tabular}
\label{fig:palflagbits}
\caption{Flag bits in each palette entry}
\end{figure}
In addition to these, the global palette contains, for each color, a
brightness value. It is measured in percent, and is kept separate
from the RGB triples to avoid interfering with color matching. This is
not stored in the resources, but defaults to $100$. The values may be
changed by the game, for example to allow the same pic to be used in
day and night scenes.

A palette is assumed always to contain pure black and pure white with
indices $0$ and $255$, respectively. This is enforced when performing
cross-fades in SCI1.1, and in addition, those entries are ignored by
certain operations, brightness control in particular.

\section{Installing a palette}
\label{installmode}
When installing a palette, there are two different modes. They are
shown in table \ref{fig:palinstallmode} and described in detail
below. No, the numbers in the table are not reversed, it just happens
that the least-used mode has the value 0.
\begin{figure}
\begin{tabular}{cl}
Mode&Description\\
\hline
0&Merge into the global palette.\\
%1&Same as above. Used for cel palettes.\\
2&Force insertion.\\
\end{tabular}
\label{fig:palinstallmode}
\caption{The palette installation modes}
\end{figure}
\begin{description}
\item[Forced mapping] As the name indicates, \emph{target} palette
  entries are always overwritten by the corresponding \emph{source}
  entry. If a \emph{source} entry is unused, the corresponding
  \emph{target} entry is left untouched.
\item[Normal merge]
When using this method, five steps are taken in an attempt to map each
source entry to a target entry. In each case, the \emph{source}
palette is updated to indicate the new mapping. If one step fails, the
next is executed, and so on:
\begin{enumerate}
\item If the $i$'th \emph{source} entry is not used, skip to the next.
\item If the $i$'th \emph{target} entry is not used, then the
  \emph{source} entry is mapped to it.
\item Try to find an exact match in the \emph{target} palette and map
  to it if one is found.
\item Try to find an unused index in the \emph{target} palette and map
  to it if one is found.
\item Map to the closest color in the \emph{target} palette, with
  infinite tolerance. Because infinite tolerance is used, this step
  will never fail. In addition, flag bit 4 in the \emph{target}
  palette entry may be set by some SCI versions to indicate an
  approximate mapping.
\end{enumerate}
\end{description}
Forced mapping is used implicitly almost everywhere within the
interpreter. Thus, there is no real need
for removing palette entries explicitly, because a large part of the
palette is (in practice, though not in theory) replaced in strategic
places. When loading palettes explicitly, the game may specify a
different mapping strategy. 

Brightness values are left untouched during all implicit palette
operations. Thus, it is not safe to add new cels to a scene while
using brightness adjustment. 
\newpage
\section{Kernel calls}
\begin{kernelcall*}{Palette}
The subfunctions listed here are for version 1.001.029; the
subfunction indices are given in figure
\ref{subfx:Palette:indices}. Palette ranges are closed intervals. The functions are described in detail below.
\begin{figure}[b!]
\caption{Subfunction indices of the Palette() kernel call}
\label{subfx:Palette:indices}
\begin{tabular}{ll}
Subfunction&Index\\
\hline
PAL\_LOAD\_PALETTE&1\\
PAL\_SET\_FLAGS&2\\
PAL\_CLEAR\_FLAGS&3\\
PAL\_SET\_BRIGHTNESS&4\\
PAL\_CLOSEST\_RGB&5\\
PAL\_CYCLE&6\\
PAL\_SAVE\_PALETTE&7\\
PAL\_RESTORE\_PALETTE&8\\
\hline
\end{tabular}
\end{figure}

\begin{subfx}
\callsynt{PAL\_LOAD\_PALETTE number mode}

Loads the palette resource given by \parameter{number} and makes it
the current global palette. The exact semantics depend on the
\parameter{mode} parameter, see section \ref{installmode}.

\callsynt{PAL\_SET\_FLAGS first last bit}

For the range of palette entries givem by \parameter{first} and
\parameter{last}, sets the given \parameter{bit}(s) in the palette
flags (using the binary OR operator).

\callsynt{PAL\_CLEAR\_FLAGS first last bit}

For the range of palette entries givem by \parameter{first} and
\parameter{last}, sets the given \parameter{bit}(s) in the palette
flags (using the binary NAND operator).

\callsynt{PAL\_SET\_BRIGHTNESS first last brightness defer}

For the range of palette entries given by \parameter{first} and
\parameter{last}, sets the brightness (measured in percent) to
\parameter{brightness}.
The \parameter{defer} flag, if given, tells SCI whether to defer the
changes until later. If the parameter is not given, the changes are
always committed immediately.

\callsynt{PAL\_CLOSEST\_RGB r g b}
Finds the palette entry that matches the given rgb triple most
closely. Infinite tolerance is used -- new palette entries are never
created.
\returns{The index of the matching palette entry}

\callsynt{PAL\_CYCLE first last speed \ldots}
Cycles the given range(s) of palette entries once. The \parameter{speed}
parameter can be used to control the cycling as follows: The
interpreter remembers each active cycling range, and stores a timestamp for
each of them. We only cycle a particular range if at least
\parameter{speed} game ticks have passed since the last time we did so. The
interpreter is responsible for aging the active cycles and eventually
getting rid of them.

An arbitrary number of arguments can be given in groups of three. The
given cycles are performed sequentially. A negative \parameter{speed}
indicates reverse cycling (but the function as a speed setting still applies).

\callsynt{PAL\_SAVE\_PALETTE}
Allocates memory for a palette and stores a snapshot of the global
palette in it (including brightness values). The memory may be released either by using the
\methname{PAL\_RESTORE\_PALETTE} subfunction or the \kcallname{Memory}
kernel call.
\returns{A pointer to the allocated memory block}

\callsynt{PAL\_RESTORE\_PALETTE handle}
Restores the contents of a palette handle and implicitly frees the
associated memory.
\end{subfx}
\end{kernelcall*}
\section{Windows, Dialogs and Controls}
\label{LarsWindows}\hypertarget{LarsWindows}{}%

by Lars Skovlund

Version 1.0, 7. July 1999

I am going to start by mentioning the menus. It has nothing to do with the material I deal with in this essay. They use different kernel calls, and such things as port management are handled internally by the kernel routines. The SCI program just sets up a menu structure using the kernel calls. Since they are irrelevant to the subject of this essay, I will not spend more time on them.

The Rect structure is important (also to ports) since it is the basis for passing a screen position to the interpreter. It looks like this:


\begin{Verbatim}[]

typedef struct
{
  short top, left, bottom, right;
}

\end{Verbatim}


It will be seen from this that rectangle coordinates in SCI are not normally represented in the usual (x,y,width,height) fashion. So pay close attention to this structure! Also, it is not passed as a pointer, but rather as the four values in order. This is particularly true of SCI objects, where the property names nsTop etc. actually form a Rect structure which can be used directly by the interpreter.

Windows are created using the KNewWindow kernel function. Each window has six attributes which are passed from the script to the kernel function:


\begin{tabular}{l}

Bounding rectangle  \\
Title  \\
Type  \\
Priority  \\
Foreground color  \\
Background color  \\
\end{tabular}


Of these, the type and priority are the most interesting, because they decide the appearance of the window. The type is a bit field:


\begin{tabular}{l}

bit 0 - transparency  \\
bit 1 - window does \_not\_ have a frame  \\
bit 2 - the window has a title  \\
bit 3-6 - unused  \\
bit 7 - see below  \\
\end{tabular}


Bit 0 specifies a transparent window. KNewWindow does not save the image behind the created window - it stays on the screen until the pic is redrawn, so windows with this style definitely can't be used as message boxes. It does have some special uses, though. If this bit is not set, KNewWindow draws a rectangle in the specified background color using the bounding rectangle coordinates (using the WM port). When this bit is set,

Bit 1 specifies a window without a frame. The frame is the black shading you can see in the corner of a message box.

Bit 2 tells KNewWindow to draw a grey title bar with a title printed in white. In the version I have used for this essay, it is not possible to change the title bar colors. Note that the bounding rectangle is always specified as if the window had no title bar. If this bit is set, ten pixels are reserved above the coordinates specified. Although this bit is set, the Title parameter may still be NULL. If this is the case, an empty title bar is drawn.

Bit 7 has a special meaning; it is used only in window type 0x81, and is not tested in any other way. When this style is chosen, KNewWindow does not draw anything at all. It is the caller's responsibility to draw a window frame on the WM port. CB1 uses this style for its ornate windows, and draws the frame manually.

The picture window which I mentioned in the last article is created using style 3 (that is, TRANSPARENT \docbooktolatexpipe{} NOFRAME). The normal message box styles used in LSL3 are 0 and 4.

I have not been able to investigate the priority property yet, so the fol- lowing is based on suppositions. It is only used when drawing transparent windows. In this case, if priority is not -1 (which means not used), the window is drawn onto the priority map (with the specified priority value) as well as the screen.

There is a class called SysWindow which is just a simple wrapper around the following two kernel calls. Try breaking on SysWindow::open, then type c to inspect the current object. You can change all the parameters to KNewWin- dow (the Rect is split in its fields, to nsTop, nsLeft etc.)

To create a window structure, use KNewWindow (see \hyperlink{KNewWindow}{Section~{\ref{KNewWindow}}}); to remove it again, apply KDisposeWindow (see \hyperlink{KDisposeWindow}{Section~{\ref{KDisposeWindow}}}) on it.

So how do we put stuff inside these windows? That question is a little com- plicated to answer, because it is really a shared effort between the inter- preter and the object hierarchy, and this is one case where the interpreter actually interacts with the objects itself. I will start by explaining the classes involved.

All control types are descendants of a common class (I do not know its name, since it appears to have an invalid name property). Among other things, this common class contains a type number and a state. The type number is the only thing that distinguishes the control types from each other inside the interpreter - if a wrong type is set, the interpreter might try to change a non-existent property.

The type numbers are laid out as follows: 

\begin{tabular}{l}
1 - Button control  \\
2 - Text control  \\
3 - Edit control  \\
4 - Icon control  \\
5 - not used  \\
6 - Selector control (as in the Save and Restore boxes)  \\
\end{tabular}

 The gauge "controls" are not really controls. I don't know how they work (yet).

Each control also has a state value. These are laid out as follows: 

\begin{tabular}{lp{12cm}}
bit 0 & selectable. If this bit is set, the control can be selected using the Tab key. Except for the text and icon controls, all controls are selectable.  \\
bit 1 & unknown. Always set, except for the text and icon controls  \\
bit 2 & disabled. When this bit is set, a button is grayed out. No other control types are affected.  \\
bit 3 & selected. When this bit is set, a frame is drawn around the control.  \\
\end{tabular}

 Note that state 3 is by far the most common. With that explained, I'll move on to the kernel functions. There are three functions associated with controls - KDrawControl (see \hyperlink{KDrawControl}{Section~{\ref{KDrawControl}}}), KHiliteControl (see \hyperlink{KHiliteControl}{Section~{\ref{KHiliteControl}}}) and KEditControl (see \hyperlink{KEditControl}{Section~{\ref{KEditControl}}}). Note that there is a KOnControl kernel call which is entirely unrelated to window management.

The dialogs are implemented using not one, but two classes - Dialog and Window. While the Window class maintains the window (It is derived from SysWindow), the Dialog class is just a list of controls. It is derived from the List class, but has extended functionality to tell its members to redraw etc. There is a special function, located in script 255, which allows scripts to push information about the dialog on the stack instead of creating the Dialog object manually.

Note that the internal debugger uses the same window calls as the SCI script. That is why the screen messes up if you step through drawing code - the debugger has activated the Debug window port, and "forgets" to switch back while stepping across instructions. Thus, all graphics commands are redirected to the debug window port. Not a pretty sight.


% ------------------------   
% Section 
\section{Pictures and movement control}
\label{LARSPICSANDMOVEMENT}\hypertarget{LARSPICSANDMOVEMENT}{}%

ByLars Skovlund

Version 1.0, 24. July 1999

A pic in SCI consists of three layers (called maps - they are unrelated to the map resources found in SCI1 games). The visual map, used for the picture which appears on the user's screen. The priority map which tells the interpreter which things go in front of which in the three-dimensional room. Without the priority map, a room would just be a flat, painted surface. The control map decides where game characters (called actors) can walk and where special events occur. These special events are triggered by a game character walking on a particular spot. Where the visual map is almost always very complex and using dithered fills etc., the latter two consist of large areas of solid color.

Many functions which need to access these maps do so by using a bit-field. The bits are laid out as follows (but don't set more than one at a time!) 

\begin{tabular}{l}
bit 0 - Visual  \\
bit 1 - Priority  \\
bit 2 - Control  \\
\end{tabular}


It is important to understand that, although being represented as colors on the screen, a priority/control "color" should be considered a number. The colors map to values according to the standard EGA color values.

Every animated object in SCI has a priority. As the object moves, its pri- ority changes according to the so-called priority bands, explained next (it is, however, possible for a script to lock the priority of a view). The picture window is divided vertically into 16 priority bands. The priority of an animated object is determined by the position of its "base rectangle" in one of these bands. Things are drawn in order of ascending priority, so objects with priority 15 are guaranteed to be in front of everything else. The default priority mapping gives priority 0 a fairly large space, the 42 topmost rows (including the menu bar which AFAIK is 10) in the picture. All other priority bands have the same size. A script can choose to alter this mapping, specifying the amount of space to assign to priority 0, and the number of the last row to include in the mapping calculation.

In most rooms, it is desirable to limit actor movement, confining the actor to a specific part of the screen. In other cases, special events are triggered by movement into a specific screen area. On some occasions, even room switches are implemented using control polygons. While the meaning of priorities is determined by the kernel, the meaning of control values is entirely up to the script. It is more or less a standard, however, that actors can't walk on white control areas.

As the control map is not consulted by the interpreter itself (except in a few cases), scripts need a way to do so. That way is called OnControl, and it is a kernel call. Supplied with a point or a rectangle, it returns a bit mask containing the control values of all the pixels in the desired region. If a specific control value is encountered, it is used as a bit number, and that bit is set in the output mask.

This bit mask system is also used in another place, namely the illegalBits selector of the Act (actor) class. The illegalBits selector determines in which areas the actor may not walk.

The OnControl() system call is explained in \hyperlink{KONCONTROL}{Section~{\ref{KONCONTROL}}}.

% -------------------------------------------------------------
% Chapter The Sound subsystem 
% -------------------------------------------------------------         
\chapter{The Sound subsystem}
\label{id2498141}\hypertarget{id2498141}{}%

% ------------------------   
% Section 
\section{The SCI0 Sound Resource Format}
\label{id2498147}\hypertarget{id2498147}{}%

by Ravi Iyengar

Revision 10, Mar. 11, 2002
\subsection{Preface}
\label{id2498166}\hypertarget{id2498166}{}%

Sierra's SCI0 sound resources contain the music and sound effects played during the game. With the introduction of SCI, the company took advantage of new sound hardware which allowed for far better music than the traditional PC speaker could ever create. Sierra chose two devices to specifically target: the MT-32, and the Adlib. The MT-32 is a MIDI synth while the Adlib is a less expensive card based around the OPL2, a non-MIDI chip. Anyone interested in Sierra music and its history can find information at the Sierra Soundtrack Series (http://www.queststudios.com).

Music is stored as a series of MIDI events, and the sound resource is basically just a MIDI file. The MIDI standard and device implementations are not covered here in detail, but specifications should be readily available elsewhere.

SCI0 Sound resources can also contain digital samples, although an SCI remake of KQ1 is the only DOS game I know of that includes them. These files still contain MIDI data, but the wave data is appended at the end. The MIDI data is an approximation of the sound effect for hardware that can't play digital sound.

Some people prefer the one-based numbering system for channel and program numbers. I personally prefer the zero-based system, and use it here. If you're familiar with channels 1-16, be aware that I will call them 0-15. My intention is not to be deviant from other programs but to be more accurate in representing the way information gets stored. The same is true for programs 0-127 as opposed to 1-128. For whatever reason, convention already holds that controls be numbered 0-127, so nothing in my treatment of them should be abnormal.

Sierra changed its sound file format in the switch to SCI1. I refer only to SCI0 sound files in this specification. Hybrid interpreters such as the one used for Quest for Glory II are also excluded. Finally, SCI games written for non-DOS systems may have different formats. This document applies to Sierra's IBM games.

Please post comments or questions to the SCI webboard:\\\texttt{ http://pub48.bravenet.com/forum/show.asp?usernum=4071584210}

You can contact me personally at ravi.i@softhome.net, but I would prefer that SCI messages be posted on the webboard so everyone can see them.
\subsection{Sound Devices}
\label{id2498227}\hypertarget{id2498227}{}%

A gamer's sound hardware greatly affects how music will sound. Devices used by SCI0 can be broken into general categories: 
\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{MIDI Synths}]\null{}
These will generally give the best sound quality. MIDI synths are polyphonic with definable instruments through patch files and full support for MIDI controls. The General MIDI standard had not been written when Sierra began writing SCI games, and as far as I know no SCI0 game uses a GM driver or includes a GM track. This means that synths had to be individually supported.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Non-MIDI Synths}]\null{}
Generally not as good as MIDI synths, but also less expensive. The OPLx family of chips are still very common among home PC users thanks to the Adlib and SoundBlaster cards. Synths are polyphonic with definable instruments through patch files, but drivers must be written to interpret MIDI events and turn them into commands the hardware will recognize. Support for most sound controls gets lost in the process. Furthermore, drivers must map logical, polyphonic MIDI channels to physical, monophonic hardware channels. A control (4Bh) was introduced for this purpose and will be discussed later.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Beepers}]\null{}
Beepers produce very poor music and don't support instrument definitions, but all PC users have one so supporting them covers people without special sound hardware. The most common device is the PC speaker, which is monophonic. Another is the Tandy speaker with 3 channels. Drivers must interpret MIDI events, but need only concern themselves with basic functionality. Interpreting the MIDI events is also made easier because each channel is monophonic. To play a chord on the Tandy, for example, each voice must be put in a separate MIDI channel.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Wave Devices}]\null{}
Wave devices play digital sound data. They could be used in conjunction with one of the above devices to add special sound effects to a game. The Amiga port of SCI uses a wave device to play music.
\end{description}
\noindent 

With such a diverse group of devices to support, Sierra put a lot of the work on the shoulders of the drivers. Functions for loading patch files, handling events, pausing, etc. are all in the drivers. The interpreter calls them as needed but does not concern itself at all with how they get implemented.

Listed here are devices supported by the SCI0 interpreter with a little information about each. There could very well be other hardware not listed here, so please send in any missing information.


% tabular ------------------------------------------------------
\begin{center}
\label{id2498325}\hypertarget{id2498325}{}%

\begin{tabular}{|c|c|c|c|c|}
\hline 
{{Device Name}} & {{Driver}} & {{Patch}} & {{Poly}} & {{Flag}} \tabularnewline
 \hline 
{{Roland MT-32}} & {{mt32}} & {{001}} & {{32}} & {{01h}} \tabularnewline
 \hline 
{{Adlib}} & {{adl}} & {{003}} & {{9}} & {{04h}} \tabularnewline
 \hline 
{{PC Speaker}} & {{std}} & {{*}} & {{1}} & {{20h}} \tabularnewline
 \hline 
{{Tandy 1000 or PCJr}} & {{jr}} & {{*}} & {{3}} & {{10h}} \tabularnewline
 \hline 
{{Tandy 1000 SL, TL}} & {{tandy}} & {{*}} & {{3}} & {{10h}} \tabularnewline
 \hline 
{{IBM Music Feature}} & {{imf}} & {{002}} & {{8}} & {{+}} \tabularnewline
 \hline 
{{Yamaha FB-01}} & {{fb01}} & {{002}} & {{8}} & {{02h}} \tabularnewline
 \hline 
{{CMS or Game Blaster}} & {{cms}} & {{101}} & {{12}} & {{04h}} \tabularnewline
 \hline 
{{Casio MT540 or CT460}} & {{mt540}} & {{004}} & {{10}} & {{08h}} \tabularnewline
 \hline 
{{Casio CSM-1}} & {{}} & {{007}} & {{}} & {{}} \tabularnewline
 \hline 
{{Roland D110,D10,D20}} & {{}} & {{000}} & {{}} & {{}} \tabularnewline
\hline 
{{Amiga Sound}} & {{amigasnd}} & {{}} & {{4}} & {{40h}} \tabularnewline
\hline 
{{General MIDI}} & {{}} & {{004}} & {{}} & {{01h}} \tabularnewline
\hline 
\end{tabular}
\end{center}

 (thanks to Shane T. for providing some of this). Blank fields are unknown, not unused. 

\begin{tabular}{lp{13cm}}
* & when asked which patch to load, the PC and Tandy speaker drivers return FFFFh, which is a signal that they do not use patches  \\
+ & the imf driver almost certainly uses 02h for the play flag, but I haven't confirmed this  \\
\end{tabular}


The driver column holds the file name of each driver without the .drv extension. The patch column specifies which patch resource each driver requests. The poly column is the maximum number of voices which can be played at once according to the driver. The flag column gives each device's play flag. Play flags, explained in the header section, determine which channels a device will play.
\subsection{File Format}
\label{id2498593}\hypertarget{id2498593}{}%

Sound files follow the same format as all extracted SCI0 resources. The first two bytes of the file contain a magic number identifying the resource type. The rest of the file contains a dump of the uncompressed data. The identifier is the resource type (04h for sound) OR-ed with 80h and stored as a word. The result will be 84h 00h in extracted sound files.

The sound resource data itself is a header with channel initialization followed by a series of MIDI events.
\subsubsection{Header}
\label{id2498611}\hypertarget{id2498611}{}%

The header provides the sound driver with 2 pieces of information about each channel. The first is a byte which specifies how many voices each logical MIDI channel will be playing. For MIDI synths, this information is not really necessary and is probably ignored. The same goes for beepers. This byte is only useful for non-MIDI synths which must know how many hardware channels each logical MIDI channel will need. This value is only an initial setting. Sound files can request changes to the mapping later with control changes. Requesting more hardware channels than are actually available can cause errors on some drivers.

The second byte describes how the user's sound hardware should treat the channel. It is the combination of bit flags which may be OR-ed together. If the appropriate bit is set for the currently selected sound device, the channel will be played. If it is not, the channel will be silent. The driver decides which bit it will use as the play flag, and the table under Sound Devices lists the flag used by each driver. Drivers ignore the first byte (used to request hardware channels) on MIDI channels they don't play.

The MT-32 always plays channel 9, the MIDI percussion channel, regardless of whether or not the channel is flagged for the device. Other MIDI devices may also do this.

A byte at the beginning of the file, before channel initialization, specifies whether the resource contains a digital sample or not. A value of 0 means that there is only MIDI data. A value of 2 means that there is a digital sample at the end of the file. In this case, only the first 15 MIDI channels have header bytes. The two header bytes for the last channel is replaced with an offset to the digital sound effect. The offset is stored in big-endian order in the resource. If present, it points to the last byte before the digital sample header. If the offset is 0, the file must be searched for the status FCh, and the digital sample header will come next. There may be two FCh bytes in a row, in which case both will come before the digital sample header. The digital sample header is discussed in more detail in the digial sample section.

The header format: 

\begin{tabular}{l}
1 byte - digital sample flag (0 or 2)  \\
2 bytes - initialization for channel 0  \\
2 bytes - initialization for channel 1  \\
.  \\
.  \\
.  \\
2 bytes - initialization for channel 15 OR offset to digital sample  \\
\end{tabular}


The header is always 33 bytes long.
\subsubsection{Events}
\label{id2498701}\hypertarget{id2498701}{}%

The actual music is stored in a series of events. The generic form for an event is: 

\begin{tabular}{l}
\textless{}delta time\textgreater{} [byte - status] [byte - p1 [p2]]  \\
\end{tabular}


Delta time is the number of ticks to wait after executing the previous event before executing this event. Ticks occur at 60 Hz. The delta time value is usually a single byte. However, longer delays can be produced by using F8h any number of times before the delta time value. Each F8h byte causes a delay of 240 ticks before continuing playback. For example, the sequence F8 F8 78 FC waits 600 ticks then stops the sequence because of the FCh status. The fact that F8h waits F0h ticks makes me think that E9h is the largest technically allowable delta time.

The delta time must be present in most events. The only exception is when FCh is the status, because FCh is a real-time message. Sierra's resources seem to have always provided a delta time, though. Note also that FCh cannot be used as a delta time value - it will be interpreted as a stop sequence status.

The status byte is basically a command. The most significant bit is always set. This feature is important because the status byte will not always be present. A missing status byte is known as running status mode and the last status gets repreated with the new parameters. Parameters will never have their most significant bits set.

The generic form for a status byte is (in bits) 1xxxcccc. The lower nibble usually specifies a channel. The upper specifies a status.
\subsubsection{Status Reference}
\label{id2498764}\hypertarget{id2498764}{}%


\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{8x n v}]\null{}
Note off: Stop playing note n on channel x, releasing the key with velocity v. If a hold pedal is pressed, the note will continue to play after this status is received and end when the pedal is released.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{9x n v}]\null{}
Note on: Play note n on with velocity v on channel x. Playing a note with velocity 0 is a way of turning the note off.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Ax n p}]\null{}
Key pressure (after-touch): Set key pressure to p for note n on channel x. This is to modify key pressure for a note that is already playing.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Bx c s}]\null{}
Control: Set control c to s on channel x. This can be confusing because there isn't just one meaning. Changing the settings on different controls will, of course, have different outcomes.

Controls which handle any value are continuous controllers. They have a continuous range. Controls which are only on/off are switches. Their defined values are 01h (OFF) and 7Fh (ON).

Listed in this reference are the non-standard MIDI controls I've found in Sierra SCI0 sound files. Standard controls are not listed here. Not all drivers support all controls.

Control Reference 
\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{4Bh}]\null{}
Channel mapping: When a channel sets this control, it tells the driver how many notes it will be playing at once, and therefore how many hardware channels it occupies.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{4Ch}]\null{}
Reset on PauseSound: An on/off switch where a value of zero is off and a non-zero value is on. Note that this is not the same as for standard MIDI control switches. When this control is on, calling the sound driver's PauseSound subfunction will reset the sound position to the beginning. The initial value is set to off when a sound gets loaded.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{4Eh}]\null{}
Unknown: Experiments in setting and clearing it show that a value of 0 will cause notes to be played without regard for the velocity paramater while a value of 1 will enable velocities.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{50h}]\null{}
Reverb: I know little about this myself. Rickard Lind reports that it exists in the MT-32 driver and supports parameter values 0-10 (possibly 0-16?).
% \null and \mbox are tricks to induce different typesetting decisions
\item[{60h}]\null{}
Cumulative cue: The interpreter can get cues from the sound file, which sets the Sound object's signal property. When a sound gets loaded, the initial cue is set to 127. When a CC60 occurs, the new control value is added to the current cue. If the cue were 130, for example, a CC60 5 on any channel would make the new cumulative cue equal 135.
\end{description}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Cx p}]\null{}
Program change: Set program (patch / instrument / ect.) to p for channel x. This is a simple instrument change.

Channel 15, however, includes two special cases of this status. The first relates to communication with the game interpreter. If p is less than 127 then the signal property for the game interpreter's Sound object gets set to p, triggering a non-cumulative cue.

If p is equal to 127, then the current position within the sound resource is remembered as the loop point. Normally the driver loops to the beginning of the sound when the sequence ends. If an explicit loop point is set, the sound will be replayed from the marked point instead.

The actual time of the loop point is better explained with a short diagram: 
\begin{verbatim}

0x10 0x91 0x20 0x20  play a note on channel 1
0x05 0x91 0x20 0x00  stop the previous note
0x00 0x92 0x30 0x10  play a note on channel 2
  [restart here]
0x00 0xCF 0x7F       set loop point
0x00 0xC8 0x05       change to program 5 on channel 8
0x00 0xCF 0x13       set signal to 19
0x20 0xFC            end of file, loop to marked location 
\end{verbatim}


In both situations (p \textless{} 127 and p = 127), no actual program change takes place. Channel 15 is used for control, not playing music.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Dx p}]\null{}
Pressure (after-touch): Set key pressure to p on channel x. This is similar to Ax but differs in its scope. Message Ax is applied on a per-note basis while message Dx is applied to an entire channel.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Ex t b}]\null{}
Pitch wheel: Set the pitch wheel to tb. The setting is actually a 14 bit number with the least significant 7 bits stored in b and the most significant 7 bits stored in t. The range of values is 0000h to 3FFFh. A value of 2000h means that the pitch wheel is centered. Larger values raise pitch and smaller values lower it.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{F0}]\null{}
Begin SysEx: Starts a system exclusive data block. The block must terminate with F7h.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{F7}]\null{}
End SysEx: Ends a system exclusive data block. Normal sound data resumes at this point.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{FC}]\null{}
Stop Sequence: This is a system real-time message which tells the sound driver to stop the current sound. The sound object's signal property gets set to FFFFh and the position moves to the loop point, which defaults to the beginning. Drivers allow this message to occur without a delta time, but I haven't seen any examples.
\end{description}
\noindent 
\subsection{Digital Samples}
\label{id2499053}\hypertarget{id2499053}{}%

The digital sample header is 44 bytes long. Offset 14 in the header contains the frequency as a short integer. Offset 32 contains the sample length, also as a short integer. Other fields in the header are unknown (to me) at the time of writing, but aren't critical to playback.

The wave data comes immediately after the header, stored in unsigned 8 bit PCM format.
\subsection{Amiga Sound (SCI0)}
\label{amigasound}\hypertarget{amigasound}{}%

The SCI0 Amiga Sound driver does not use a patch resource, instead it loads an external instrument bank called 'bank.001'. This file has the following structure (all numbers are big-endian): \\
\\
\begin{tabular}{ll}
{\texttt{{[00]..[07]}}}&String "X0iUo123"  \\
{\texttt{{[08]..[25]}}}&Bank name  \\
{\texttt{{[26][27]}}}&Number of instruments (= \#i)  \\
{\texttt{{[28]..}}}&\#i instruments  \\
\end{tabular} \\
\\
\noindent An instrument has the following format: \\
\\
\begin{tabular}{ll}
{\texttt{{[00][01]}}}&Instrument number \\
{\texttt{{[02]..[1f]}}}&Instrument name \\
{\texttt{{[20][21]}}}&Flags: \\
&\begin{tabular}{ll}
Bit 0&looping on/off \\
Bit 1&pitch changes on/off \\
\end{tabular} \\
{\texttt{{[22]}}}&Transpose value in semitones (= \#t) \\
{\texttt{{[23][24]}}}&Segment 1 size in words (= \#s1) \\
{\texttt{{[25][26][27][28]}}}&Segment 2 offset in bytes \\
{\texttt{{[29][2a]}}}&Segment 2 size in words (= \#s2) \\
{\texttt{{[2b][2c][2d][2e]}}}&Segment 3 offset in bytes \\
{\texttt{{[2f][30]}}}&Segment 3 size in words (= \#s3) \\
{\texttt{{[31]..[3c]}}}&Velocity envelope \\
{\texttt{{[3d]..}}}&\#s1+\#s2+\#s3 signed 8-bit samples \\
\end{tabular} \\
\\
\noindent A velocity envelope has the following format: \\
\\
\begin{tabular}{ll}
{\texttt{{[00]}}}&Phase 1 period size in ticks (= \#p1) \\
{\texttt{{[01]}}}&Phase 2 period size in ticks (= \#p2) \\
{\texttt{{[02]}}}&Phase 3 period size in ticks (= \#p3) \\
{\texttt{{[03]}}}&Phase 4 period size in ticks (= \#p4) \\
{\texttt{{[04]}}}&Phase 1 velocity delta (= \#d1), range [0-64] \\
{\texttt{{[05]}}}&Phase 2 velocity delta (= \#d2) \\
{\texttt{{[06]}}}&Phase 3 velocity delta (= \#d3) \\
{\texttt{{[07]}}}&Phase 4 velocity delta (= \#d4) \\
{\texttt{{[08]}}}&Phase 1 target velocity (= \#v1), range [0-64] \\
{\texttt{{[09]}}}&Phase 2 target velocity (= \#v2) \\
{\texttt{{[0a]}}}&Phase 3 target velocity (= \#v3) \\
{\texttt{{[0b]}}}&Phase 4 target velocity (assumed to be 0) (= \#v4) \\
\end{tabular} \\

With looping off, all samples are played. The segments and the envelope data are ignored. With looping on, Segment 1 is played first, followed by a looping of Segment 2 (Segment 3 is never played). As Segments 1 and 2 may overlap; it is possible for \#s1 + \#s2 to exceed the total number of samples; in that case \#s3 will be negative.

Velocity envelope phases 1 and 2 are applied after note-on, and phases 3 and 4 after note-off. If \#p0 is zero, no velocity envelope is applied. For other phases, a period size of 0 is interpreted as a period size of 256 ticks. If the velocity drops to 0 at any point, the note is stopped right away, even if more phases follow. Otherwise, the note is stopped after phase 4, which always has a target volume of 0 (note that it is possible to construct velocity envelopes that never terminate).

Each envelope phase n operates as follows, where \#v0 is the velocity from the note-on event (divided by two to scale it to Amiga volume levels):
\begin{verbatim}
vel = #v(n-1);
while (true) {
    set_channel_velocity(vel * #v0 / 64);
    wait_ticks(#pn);
    vel -= #dn;
    if ((#dn >= 0 and vel <= #vn) or (#dn < 0 and vel >= #vn)) {
        if (#vn == 0)
            stop_note();
        break;
    }
}
\end{verbatim}

All instruments have a samplerate of 20000Hz. With pitch changes off, the instrument is always played at this frequency, regardless of the note. With pitch changes on, \#t is first added to the note. The instrument is then played at the corresponding frequency (where note 101 equals 20000Hz).

The Amiga has four audio channels. Channels 0 and 3 are panned hard left and channels 1 and 2 are panned hard right. The first MIDI channel with playmask 0x40 is mapped to channel 0, the second to channel 1, etc. The driver seems to ignore all pan and volume commands.

\subsection{General MIDI and MT-32 (SCI1)}
\label{genmidi}\hypertarget{genmidi}{}%

The SCI1 MT-32 driver uses patch file 1, and the GM driver uses patch file 4. The file formats are identical however, and the same goes (to a large extent) for the drivers. The patch files have the following structure:

\begin{tabular}{ll}
{\texttt{{[000]..[07f]}}}&patchMap  \\
{\texttt{{[080]..[0ff]}}}&patchKeyShift  \\
{\texttt{{[100]..[17f]}}}&patchVolumeAdjust  \\
{\texttt{{[180]..[1ff]}}}&percMap  \\
{\texttt{{[200]}}}&percVolumeAdjust (not used)  \\
{\texttt{{[201]..[280]}}}&velocityMapIndex  \\
{\texttt{{[281]..[300]}}}&velocityMap 0  \\
{\texttt{{[301]..[380]}}}&velocityMap 1  \\
{\texttt{{[381]..[400]}}}&velocityMap 2  \\
{\texttt{{[401]..[480]}}}&velocityMap 3  \\
{\texttt{{[481][482]}}}&Size (little endian) of MIDI data (= \#i)  \\
{\texttt{{[483]..}}}&\#i bytes of MIDI data  \\
\end{tabular} \\

\begin{itemize}
\item patchMap[$i$]: Native patch number for patch $i$, or $-1$ for unused entries.
\item patchKeyShift[$i$]: Key shift value for patch $i$. This value should be added to every non-rhythm key that is played. If the key goes out of bounds [0,127], it should be clipped by a multiple of 12 semitones.
\item patchVolumeAdjust[$i$]: Volume adjust value for patch $i$. This value should be added to the volume (when setting controller 07h) \emph{before} scaling it by the master volume.
\item percMap[$i$]: Native key for key $i$ of the percussion channel, or $-1$ for unused entries.
\item percVolumeAdjust: Not used.
\item velocityMapIndex[$i$]: Specifies which velocityMap to use for patch $i$.
\item velocityMap[$i$]: Native velocity for velocity $i$.
\item MIDI data: MIDI data to initialize the device. Note that this data can contain sysex commands, after which an appropriate delay should be executed.
\end{itemize}

\subsection{Revision history}
\label{id2499070}\hypertarget{id2499070}{}%


\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 10 - Mar. 11, 2002}]\null{}

\begin{itemize}
%--- Item
\item 
Added section on digital samples (thanks to the FreeSCI developers, Rickard Lind especially)


%--- Item
\item 
Added wave devices to the hardware category list


%--- Item
\item 
Updated header section to cover the header for PCM resources


%--- Item
\item 
Added more play flags to the sound driver table


%--- Item
\item 
Fixed a typo in the sound driver table where I accidentally called the "Yamaha FB-01" the "Yamaha FM-01"

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 9 - Jul. 4, 2001}]\null{}

\begin{itemize}
%--- Item
\item 
Changed StopSound to PauseSound for control 4Ch


%--- Item
\item 
Updated URL for SCI messageboard


%--- Item
\item 
Added web links for more SCI information\label{id2499142}\begingroup\catcode`\#=12\footnote{
Editor's note: These are not included in the FreeSCI documentation version
}\endgroup\docbooktolatexmakefootnoteref{id2499142}


%--- Item
\item 
Did a little proofreading and editing

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 8 - Dec. 21, 2000}]\null{}

\begin{itemize}
%--- Item
\item 
Added suggested limit on delta time values


%--- Item
\item 
Fixed hex notation (sometimes listed NNh, sometimes 0xNN)


%--- Item
\item 
Removed notice about early revisions' mistake describing the header's channel mapping byte


%--- Item
\item 
Added note about control 50h (thanks to Rickard Lind)


%--- Item
\item 
Listed MT-32 play flag


%--- Item
\item 
Added notice about the special case of channel 9 to the header section

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 7 - Jan. 7, 2000}]\null{}

\begin{itemize}
%--- Item
\item 
Added information about F8h delta times (thanks to Rickard Lind for bringing these to my attention)


%--- Item
\item 
Reorganized Fx status information


%--- Item
\item 
Fixed major error in description of loop points (sorry)


%--- Item
\item 
Fixed typos

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 6 - Sep. 17, 1999}]\null{}

\begin{itemize}
%--- Item
\item 
Added information about cues


%--- Item
\item 
Updated control 60h information


%--- Item
\item 
Added information about loop points


%--- Item
\item 
Updated control 4Ch information


%--- Item
\item 
Cleaned up control reference introduction

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 5 - Jul. 5, 1999}]\null{}

\begin{itemize}
%--- Item
\item 
Rewrote much of the specification, trying to focus less on explaining MIDI and more on explaining sound resources


%--- Item
\item 
Removed information about standard MIDI controls


%--- Item
\item 
Added driver table


%--- Item
\item 
Expanded sound device section


%--- Item
\item 
Completed header information

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 4 - Jun. 19, 1999}]\null{}

\begin{itemize}
%--- Item
\item 
Fixed the list of changes in Revision 3 (was incomplete)


%--- Item
\item 
Expanded the introductory blurb about controls


%--- Item
\item 
I began working with a disassembly of ADL.DRV, and am hoping to use it to complete this specification. The next revision should be more interesting than this one.

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 3 - May 4, 1999}]\null{}

\begin{itemize}
%--- Item
\item 
Removed the "compatible games" list. I haven't found a non-compatible SCI0 game yet, which makes the list quite useless.


%--- Item
\item 
Verified that SCI1 sound resources are different.


%--- Item
\item 
Tidied the "About the output medium" section. Does that term "output medium" sound wordy or unclear? I don't really like it, but I didn't want to beat "sound device" to death.


%--- Item
\item 
More information about the header


%--- Item
\item 
Modified the explanation for message FCh.


%--- Item
\item 
Changed most references to status bytes as "commands" with "messges" to stay more consistent with MIDI terminology.


%--- Item
\item 
Added midi.org as a source for more MIDI information


%--- Item
\item 
Removed labels like "tentative" and "incomplete" as things become more concrete -- not complete yet, but getting there.


%--- Item
\item 
More information about controls

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 2 - Jan. 16, 1999}]\null{}

\begin{itemize}
%--- Item
\item 
Got rid of the HTML. I originally intented to post this as a message on the webboard, but ended up distributing the file. If I'm going to distribute it as a file, there's no need to bother with the HTML since I can do all my formatting as plain text.


%--- Item
\item 
I found refrences to command 8x in the 1988 Christmas Card, so my comment about not seeing one got removed. To date, I haven't seen any examples of commands Ax or Dx.


%--- Item
\item 
Expanded the header section.


%--- Item
\item 
Added information about controls.


%--- Item
\item 
Added information about the output mediums.


%--- Item
\item 
Tried to be more consistent with terminology

\end{itemize}
\noindent 
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Revision 1 - Dec. 29, 1998}]\null{}

\begin{itemize}
%--- Item
\item 
First release of the specification

\end{itemize}
\noindent 
\end{description}
\noindent 

% ------------------------   
% Section 
\section{Mapping instruments in FreeSCI}
\label{id2499459}\hypertarget{id2499459}{}%
\subsection{The Patch.002 resource}
\label{id2499465}\hypertarget{id2499465}{}%

As Ravi describes in his description of the patch resources (which have not been included here), one of the major problems with SCI sound support is the lack of General Midi (GM) support in the earlier games. Since those were written before GM was conceived, this can hardly be considered to be Sierra's fault; but this fact doesn't help when it comes to supporting the games in a portable manner.

Unfortunately, almost every SCI0 game uses an individual instrument mapping scheme. This means that there are only two options to generate GM music from the original SCI sound resources: Either create a manual mapping for each game, or abuse existing data from the game for this purpose. Obviously, the latter way would be either impossible or much easier.

So, the solution would be to use an existing instrument mapping scheme. Those mapping schemes are stored in the patch resources, and, as such, easily accessible to an SCI engine. As those patch files are driver dependant (which, in turn, are hardware dependant), most of the patch data is unusable. The Adlib data, for example, will only work for an OPL-2 FM synthesizer chip or one of its successors, the MT-32 data (which consists of one massive sysex block) won't help anyone without an MT-32 or LAPC-1, and so on. So, to recycle this hardware-dependant data, two new possibilities remain: Either extract and interpret the patch data using a portable software synthesizer (such as timidity), or extract instrument names and map those to GM instruments. The first approach would, of course, yield the better results (at the cost of computation power); but the only software emulator for a specific sound system I've seen so far was an OPL-2 emulator. So the alternative, extracting a text ID of each instrument and using it to map this instrument to a GM instrument, looks much more promising.

Now, most SCI0 games come with a patch.002 resource, which is used by the IBM Music Feature card and Yamaha FM-01 sound synthesizers (both of which appear to use frequency modulation). This is the only patch file that includes text descriptions of most of its instruments. Note this, not all instruments have name representation. This means that some of them can't be mapped and have to be silenced; but those instruments are either used for sound effects only or not used at all, so this isn't critical.

Using those 7-letter instrument names, it is now possible to build a small database of instruments, which, subseqently, can be mapped to GM instruments.

The file structure is relatively simple (for this purpose): Every patch.002 consists of either one or two instrument banks carrying 48 instruments each. Every instrument has a fixed block size of 0x40 bytes; each block starts with the 7-letter description of the instrument or seven blanks if none is available.

If two banks are present, the second bank is separated from the first one by a two-byte sequence (0xab, 0xcd). Keeping this in mind, it is trivial to extract the instrument names of the 48 or 96 instruments.
\subsection{Percussion instruments}
\label{id2499543}\hypertarget{id2499543}{}%

Percussion instruments are treated specially in the MIDI standard. MIDI channel 10 (or 9, if you count from 0 to 15 like most people do) is reserved for percussions and some special effects; each key for this channel represents either nothing or one fixed percussion instrument.

At first glance, this might lead to an additional problem of mapping those percussion instruments. Fortunately, the General Midi standard extends on the MT-32 percussion mappings, which are used in SCI0, so that channel 9 can be left completely untouched in the process of instrument mapping.

% -------------------------------------------------------------
% Chapter The SCI virtual machine 
% -------------------------------------------------------------         
\chapter{The SCI virtual machine}
\label{id2499573}\hypertarget{id2499573}{}%

% ------------------------   
% Section 
\section{Introduction}
\label{id2499579}\hypertarget{id2499579}{}%
\subsection{Script resources}
\label{id2499584}\hypertarget{id2499584}{}%

Like any processor, the SCI virtual machine is virtually useless without code to execute. This code is provided by script resources, which constitute the logic behind any SCI game.

In order to operate on the script resource, those first have to be loaded to the heap. The heap is the only memory space that the VM can work on directly (with some restrictions); all other memory spaces have to be used implicitly or explicitly by using kernel calls. The heap also contains a stack, which is heavily used by SCI bytecode.

Each script resource may contain one or several of various script objects, listed here: 

\begin{tabular}{l}
Type 1: Object  \\
Type 2: Code  \\
Type 3: Synonym word lists  \\
Type 4: Said specs  \\
Type 5: Strings  \\
Type 6: Class  \\
Type 7: Exports  \\
Type 8: Relocation table  \\
Type 9: Preload text (a flag, rather than a real section)  \\
Type 10: Local variables  \\
\end{tabular}


Standard SCI0 scripts (of post-0.000.396 SCI0, approximately) consist of a four-byte header, followed by a list of bytes: 

\begin{tabular}{l}
{\texttt{{[00][01]}}}: Block type as LE 16 bit value, or 0 to terminate script resource  \\
{\texttt{{[02][03]}}}: Block size as LE 16 bit value; includes header size  \\
{\texttt{{[04].\dbz{}.\dbz{}.\dbz{}}}}: Data  \\
\end{tabular}


The code blocks contain the SCI bytecode that actually gets executed. The export block (of which there may be only one (or none at all)) contains script-relative pointers to exported functions, which can be called by the SCI operations {\texttt{{calle}}} and {\texttt{{callb}}}. The local variables block, which stores one of the four variable types, is used to share variables among the objects and classes of one script.

But the most important script members are Objects and Classes. As in the usual OOP terms, Classes refer to object prototypes, and Objects are instantiated Classes. However, unlike most OOP languages, SCI treats the base class very similar to objects, so that they may actually get called by the SCI bytecode. Therefore, they also have their own space for selectors (see below). Also, each object or class knows which class it inherits from and which class it was instantiated from (in the case of objects).

Note that all script segments are optional and 16 bit aligned; they are described in more detail below:


\subsubsection{Object segments}
\label{id2499727}\hypertarget{id2499727}{}%

Objects look like this (LE 16 bit values): 

\begin{tabular}{l}
{\texttt{{[00][01]}}}: Magic number 0x1234  \\
{\texttt{{[02][03]}}}: Local variable offset (filled in at run-time)  \\
{\texttt{{[04][05]}}}: Offset of the function selector list, relative to its own position  \\
{\texttt{{[06][07]}}}: Number of variable selectors (= \#vs)  \\
{\texttt{{[08][09]}}}: The 'species' selector  \\
{\texttt{{[0a][0b]}}}: The 'superClass' selector  \\
{\texttt{{[0c][0d]}}}: The '--info--' selector  \\
{\texttt{{[0e][0f]}}}: The 'name' selector (object/class name)  \\
{\texttt{{[10].\dbz{}.\dbz{}.\dbz{}}}}: (\#vs-4) more variable selectors  \\
{\texttt{{[08+\dbz{} \#vs*2][09+\dbz{} \#vs*2]}}}: Number of function selectors (= \#fs)  \\
{\texttt{{[0a+\dbz{} \#vs*2].\dbz{}.\dbz{}.\dbz{}}}}: Selector IDs for the functions  \\
{\texttt{{[08+\dbz{} \#vs*2 +\dbz{} \#fs*2][09+\dbz{} \#vs*2 +\dbz{} \#fs*2]}}}zero  \\
{\texttt{{[0a+\dbz{} \#vs*2 +\dbz{} \#fs*2].\dbz{}.\dbz{}.\dbz{}}}}: Function selector code pointers  \\
\end{tabular}

 For objects, the selectors are simply values for the selector IDs specified in their species class (which is either present by its offset (in-memory) or class ID (in-script)- the same for the species' superclass (superClass selector)). Info typically has one of the following values (although this does not appear to be relevant for SCI): 

\begin{tabular}{l}
{\texttt{{0x0000}}}: Normal (statical) object  \\
{\texttt{{0x0001}}}: Clone  \\
{\texttt{{0x8000}}}: Class  \\
\end{tabular}

 Other values are used, but do not appear to be of relevance\label{id2499890}\begingroup\catcode`\#=12\footnote{
See SQ3's inventory objects for an example
}\endgroup\docbooktolatexmakefootnoteref{id2499890}.
\subsubsection{Code segments}
\label{id2499897}\hypertarget{id2499897}{}%

Code segments contain free-form SCI bytecode. Pointers into this code are held by objects, classes, and export entries; these entries are, in turn, referenced in the export segment.
\subsubsection{Synonym word list segments}
\label{id2499910}\hypertarget{id2499910}{}%

Inside these, synonyms for certain words may be found. A synonym is a tuple (a, b), where both a and b are word groups, and b is the replacement for a if this synonym is in use. They are stored as 16 bit LE values in sequence (first a, then b). Synonyms must be set explicitly by the kernel function SetSynonyms() (as described \hyperlink{kfunct-set-synonyms}{Section~{\ref{kfunct-set-synonyms}}}). It is not possible to select synonyms selectively.
\subsubsection{Said spec segments}
\label{id2499933}\hypertarget{id2499933}{}%

This section contains said specs (explained in \hyperlink{CRSaidSpec}{Section~{\ref{CRSaidSpec}}}), tightly grouped.
\subsubsection{String segments}
\label{id2499949}\hypertarget{id2499949}{}%

This segment contains a sequence of asciiz strings describing class and object names, debug information, and (occasionally) game text.
\subsubsection{Class segments}
\label{id2499960}\hypertarget{id2499960}{}%

Classes look similar to objects: 

\begin{tabular}{l}
{\texttt{{[00][01]}}}: Magic number 0x1234  \\
{\texttt{{[02][03]}}}: Local variable offset (filled in at run-time)  \\
{\texttt{{[04][05]}}}: Offset of the function selector list, relative to its own position  \\
{\texttt{{[06][07]}}}: Number of variable selectors (= \#vs)  \\
{\texttt{{[08][09]}}}: The 'species' selector  \\
{\texttt{{[0a][0b]}}}: The 'superClass' selector  \\
{\texttt{{[0c][0d]}}}: The '--info--' selector  \\
{\texttt{{[0e][0f]}}}: The 'name' selector (object/class name)  \\
{\texttt{{[10].\dbz{}.\dbz{}.\dbz{}}}}: (\#vs-4) more variable selectors  \\
{\texttt{{[08+\dbz{} \#vs*2][09+\dbz{} \#vs*2]}}}: Selector ID of the first varselector (0)  \\
{\texttt{{[0a+\dbz{} \#vs*2].\dbz{}.\dbz{}.\dbz{}}}}: Selector ID of the second etc. varselectors  \\
{\texttt{{[08+\dbz{} \#vs*4][09+\dbz{} \#vs*4]}}}: Number of function selectors (\#fs)  \\
{\texttt{{[0a+\dbz{} \#vs*4].\dbz{}.\dbz{}.\dbz{}}}}: Function selector code pointers  \\
{\texttt{{[08+\dbz{} \#vs*4 +\dbz{} \#fs*2][09+\dbz{} \#vs*4 +\dbz{} \#fs*2]}}}: 0  \\
{\texttt{{[0a+\dbz{} \#vs*4 +\dbz{} \#fs*2].\dbz{}.\dbz{}.\dbz{}}}}: Selector ID of the first etc. funcselectors  \\
\end{tabular}

 Simply put, they look like objects with each selector section followed by a list of selector IDs.
\subsubsection{Export segments}
\label{id2500108}\hypertarget{id2500108}{}%

External symbols are contained herein, the number of which is described by the first (16 bit LE) value in the segment. All the values that follow point to addresses that the program counter will jump to when a {\texttt{{calle}}} operation is invoked. An exception is script 0, entry 0, which points to the first object whose 'play' method should be invoked during startup (a magical entry point like C's 'main())' function).
\subsubsection{Relocation tables}
\label{id2500130}\hypertarget{id2500130}{}%

This section contains script-relative pointers pointing to pointers inside the script. These refer to script-relative addresses and need to be relocated when the script is loaded to the heap; this is done by adding the offset of the first byte of the script on the heap to each of the values referenced in this section \label{id2500142}\begingroup\catcode`\#=12\footnote{
Thanks to Francois Boyer for this information
}\endgroup\docbooktolatexmakefootnoteref{id2500142}.

The section itself starts with a 16 bit LE value containing the number of pointers that follow, with each of the script-relative 16 bit pointers beyond having semantics as described above
\subsubsection{The Preload Text flag}
\label{id2500155}\hypertarget{id2500155}{}%

This is an actual script section, although it is always of size 4 (i.e. only consists of the script header). It is only checked for presence; if {\texttt{{script.\dbz{}x}}} is loaded and contains this section, the {\texttt{{text.\dbz{}x}}} resource is also loaded implicitly along with it \label{id2500178}\begingroup\catcode`\#=12\footnote{
This is ignored by FreeSCI ATM, since all resources are present in memory all the time.
}\endgroup\docbooktolatexmakefootnoteref{id2500178}
\subsubsection{Local variable segments}
\label{id2500186}\hypertarget{id2500186}{}%

This section contains the script's local variable segment, which consists of a sequence of 16 bit little-endian values.
\subsection{Selectors}
\label{id2500198}\hypertarget{id2500198}{}%

Selectors are very important in SCI. They can be either methods or object/class-relative variables, and this makes the interpretation of SCI operations like {\texttt{{send}}} a bit tricky.

Each class comes with two two-dimensional tables. The first table contains selector values and selector indices\label{id2500220}\begingroup\catcode`\#=12\footnote{
Those can be used as an index into vocab.997, where the selector names are stored as strings.
}\endgroup\docbooktolatexmakefootnoteref{id2500220} for each variable selector. The second table contains selector indices and script-relative method offsets. Objects look nearly identical, but they do not contain the list of selector indices for variable selectors, since those can be looked up at the class they were instantiated from (their "species", which happens to be one of the variable selectors).

Now, whenever a selector is sent for, the engine has to determine the right action to take. FreeSCI first determines whether the selector is a variable selector, by looking for it in the list of variable selector indices of the species class of the object that the "{\texttt{{send}}}" was sent to (classes use their own class number as their species class) \label{id2500247}\begingroup\catcode`\#=12\footnote{
In practice, send looks up the heap position of the requested class in a global class table.
}\endgroup\docbooktolatexmakefootnoteref{id2500247}. If it is, the selector value is either read (if no parameter was provided to the {\texttt{{send}}} call) or set (if one parameter was provided). If the selector was not part of the variable selectors of the specified object, the object's methods are checked for this selector index. If they don't contain the selector index, either, then FreeSCI recurses into checking the method selectors of the object's superclasses. If it finds the selector value there, it calls the heap address corresponding to the selector index.
\subsection{Function invocation}
\label{id2500270}\hypertarget{id2500270}{}%

SCI provides three distinct ways for invocating a function\label{id2500279}\begingroup\catcode`\#=12\footnote{
Of course, "manual" invocation (using push and jump operations) could also be used, but there are no special provisions for it, and it does not appear to be used in the existing SCI bytecode.
}\endgroup\docbooktolatexmakefootnoteref{id2500279}: 

\begin{tabular}{l}
Calling exported functions ({\texttt{{calle}}}, {\texttt{{callb}}})  \\
Calling selector methods ({\texttt{{send}}}, {\texttt{{self}}}, {\texttt{{super}}})  \\
Calling PC-relative addresses ({\texttt{{call}}})  \\
\end{tabular}


Exported functions are called by providing a script number and an exported function number (which is then looked up in the script's Type 7 block). They use the object they were called from to look up local variables and selectors for {\texttt{{self}}} and {\texttt{{super}}}.

Selector methods are called by providing an object and a selector index. The selector index gets looked up in the object's selector tables, and, if it is used for a method, this method gets invocated. The provided object is used for local references.

PC-relative calls only make sense inside scripts, since they jump to a position relative to the {\texttt{{call}}} opcode. The calling object is used for local references.
\subsection{Variable types}
\label{id2500378}\hypertarget{id2500378}{}%

SCI bytecode can address four types of variables (not counting the variable selectors). Those variable types are: 
\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Local variables}]\null{}
These are the variables stored in Type 10 script blocks. They are shared between the objects and classes of each script.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Global variables}]\null{}
These variables are the local variables of script 0.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Temporary variables}]\null{}
Those variables are stored on the stack. They are relative to the stack frame of the current method, so space for them must be allocated before they can be used. This is commonly done by using the {\texttt{{link}}} operation.
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Parameters}]\null{}
Parameters are stored on the stack below the current stack frame, as they technically belong to the calling function. They can be modified, if neccessary. \label{id2500450}\begingroup\catcode`\#=12\footnote{
Obviously, SCI uses a call-by-value model for primitives and call-by-reference for objects
}\endgroup\docbooktolatexmakefootnoteref{id2500450}
\end{description}
\noindent 

% ------------------------   
% Section 
\section{Interpreter initialization and the main execution loop}
\label{LSExecLoop}\hypertarget{LSExecLoop}{}%

By Lars Skovlund Version 1.0, 7. July 1999

When the interpreter initializes, it sets up a timer for 60 hertz (one that "ticks" 60 times per second). This timer does two things: it lets the so-called servers execute (most notably, the sound player and input manager) and it "feeds" the internal game clock. This 60 hz. "systick" is used all over the place. For example, it is accessible using the KGetTime kernel function. Some graphic effects depend on it, for example the "shake screen" effect. In SCI1, it is also used for timing in the palette fades. And naturally, it is used in the KWait kernel call.

Basically, the initialization proceeds as follows: 

\begin{enumerate}
\item Initialize the heap and hunk
\item Parse the config file and the command line
\item Load the drivers specified in the config file
\item Initialize the graphics subsystem.
\item Initialize the event manager
\item Initialize the window manager
\item Initialize the text parser (i.e. load the vocabulary files)
\item Initialize the music player
\item Save the machine state for restarting the game later on \label{id2500537}\begingroup\catcode`\#=12\footnote{
This is quite interesting, the KRestartGame kernel call is implemented using a simple setjmp/longjmp pair.
}\endgroup\docbooktolatexmakefootnoteref{id2500537}
\item Allocate the PMachine stack on the heap.
\item Get a pointer to the game object
\item And run, by executing the play or replay method.
\end{enumerate}


The right game object is found by looking in the "dispatch table" of script 0. The dispatch table has block type 7, and is an array of words. The first entry is a pointer (script relative) to the game object, for instance SQ3. If the game was restarted, the interpreter executes the replay method, play otherwise.

After looking up the address of the method in the object block, execution is started. It can be viewed as a huge switch statement, which executes con- tinuously. When the last ret statement (in the play or replay method) is met, the interpreter terminates.

The ExecuteCode function, which contains the mentioned switch statement, is called recursively. It lets other subroutines handle the object complexity, all the ExecuteCode function has is a pointer to the next in- struction. Thus, it is easy to terminate the interpreter; just return from all running instances of ExecuteCode.

So, how does an SCI program execute? Well, the play method is defined in the Game class, and it is never overridden. It consists of a huge loop which calls Game::doit continuously, followed by a pause according to the selected animation speed. That is, the script, not the interpreter, handles animation speed. Notice how the debugger very often shows the statement sag \$12 upon entering the debugger? This instruction resides in Game::play, and the break occurs here because of a KWait kernel call which is executed right before that instruction. This wait takes the most execution time, so therefore the debug break is most likely to be A game programmer would then override Game::doit and place the game specific main loop here (still, Game::doit is almost identical from game to game). Execution of the Game::play main loop stops when an event causes global variable 4 to be non-zero. The last ret instruction is met, and the interpreter terminates.

% ------------------------   
% Section 
\section{The SCI Heap}
\label{id2500598}\hypertarget{id2500598}{}%

SCI0 (and probably SCI1 as well) uses a heap consisting of 0xffff bytes of memory; this size corresponds to the size of one i386 real-mode memory segment minus one. \label{id2500609}\begingroup\catcode`\#=12\footnote{
This appears to be the maximum size; the games generally require less heap space.
}\endgroup\docbooktolatexmakefootnoteref{id2500609}
\subsection{Heap structure}
\label{id2500617}\hypertarget{id2500617}{}%

The original heap starts with 200 separate entries with a size of four bytes. Each of those entries appears to be a pointer to "hunk" memory, which is separate from the heap and not covered here. The actual heap base pointer points to the first byte that is not part of these pointers.
\subsection{Memory handles}
\label{id2500633}\hypertarget{id2500633}{}%

A memory handle consists of two consecutive unsigned 16 bit integers: 
\begin{itemize}
%--- Item
\item 
The memory block size


%--- Item
\item 
The heap address of the next memory handle

\end{itemize}
\noindent  in this sequence.

Memory handles are stored inside of the heap; they delimit the holes in the heap by indexing each other, with the exception of the last handle, which points to zero.
\subsection{Initialization}
\label{id2500663}\hypertarget{id2500663}{}%

The list is initialized to 0. Memory handle \#0 is set to contain 0xffff minus the size required by the memory handles (800 bytes) to a total of 0xfcdf, the pointer to the next free index is set to 0x0.
\subsection{Memory allocation}
\label{id2500677}\hypertarget{id2500677}{}%

The memory allocation function takes one parameter; this is the requested allocation block size. If it is 0, the function aborts. Otherwise, the size is increased by 2 (and then again by 1, if it is odd, for alignment purposes).

After the memory allocation algorithm finds a sufficiently large memory hole, it allocates its memory by splitting the memory hole and allocating the lower part (or by swallowing the upper part if its size would be less than four). It adjusts the previous memory handle (which used to point to the start of the now allocated part of the heap) to point to the next hole, and then goes on to write its size to the first two bytes of its newly allocated home.

If no sufficiently large memory hole can be found, the function returns 0; otherwise, it returns a heap pointer to the start of the allocated block (i.e. to the two bytes that carry the block's size).

Memory deallocation does this process in reverse; it also merges adjacent memory holes to prevent memory fragmentation.

% ------------------------   
% Section 
\section{The Sierra PMachine}
\label{VM}\hypertarget{VM}{}%

Lars Skovlund, Dark Minister and Christoph Reichenbach

Version 1.0, 6. July 1999

This document describes thee design of the Sierra PMachine (the virtual CPU used for executing SCI programs). It is a special CPU, in the sense that it is designed for object oriented programs.

There are three kinds of memory in SCI: Variables, objects, and stack space. The stack space is used in a Last-In-First-Out manner, and is primarily used for temporary space in a routine, as well as passing data from one routine to another. Note that the stack space is used bottom-up by the original in- terpreter, instead of the more usual top-down. I don't know if this has any significance for us.

Scripts are loaded into the PMachine by creating a memory imagee of it on the heap. For this reason, the script file format may seem a bit obscure at times. It is optimized for in-memory performance, not readability. It should be mentioned here that a lot of fixup stuff is done by the interpreter. In the script files, all addresses are specified as script-relative. These are converted to absolute offsets. The species and superClass fields of all objects are converted into pointers to the actual class etc.

There are four types of variables. These are called global, local, temporary, and parameter. All four types are simple arrays of 16-bit words. A pointer is kept for each type, pointing to the list that is currently active. In fact, only the global variable list is constant in memory. The other pointers are changed frequently, as scripts are loaded/unloaded, routines called, etc. The variables are always referenced as an index into the variable list. I'll explain the four types below - the names in parantheses will be used occasionally in the rest of the text:
\subsection{Local variables (LocalVar)}
\label{id2500796}\hypertarget{id2500796}{}%

This variable type is called "local" because it belongs to a specific script. Each script may have its own set of local variables, defined by script block type 10. As long as the code from a specific script is running, the local variables for that script are "active" (pointed to by the mentioned pointer).
\subsection{Global variables}
\label{id2500809}\hypertarget{id2500809}{}%

These, like the local variables, reside in script space (in fact, they are the local variables of script 0!). But the pointer to them remains constant for the whole duration of the program.
\subsection{Temporary variables}
\label{id2500820}\hypertarget{id2500820}{}%

These are allocated by specific subroutines in a script. They reside on the PMachine stack and are allocated by the link opcode. The temp variables are automatically discarded when the subroutine returns.
\subsection{Parameter variables}
\label{id2500832}\hypertarget{id2500832}{}%

These variables also reside on the stack. They contain information passed from one routine to another. Any routine in SCI is capable of taking a variable number of parameters, if need be. This is possible because a list size is pushed as the first thing before calling a routine. In addition to this, a frame size is passed to the call* functions.
\subsection{Objects}
\label{id2500846}\hypertarget{id2500846}{}%

While two adjacent variables may be entirely unrelated, the contents of an object is always related to one task. The object, like the variable tables, provides storage space. This storage space is called properties. Depending on the instructions used, a property can be referred to by index into the object structure, or by property IDs (PIDs). For instance, the name property has the PID 17h, but the offset 6. The property IDs are assigned by the SCI compiler, and it is the "compatible" way of accessing object data. Whereas the offset method is used only internally by an object to access its own data, the PID method is used externally by objects to read/write the data fields of other objects. The PID method is also used to call methods in an object, either by the object itself, by another object, or by the SCI inter- preter. Yes, this really happens sometimes.
\subsection{The PMachine ``registers''}
\label{id2500868}\hypertarget{id2500868}{}%

The PMachine can be said to have a number of registers, although none of them can be accessed explicitly by script code. They are used/changed implicitly by the script opcodes: 

\begin{tabular}{lp{13cm}}
Acc & the accumulator. Used for result storage and input for a number of opcodes.  \\
IP & the instruction pointer.\label{id2500890}\begingroup\catcode`\#=12\footnote{
FreeSCI calls this the "Program Counter" or PC, which is the more general term.
}\endgroup\docbooktolatexmakefootnoteref{id2500890} Points to the currently executing instruction  \\
Vars & an array of 4 values, pointing to the current variables of each mentioned type  \\
Object & points to the currently executing object.  \\
SP & the current stack pointer. Note that the stack in the original SCI interpreter is used bottom-up instead of the more usual top-down.  \\
\end{tabular}


The PMachine, apart from the actual instruction pointer, keeps a record of which object is currently executing.
\subsection{The instruction set}
\label{id2500919}\hypertarget{id2500919}{}%

The PMachine CPU potentially has 128 instructions (however, a couple of these are invalid and generate an error). Some of these instructions have a flag which specify whether the opcode has byte- or word-sized operands (I will refer to this as variably-sized parameters, as opposed to constant parameters). Other instructions have only one calling form. These instructions simply disregard the operand size flag. Ideally, however, all script instructions should be prepared to take variably-sized operands. Yet another group of instructions take both a constant parameter and a variably-sized parameter. The format of an opcode byte is as follows: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2500936}\hypertarget{id2500936}{}%

\begin{tabular}{|c|c|}
\hline 
{{bit 7-1}} & {{opcode number}} \tabularnewline
 \hline 
{{bit 0}} & {{operand size flag}} \tabularnewline
\hline 
\end{tabular}
\end{center}


\subsubsection{Relative addresses}
\label{id2500968}\hypertarget{id2500968}{}%

Certain instructions (in particular, branching ones) take relative addresses as a parameter. The actual address is calculated based on the instruction after the branching instruction itself. In this example, the bnt instruction, if the branch is made, jumps over the ldi instruction. 
\begin{Verbatim}[]

    eq?
    bnt +2
    ldi byte 2
    push

\end{Verbatim}
 
Relative addresses are signed values.


\subsubsection{Dispatch addresses}
\label{id2500993}\hypertarget{id2500993}{}%

The callb and calle instructions take a so-called dispatch index as a parameter. This index is used to look up an actual script address, using the so-called dispatch table. The dispatch table is located in script block type 7 in the script file. It is a series of words - the first one, as in so many other places in the script file, is the number of entries.
\subsubsection{Frame sizes}
\label{id2501007}\hypertarget{id2501007}{}%

In every call instruction, a value is included which determines the size of the parameter list, as an offset into the stack. This value discounts the list size pushed by the SCI code. For instance, consider this example from real SCI code: 
\begin{Verbatim}[]

     pushi 3 ; three parameters passed
     pushi 4 ; the screen flag
     pTos x ; push the x property
     pTos y ; push the y property
     callk OnControl, 6

\end{Verbatim}
 Notice that, although the callk line specifies 6 bytes of parameters, the kernel routine has access to the list size (which is at offset 8)!
\subsubsection{PErrors}
\label{id2501030}\hypertarget{id2501030}{}%

These are internal errors in the interpreter. They are usually caused by buggy script code. The PErrors end up displaying an "Oops!" box in the original interpreter (it is interesting to see how Sierra likes to believe that PErrors are caused by the user - judging by the message "You did something we weren't expecting"!). In the original interpreter, specifying -d on the command line causes it to give more detailed information about PErrors, as well as activating the internal debugger if one occurs.
\subsubsection{Class numbers and adresses}
\label{id2501046}\hypertarget{id2501046}{}%

The key to finding a specific class lies in the class table. This class table resides in VOCAB.996, and contains the numbers of scripts that carry classes. If a script has more than one class defintion, the script number is repeated as necessary. Notice how each script number is followed by a zero word? When the interpreter loads a script, it checks to see if the script has classes. If it does, a pointer to the object structure is put in this empty space.
\subsubsection{The instructions}
\label{id2501062}\hypertarget{id2501062}{}%

The instructions are described below. I have used Dark Minister's text on the subject as a starting point, but many things have changed; stuff explained more thoroughly, errors corrected, etc. The first 23 instructions (up to, but not including, bt) take no parameters.

These functions are used in the pseudocode explanations: 

\begin{tabular}{l}
pop(): sp -= 2; return *sp;  \\
push(x): *sp = x; sp += 2; return x;  \\
\end{tabular}

 The following rules apply to opcodes: 

\begin{enumerate}
\item Parameters are signed, unless stated otherwise. Sign extension is performed.
\item Jumps are relative to the posisition of the next operation.
\item *TOS refers to the TOS (Top Of Stack) element.
\item "tmp" refers to a temporary register that is used for explanation purposes only.
\end{enumerate}


\begin{itemize}
%--- Item
\item 

\begin{tabular}{l}
op 0x00: bnot (1 byte)  \\
op 0x01: bnot (1 byte)  \\
\end{tabular}

 Binary not: 
\begin{Verbatim}[]
acc ^= 0xffff;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x02: add (1 byte)  \\
op 0x03: add (1 byte)  \\
\end{tabular}

 Addition: 
\begin{Verbatim}[]
acc += pop();
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x04: sub (1 byte)  \\
op 0x05: sub (1 byte)  \\
\end{tabular}

 Subtraction: 
\begin{Verbatim}[]
acc = pop() - acc;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x06: mul (1 byte)  \\
op 0x07: mul (1 byte)  \\
\end{tabular}

 Multiplication: 
\begin{Verbatim}[]
acc *= pop();
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x08: div (1 byte)  \\
op 0x09: div (1 byte)  \\
\end{tabular}

 Division: 
\begin{Verbatim}[]
acc = pop() / acc;
\end{Verbatim}
 Division by zero is caught =\textgreater{} acc = 0.


%--- Item
\item 

\begin{tabular}{l}

op 0x0a: mod (1 byte)  \\
op 0x0b: mod (1 byte)  \\
\end{tabular}

 Modulo: 
\begin{Verbatim}[]
acc = pop() % acc;
\end{Verbatim}
 Modulo by zero is caught =\textgreater{} acc = 0.


%--- Item
\item 

\begin{tabular}{l}

op 0x0c: shr (1 byte)  \\
op 0x0d: shr (1 byte)  \\
\end{tabular}

 Shift Right logical: 
\begin{Verbatim}[]
acc = pop() >> acc;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x0e: shl (1 byte)  \\
op 0x0f: shl (1 byte)  \\
\end{tabular}

 Shift Left logical: 
\begin{Verbatim}[]
acc = pop() << acc;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x10: xor (1 byte)  \\
op 0x11: xor (1 byte)  \\
\end{tabular}

 Exclusive or: 
\begin{Verbatim}[]
acc ^= pop();
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x12: and (1 byte)  \\
op 0x13: and (1 byte)  \\
\end{tabular}

 Logical and: 
\begin{Verbatim}[]
acc &= pop();
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x14: or (1 byte)  \\
op 0x15: or (1 byte)  \\
\end{tabular}

 Logical or: 
\begin{Verbatim}[]
acc |= pop();
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x16: neg (1 byte)  \\
op 0x17: neg (1 byte)  \\
\end{tabular}

 Sign negation: 
\begin{Verbatim}[]
acc = -acc;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x18: not (1 byte)  \\
op 0x19: not (1 byte)  \\
\end{tabular}

 Boolean not: 
\begin{Verbatim}[]
acc = !acc;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x1a: eq? (1 byte)  \\
op 0x1b: eq? (1 byte)  \\
\end{tabular}

 Equals?: 
\begin{Verbatim}[]
prev = acc;
acc = (acc == pop());
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x1c: ne? (1 byte)  \\
op 0x1d: ne? (1 byte)  \\
\end{tabular}

 Is not equal to? 
\begin{Verbatim}[]
prev = acc;
acc = !(acc == pop());
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x1e: gt? (1 byte)  \\
op 0x1f: gt? (1 byte)  \\
\end{tabular}

 Greater than? 
\begin{Verbatim}[]
prev = acc;
acc = (pop() > acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x20: ge? (1 byte)  \\
op 0x21: ge? (1 byte)  \\
\end{tabular}

 Greater than or equal to? 
\begin{Verbatim}[]
prev = acc;
acc = (pop() >= acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x22: lt? (1 byte)  \\
op 0x23: lt? (1 byte)  \\
\end{tabular}

 Less than? 
\begin{Verbatim}[]
prev = acc;
acc = (pop() < acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x24: le? (1 byte)  \\
op 0x25: le? (1 byte)  \\
\end{tabular}

 Less than or equal to? 
\begin{Verbatim}[]
prev = acc;
acc = (pop() <= acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x26: ugt? (1 byte)  \\
op 0x27: ugt? (1 byte)  \\
\end{tabular}

 Unsigned: Greater than? 
\begin{Verbatim}[]
acc = (pop() > acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x28: uge? (1 byte)  \\
op 0x29: uge? (1 byte)  \\
\end{tabular}

 Unsigned: Greather than or equal to? 
\begin{Verbatim}[]
acc = (pop() >= acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x2a: ult? (1 byte)  \\
op 0x2b: ult? (1 byte)  \\
\end{tabular}

 Unsigned: Less than? 
\begin{Verbatim}[]
acc = (pop() < acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x2c: ule? (1 byte)  \\
op 0x2d: ule? (1 byte)  \\
\end{tabular}

 Unsigned: Less than or equal to? 
\begin{Verbatim}[]
acc = (pop() >= acc);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x2e: bt W relpos (3 bytes)  \\
op 0x2f: bt B relpos (2 bytes)  \\
\end{tabular}

 Branch relative if true 
\begin{Verbatim}[]
if (acc) pc += relpos;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x30: bnt W relpos (3 bytes)  \\
op 0x31: bnt B relpos (2 bytes)  \\
\end{tabular}

 Branch relative if not true 
\begin{Verbatim}[]
if (!acc) pc += relpos;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x32: jmp W relpos (3 bytes)  \\
op 0x33: jmp B relpos (2 bytes)  \\
\end{tabular}

 Jump 
\begin{Verbatim}[]
pc += relpos;
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x34: ldi W data (3 bytes)  \\
op 0x35: ldi B data (2 bytes)  \\
\end{tabular}

 Load data immediate 
\begin{Verbatim}[]
acc = data;
\end{Verbatim}
 Sign extension is done for 0x35 if required.


%--- Item
\item 

\begin{tabular}{l}

op 0x36: push (1 byte)  \\
op 0x37: push (1 byte)  \\
\end{tabular}

 Push to stack 
\begin{Verbatim}[]
push(acc)
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x38: pushi W data (3 bytes)  \\
op 0x39: pushi B data (2 bytes)  \\
\end{tabular}

 Push immediate 
\begin{Verbatim}[]
push(data)
\end{Verbatim}
 Sign extension for 0x39 is performed where required.


%--- Item
\item 

\begin{tabular}{l}

op 0x3a: toss (1 byte)  \\
op 0x3b: toss (1 byte)  \\
\end{tabular}

 TOS subtract 
\begin{Verbatim}[]
pop();
\end{Verbatim}
 For confirmation: Yes, this simply tosses the TOS value away.


%--- Item
\item 

\begin{tabular}{l}

op 0x3c: dup (1 byte)  \\
op 0x3d: dup (1 byte)  \\
\end{tabular}

 Duplicate TOS element 
\begin{Verbatim}[]
push(*TOS);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x3e: link W size (3 bytes)  \\
op 0x3f: link B size (2 bytes)  \\
\end{tabular}
 
\begin{Verbatim}[]
sp += (size * 2);
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x40: call W relpos, B framesize (4 bytes)  \\
op 0x41: call B relpos, B framesize (3 bytes)  \\
\end{tabular}

 Call inside script. 
\begin{Verbatim}[]
(See description below)
sp -= (framesize + 2 + &rest_modifier);
&rest_modifier = 0;
\end{Verbatim}
 This calls a script subroutine at the relative position {\ttfamily\itshape{{relpos}}}, setting up the ParmVar pointer first. ParmVar points to sp-{\ttfamily\itshape{{framesize}}} (but see also the \&rest operation). The number of parameters is stored at word offset -1 relative to ParmVar.


%--- Item
\item 

\begin{tabular}{l}

op 0x42: callk W kfunct, B kparams (4 bytes)  \\
op 0x43: callk B kfunct, B kparams (3 bytes)  \\
\end{tabular}

 Call kernel function (see \hyperlink{Kfunctions}{Section~{\ref{Kfunctions}}}) 
\begin{Verbatim}[]
sp -= (kparams + 2 + &rest_modifier);
&rest_modifier = 0;
(call kernel function kfunct)
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x44: callb W dispindex, B framesize (4 bytes)  \\
op 0x45: callb B dispindex, B framesize (3 bytes)  \\
\end{tabular}

 Call base script 
\begin{Verbatim}[]
(See description below)
sp -= (framesize + 2 + &rest_modifier);
&rest_modifier = 0;
\end{Verbatim}
 This operation starts a new execution loop at the beginning of script 0, public method {\ttfamily\itshape{{dispindex}}} (Each script comes with a dispatcher list (type 7) that identifies public methods). Parameters are handled as in the call operation.


%--- Item
\item 

\begin{tabular}{l}

op 0x46: calle W script, W dispindex, B framesize (5 bytes)  \\
op 0x47: calle B script, B dispindex, B framesize (4 bytes)  \\
\end{tabular}

 Call external script 
\begin{Verbatim}[]
(See description below)
sp -= (framesize + 2 + &rest_modifier);
&rest_modifier = 0;
\end{Verbatim}
 This operation performs a function call (implicitly placing the current program counter on the execution stack) to an ``external'' procedure of
a script. More precisely, exported procedure \texttt {dispindex} of script \texttt{script} is invoked, where \texttt{dispindex} is an offset into
the script's Exports list (i.e., $\texttt{dispindex} = n * 2$ references the $n$th exported procedure).

The ``Exports list'' is defined in the script's type 7 object (cf. section \ref{id2499584}). It is an error to invoke a script which does not exist or which does not provide
an Exports list, or to use a dispatch index which does not point into an even address within the Exports list.

%--- Item
\item 

\begin{tabular}{l}

op 0x48: ret (1 byte)  \\
op 0x49: ret (1 byte)  \\
\end{tabular}

 Return: returns from an execution loop started by call, calle, callb, send, self or super.


%--- Item
\item 

\begin{tabular}{l}

op 0x4a: send B framesize (2 bytes)  \\
op 0x4b: send B framesize (2 bytes)  \\
\end{tabular}

 Send for one or more selectors. This is the most complex SCI operation (together with self and class).

Send looks up the supplied selector(s) in the object pointed to by the accumulator. If the selector is a variable selector, it is read (to the accumulator) if it was sent for with zero parameters. If a parameter was supplied, this selector is set to that parameter. Method selectors are called with the specified parameters.

The selector(s) and parameters are retreived from the stack frame. Send first looks up the selector ID at the bottom of the frame, then retreives the number of parameters, and, eventually, the parameters themselves. This algorithm is iterated until all of the stack frame has been "used up". Example: 
\begin{Verbatim}[]
; This is an example for usage of the SCI send operation
   pushi x      ; push the selector ID of x
   push1        ; 1 parameter: x is supposed to be set
   pushi 42     ; That's the value x will get set to
   pushi moveTo ; In this example, moveTo is a method selector.
   push2        ; It will get called with two parameters-
   push         ; The accumulator...
   lofss 17     ; ...and PC-relative address 17.
   pushi foo    ; Let's assume that foo is another variable selector.
   push0        ; This will read foo and return the value in acc.
   send 12      ; This operation does three quite different things.
            
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x4c  \\
op 0x4d  \\
op 0x4e  \\
op 0x4f  \\
\end{tabular}

 These opcodes don't exist in SCI.


%--- Item
\item 

\begin{tabular}{l}

op 0x50: class W function (3 bytes)  \\
op 0x51: class B function (2 bytes)  \\
\end{tabular}

 Get class address. Sets the accumulator to the memory address of the specified {\ttfamily\itshape{{function}}} of the current object.


%--- Item
\item 

\begin{tabular}{l}

op 0x52  \\
op 0x53  \\
\end{tabular}

 These opcodes don't exist in SCI.


%--- Item
\item 

\begin{tabular}{l}

op 0x54: self B stackframe (2 bytes)  \\
op 0x55: self B stackframe (2 bytes)  \\
\end{tabular}

 Send to self. This operation is the same as the send operation, except that it sends to the current object instead of the object pointed to by the accumulator.


%--- Item
\item 

\begin{tabular}{l}

op 0x56: super W class, B stackframe (4 bytes)  \\
op 0x57: super B class, B stackframe (3 bytes)  \\
\end{tabular}

 Send to any class. This operation is the same as the send operation, except that it sends to an arbitrary {\ttfamily\itshape{{class}}}.


%--- Item
\item 

\begin{tabular}{l}

op 0x58: \&rest W paramindex (3 bytes)  \\
op 0x59: \&rest B paramindex (2 bytes)  \\
\end{tabular}

 Pushes all or part of the ParmVar list on the stack. The number specifies the first parameter variable to be pushed. I'll give a small example. Suppose we have two functions:

function a(y,z) and function b(x,y,z)

function b wants to call function a with its own y and z parameters. Easy job, using the the normal lsp instruction. Now suppose that both function a and b are designed to take a variable number of parameters:

function a(y,z,...) and function b(x,y,z,...)

Since lsp does not support register indirection, we can't just push the variables in a loop (as we would in C). Instead this function is used. In this case, the instruction would be \&rest 2, since we want the copying to start from y (inclusive), the second parameter.

Note that the values are copied to the stack {\em{immediately}}. The {\texttt{{\&rest\_\dbz{}modifier}}} is set to the number of variables pushed afterwards.


%--- Item
\item 

\begin{tabular}{l}

op 0x5a: lea W type, W index ( bytes)  \\
op 0x5b: lea B type, B index ( bytes)  \\
\end{tabular}

 Load Effective Address

The variable type is a bit-field used as follows: 
\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{bit 0}]\null{}
unused
% \null and \mbox are tricks to induce different typesetting decisions
\item[{bit 1-2}]\null{}
the number of the variable list to use 
\begin{tabular}{l}

0 - globalVar  \\
2 - localVar  \\
4 - tempVar  \\
6 - parmVar  \\
\end{tabular}

% \null and \mbox are tricks to induce different typesetting decisions
\item[{bit 3}]\null{}
unused
% \null and \mbox are tricks to induce different typesetting decisions
\item[{bit 4}]\null{}
set if the accumulator is to be used as additional index
\end{description}
\noindent  Because it is so hard to explain, I have made a transcription of it here: 
\begin{Verbatim}[]


short *vars[4];

int acc;

int lea(int vt, int vi)
{
  return &((vars[(vt >> 1) &amp; 3])[vt &amp; 0x10 ? vi+acc : vi]);
}


\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x5c: selfID (1 bytes)  \\
op 0x5d: selfID (1 bytes)  \\
\end{tabular}

 Get 'self' identity: SCI uses heap pointers to identify objects, so this operation sets the accumulator to the address of the current object. 
\begin{Verbatim}[]
acc = object
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x5e  \\
op 0x5f  \\
\end{tabular}

 These opcodes don't exist in SCI.


%--- Item
\item 

\begin{tabular}{l}

op 0x60: pprev (1 bytes)  \\
op 0x61: pprev (1 bytes)  \\
\end{tabular}

 Push prev: Pushes the value of the prev register, set by the last comparison bytecode (eq?, lt?, etc.), on the stack. 
\begin{Verbatim}[]
push(prev)
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x62: pToa W offset (3 bytes)  \\
op 0x63: pToa B offset (2 bytes)  \\
\end{tabular}

 Property To Accumulator: Copies the value of the specified property (in the current object) to the accumulator. The property is specified as an offset into the object structure.


%--- Item
\item 

\begin{tabular}{l}

op 0x64: aTop W offset (3 bytes)  \\
op 0x65: aTop B offset (2 bytes)  \\
\end{tabular}

 Accumulator To Property: Copies the value of the accumulator into the specified property (in the current object). The property number is specified as an offset into the object structure.


%--- Item
\item 

\begin{tabular}{l}

op 0x66: pTos W offset (3 bytes)  \\
op 0x67: pTos B offset (2 bytes)  \\
\end{tabular}

 Property To Stack: Same as pToa, but pushes the property value on the stack instead.


%--- Item
\item 

\begin{tabular}{l}

op 0x68: sTop W offset (3 bytes)  \\
op 0x69: sTop B offset (2 bytes)  \\
\end{tabular}

 Stack To Property: Same as aTop, but gets the new property value from the stack instead.


%--- Item
\item 

\begin{tabular}{l}

op 0x6a: ipToa W offset (3 bytes)  \\
op 0x6b: ipToa B offset (2 bytes)  \\
\end{tabular}

 Incement Property and copy To Accumulator: Increments the value of the specified property of the current object and copies it into the accumulator. The property number is specified as an offset into the object structure.


%--- Item
\item 

\begin{tabular}{l}

op 0x6c: dpToa W offset (3 bytes)  \\
op 0x6d: dpToa B offset (2 bytes)  \\
\end{tabular}

 Decrepent Property and copy to Accumulator: Decrements the value of the specified property of the current object and copies it into the accumulator. The property number is specified as an offset into the object structure.


%--- Item
\item 

\begin{tabular}{l}

op 0x6e: ipTos W offset (3 bytes)  \\
op 0x6f: ipTos B offset (2 bytes)  \\
\end{tabular}

 Increment Property and push to Stack Same as ipToa, but pushes the result on the stack instead.


%--- Item
\item 

\begin{tabular}{l}

op 0x70: dpTos W offset (3 bytes)  \\
op 0x71: dpTos B offset (2 bytes)  \\
\end{tabular}

 Decrement Property and push to stack: Same as dpToa, but pushes the result on the stack instead.


%--- Item
\item 

\begin{tabular}{l}

op 0x72: lofsa W offset (3 bytes)  \\
op 0x73: lofsa B offset (2 bytes)  \\
\end{tabular}

 Load Offset to Accumulator: 
\begin{Verbatim}[]
acc = pc + offset
\end{Verbatim}
 Adds a value to the post-operation pc and stores the result in the accumulator.


%--- Item
\item 

\begin{tabular}{l}

op 0x74: lofss W offset (3 bytes)  \\
op 0x75: lofss B offset (2 bytes)  \\
\end{tabular}

 Load Offset to Stack: 
\begin{Verbatim}[]
push(pc + offset)
\end{Verbatim}
 Adds a value to the post-operation pc and pushes the result on the stack.


%--- Item
\item 

\begin{tabular}{l}

op 0x76: push0 (1 bytes)  \\
op 0x77: push0 (1 bytes)  \\
\end{tabular}

 Push 0: 
\begin{Verbatim}[]
push(0)
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x78: push1 (1 bytes)  \\
op 0x79: push1 (1 bytes)  \\
\end{tabular}

 Push 1: 
\begin{Verbatim}[]
push(1)
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x7a: push2 (1 bytes)  \\
op 0x7b: push2 (1 bytes)  \\
\end{tabular}

 Push 2: 
\begin{Verbatim}[]
push(2)
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x7c: pushSelf (1 bytes)  \\
op 0x7d: pushSelf (1 bytes)  \\
\end{tabular}

 Push self: 
\begin{Verbatim}[]
push(object)
\end{Verbatim}



%--- Item
\item 

\begin{tabular}{l}

op 0x7e  \\
op 0x7f  \\
\end{tabular}

 These operations don't exist in SCI.


%--- Item
\item 

\begin{tabular}{l}

op 0x80 - 0xfe: [ls+-][as][gltp]i? W index (3 bytes)  \\
op 0x81 - 0xff: [ls+-][as][gltp]i? B index (2 bytes)  \\
\end{tabular}

 The remaining SCI operations work on one of the four variable types. The variable index is retreived by taking the heap pointer for the specified variable type, adding the {\ttfamily\itshape{{index}}} and possibly the accumulator, and executing the operation according to the following table: 
\begin{description}
% \null and \mbox are tricks to induce different typesetting decisions
\item[{Bit 0}]\null{}
Used as with all other opcodes with variably-sized parameters: 
\begin{tabular}{l}

0: 16 bit parameter  \\
1: 8 bit parameter  \\
\end{tabular}


% \null and \mbox are tricks to induce different typesetting decisions
\item[{Bits 1,2}]\null{}
The type of variable to operate on: 

\begin{tabular}{l}
0: Global  \\
1: Local  \\
2: Temporary  \\
3: Parameter  \\
\end{tabular}

% \null and \mbox are tricks to induce different typesetting decisions
\item[{Bit 3}]\null{}
Whether to use the accumulator or the stack for operations: 

\begin{tabular}{l}
0: Accumulator  \\
1: Stack  \\
\end{tabular}

% \null and \mbox are tricks to induce different typesetting decisions
\item[{Bit 4}]\null{}
Whether to use the accumulator as a modifier to the supplied index: 

\begin{tabular}{l}
0: Don't use accumulator as an additional index  \\
1: Use the accumulator as an additional index  \\
\end{tabular}

% \null and \mbox are tricks to induce different typesetting decisions
\item[{Bits 5,6}]\null{}
The type of execution to perform: 

\begin{tabular}{l}
0: Load the variable to the accumulator or stack  \\
1: Store the accumulator or stack in the variable  \\
2: Increment the variable, then load it into acc or on the stack  \\
3: Decrement the variable, then load it into acc or on the stack  \\
\end{tabular}

% \null and \mbox are tricks to induce different typesetting decisions
\item[{Bit 7}]\null{}
Always 1 (identifier for these opcodes)
\end{description}
\noindent  Example: "sagi 2" would Store the Accumulator in the Global variable indexed with 2 plus the current accumulator value (this rarely makes sense, obviously). "+sp 6" would increment the parameter at offset 6 (the third parameter, not counting the argument counter), and push it on the stack.

\end{itemize}
\noindent 
% ------------------------   
% Section 
\section{Kernel functions}
\label{Kfunctions}\hypertarget{Kfunctions}{}%

(Acknowledgements for this section go to Lars Skovlund, Francois Boyer and Jeremy Tartaglia for providing additional information).


In SCI0, calls to the SCI kernel are initiated by using the {\texttt{{callk}}} opcode. {\texttt{{callk}}} has the opcode {\texttt{{0x42}}} or {\texttt{{0x43}}}; {\texttt{{0x42}}} takes one 16 bit little endian and one 8 bit paramter, {\texttt{{0x43}}} takes two 8 bit parameters. The first parameter is the number of the kernel function to be called, the second number undetermined (as of yet).

Opcode summary:


\begin{tabular}{l}

op 0x42: callk W kfunct, B kparams (4 bytes)  \\
op 0x43: callk B kfunct, B kparams (3 bytes)  \\
\end{tabular}


The number of parameters passed to the kernel function are determined by kparam. A total number of (kparams+2) bytes are removed from the local stack and passed on to the kernel function. The first two of those bytes are apparently always created by pushing the number of following bytes. For example, if Load(view, 10) is called, then we've got two word parameters, "view" (0x0080) and "10" (0x000a). So the callk function would have kparams set to 4; this value would be pushed to the stack first, followed by the two parameters. So the stack would look like this (left means lower address, byte ordering little endian):

{\texttt{{02 00 80 00 0a 00}}}

before calling Load().

Return values are returned into the accumulator, unless stated otherwise. If return type is stated as (void), then the accumulator is not modified.
\subsection{Parameter types}
\label{id2503161}\hypertarget{id2503161}{}%

SCI0 uses only little endian 16 bit integer values for parameters. However, this document distinguishes between different uses of those integers by defining the following variable types: 

\begin{tabular}{lp{12cm}}
(word)& 16 bit signed little endian integer  \\
(HeapPtr)& As (word); interpreted as a pointer to a heap address  \\
(DblList)& As (HeapPtr); interpreted as offset of a doubly linked list  \\
(Node)& As (HeapPtr); interpreted as offset of a list node  \\
(\&FarPtr)& As (HeapPtr); interpreted as the 32 bit pointer stored at the referenced heap address  \\
(Point)& A sequence of two (word)s to describe a point on the screen, with the y coordinate being the first in the sequence.  \\
(Rect)& A sequence of four (word)s describing a rectangle. If you read "(Rect) foo", think "(word) foo\_ymin, (word) foo\_xmin, (word) foo\_ymax, (word) foo\_xmax" instead.  \\
(String)& If greater than or equal to 1000, this is the heap address of a text string. If less than 1000, it is the number of a text resource, and immediately followed by another word that contains the number of the string inside the text resource.  \\
\end{tabular}


Parameters in brackets (like "[foo]") are optional.

Most functions exit gracefully if either a NULL HeapPtr or DblList is provided.
\subsection{SCI0 Kernel functions}
\label{id2504480}\hypertarget{id2504480}{}%
\subsubsection{Kernel function 0x00: Load(word, word)}
\label{id2504487}\hypertarget{id2504487}{}%
\label{id2504493}kfunct 0x00: Load();
        \newline
        word ResType, word ResNr;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{ResType}}}: The resource type number \docbooktolatexpipe{} 0x80 (as in the patch files)  \\
(word) {\ttfamily\itshape{{ResNr}}}: The resource number  \\
\end{tabular}


Returns: (\&FarPtr): A HeapPtr pointing to an actual pointer on the heap.

Loads a resource. The returned HeapPtr points to a special point on the heap where a pointer (32 bits) to the memory location of the specified resource is located. If the resource type equals sci\_memory, the resource number is interpreted as a memory size instead; the specified number of bytes is allocated dynamically, and a handle returned.
\subsubsection{Kernel function 0x01: UnLoad(word, word)}
\label{id2504521}\hypertarget{id2504521}{}%
\label{id2504527}kfunct 0x01: UnLoad();
        \newline
        word ResType, word ResNr;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{ResType}}}: The resource type number \docbooktolatexpipe{} 0x80  \\
(word) {\ttfamily\itshape{{ResNr}}}: The resource number  \\
\end{tabular}


Returns: (void)

This function unloads a resource identified by its ResType and ResNr, NOT by the HeapPtr it has been loaded to, except for sci\_memory resources, where the parameters are the memory resource type and the handle.
\subsubsection{Kernel function 0x02:ScriptID(word, word)}
\label{id2504576}\hypertarget{id2504576}{}%
\label{id2504582}kfunct 0x02: ScriptID();
        \newline
        word ScriptNr, word DispatchNr;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{ScriptNr}}}: Number of the script to reference  \\
(word) {\ttfamily\itshape{{DispatchNr}}}: Number of the Dispatch entry inside the script to reference  \\
\end{tabular}


Returns: (HeapPtr): The address pointed to by the specified element of the dispatch/exports table (script block type \#7)

This function returns the address pointed to by an element of a script's dispatch table.
\subsubsection{Kernel function 0x03: DisposeScript(word ScriptNumber)}
\label{id2504632}\hypertarget{id2504632}{}%
\label{id2504639}kfunct 0x03: DisposeScript();
        \newline
        word ScriptNumber;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{ScriptNumber}}}  \\
\end{tabular}


Returns: (void)

Disposes a script. Unloads it, removes its entries from the class table, and frees the associated heap memory.
\subsubsection{Kernel function 0x04: Clone(HeapPtr)}
\label{id2504675}\hypertarget{id2504675}{}%


\label{id2504681}kfunct 0x04:Clone();
        \newline
        HeapPtr object;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{object}}}: The object to clone  \\
\end{tabular}


Returns: (HeapPtr) The address of the clone

This function clones a Class or Object by copying it as a whole and mofifying the -info- selector so that it contains 1. Objects with -info- set to 0x8000 (Classes) are stripped of their selector name area, and both Objects and Classes are stripped of the function selector area.
\subsubsection{Kernel function 0x05: DisposeClone(HeapPtr)}
\label{id2504725}\hypertarget{id2504725}{}%


\label{id2504731}kfunct 0x05: DisposeClone();
        \newline
        HeapPtr clone;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{clone}}}: The clone to dispose  \\
\end{tabular}


Returns: (void)

Frees all memory associated with a cloned object (as produced by Clone()).
\subsubsection{Kernel function 0x06: IsObject(HeapPtr)}
\label{id2504767}\hypertarget{id2504767}{}%


\label{id2504773}kfunct 0x06: IsObject();
        \newline
        HeapPtr suspected\_object;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{suspected\_object}}}: The address of something that is suspected to be an object.  \\
\end{tabular}


Returns: (int) 1 if there is an object at the specified address, 0 if not.

This function checks whether the supplied heap pointer is valid and returns 0 if not, then proceeds to testing whether an object is at the indexed heap position. If it is, 1 is returned, 0 otherwise.
\subsubsection{Kernel function 0x07: RespondsTo(?)}
\label{id2504813}\hypertarget{id2504813}{}%


\subsubsection{Kernel function 0x08: DrawPic(word[, word, word, word])}
\label{KDrawPic}\hypertarget{KDrawPic}{}%
\label{id2504830}kfunct 0x08: DrawPic();
        \newline
        word PicNr[, word Animation, word Flags, word DefaultPalette];

\begin{tabular}{l}
(word) {\ttfamily\itshape{{PicNr}}}: The resource number of the picture to draw  \\
(word) {\ttfamily\itshape{{Animation}}}: One of the following animation modes: \\

\begin{tabular}{l}
-1: Display instantly  \\
0: horizontally open from center  \\
1: vertically open from center  \\
2: open from right  \\
3: open from left  \\
4: open from bottom  \\
5: open from top  \\
6: open from edges to center  \\
7: open from center to edges  \\
8: open random checkboard  \\
9: horizontally close to center, reopen from center  \\
10: vertically close to center, reopen from center  \\
11: close to right, reopen from right  \\
12: close to left, reopen from left  \\
13: close to bottom, reopen from bottom  \\
14: close to top, reopen from top  \\
15: close from center to edges, reopen from edges to center  \\
16: close from edges to center, reopen from center to edges  \\
17: close random checkboard, reopen  \\
\end{tabular}

 The animation is executed when kAnimate() (see \hyperlink{KAnimate}{Section~{\ref{KAnimate}}}) is invoked. If not specified, it is assumed to be the same animation as last time.  \\
(word) {\ttfamily\itshape{{Flags}}}:

\begin{tabular}{l}
Bit 0: Clear screen before drawing  \\
Bit 1-f: unknown, probably unused  \\
\end{tabular}

If not specified, it defaults to 1.

Some interpreter versions older than 0.000.502 interpret this parameter inversely, and have 0 as a default.

  \\
(word) {\ttfamily\itshape{{DefaultPalette}}}: The default palette number to use for drawing  \\
\end{tabular}


Returns: (void)

The second parameter does not appear to affect anything. In QfG1, it appears to be set to 0x64 constantly. DefaultPalette is used to differentiate between day and night in QfG1. Palette 1 is used for "night" pictures, Palette 0 for "day" pictures there. The picture is drawn to the background image (which is used for restauration of everything with the exception of the mouse pointer). To bring it to the foreground, Animate() must be used.
\subsubsection{Kernel function 0x09: Show()}
\label{id2505027}\hypertarget{id2505027}{}%
\label{id2505033}kfunct 0x09: Show();
        \newline
        ;
Returns: (void)

Sets the PicNotValid flag to 2.
\subsubsection{Kernel function 0x0a: PicNotValid([word])}
\label{id2505050}\hypertarget{id2505050}{}%
\label{id2505056}kfunct 0x0a: PicNotValid();
        \newline
        [(word) NewPicNotValid];

\begin{tabular}{l}
[(word) {\ttfamily\itshape{{NewPicNotValid}}}]: The new value of the "PicNotValid" flag.  \\
\end{tabular}


Returns: (word): The previous value of the "PicNotValid" flag

This sets the PicNotValid flag that determines whether or not the current background picture should be considered "valid" by the other kernel functions.
\subsubsection{Kernel function 0x0b: Animate([DblList], [word])}
\label{KAnimate}\hypertarget{KAnimate}{}%
\label{id2505106}kfunct 0x0b: Animate();
        \newline
        [DblList ViewList], [word cycle];

\begin{tabular}{l}
[(DblList) {\ttfamily\itshape{{ViewList}}}]: List of views that are to be drawn on top of the background picture  \\
(word) \textless{}unknown\textgreater{}  \\
\end{tabular}


Returns: (void)

This function draws a background picture plus some views to the foreground. If the background picture had not been drawn previously, it is animated with the animation style set during kDrawPic (see \hyperlink{KDrawPic}{Section~{\ref{KDrawPic}}}). Drawing the views is a rather complex issue. Refer to \hyperlink{LarsAnim}{Section~{\ref{LarsAnim}}} for its description.
\subsubsection{Kernel function 0x0c: SetNowSeen(DblList)}
\label{id2505164}\hypertarget{id2505164}{}%
\label{id2505171}?? kfunct 0x0c: SetNowSeen();
        \newline
        DblList ViewList;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{ViewList}}}: List of affected views  \\
\end{tabular}


Returns: (void)


\subsubsection{Kernel function 0x0d: NumLoops(HeapPtr)}
\label{id2505205}\hypertarget{id2505205}{}%


\label{id2505211}kfunct 0x0d: NumLoops();
        \newline
        HeapPtr object;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{object}}}: The object which the view selector should be taken from  \\
\end{tabular}


Returns: (word) The number of loops in the view

This function looks up the view selector in the specified object, loads the view resource associated with it, and checks for the number of animation loops in the view.
\subsubsection{Kernel function 0x0e: NumCels(HeapPtr)}
\label{id2505250}\hypertarget{id2505250}{}%


\label{id2505256}kfunct 0x0e: NumCels();
        \newline
        HeapPtr object;

\begin{tabular}{l}
HeapPtr {\ttfamily\itshape{{object}}}: The object which the selectors should be taken from  \\
\end{tabular}


Returns: (word) The number of cels in the loop

This function looks up one specific loop in a specific view (both are taken from selectors with the same name from the object pointed to by the parameter) and returns the number of cels (animation frames) in it.
\subsubsection{Kernel function 0x0f: CelWide(word view, word loop, word cel)}
\label{id2505295}\hypertarget{id2505295}{}%


\label{id2505301}kfunct 0x0f: CelWide();
        \newline
        word view, word loop, word cel;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{view}}}: The view we're searching in {\ttfamily\itshape{{loop}}}: The loop the cel is contained in {\ttfamily\itshape{{cel}}}: The cel we're interested in  \\
\end{tabular}


Returns: (word) The width of the cel identified by the tuple (view, loop, cel).


\subsubsection{Kernel function 0x0f: CelWide(word view, word loop, word cel)}
\label{id2505350}\hypertarget{id2505350}{}%


\label{id2505357}kfunct 0x10: CelHigh();
        \newline
        word view, word loop, word cel;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{view}}}: The view we're searching in {\ttfamily\itshape{{loop}}}: The loop the cel is contained in {\ttfamily\itshape{{cel}}}: The cel we're interested in  \\
\end{tabular}


Returns: (word) The height of the cel identified by the tuple (view, loop, cel).


\subsubsection{Kernel function 0x11: DrawCel(word, word, word, Point, word)}
\label{id2505405}\hypertarget{id2505405}{}%
\label{id2505411}kfunct 0x11: DrawCel();
        \newline
        word view, word loop, word cel, Point pos, word priority;

\begin{tabular}{l}
(word) view: Number of the view resource to display  \\
(word) loop: Number of the loop in the view resource to display  \\
(word) cel: Number of the cel inside the loop to display  \\
(Point) pos: Position the cel should be drawn to  \\
(word) priority: Priority to draw the cel with  \\
\end{tabular}


Returns: (void)

Explicitly draws a cel, specified by the complete tuple (view, loop, cel), to a specified position. Invalid loop/cel values are assumed to be 0.
\subsubsection{Kernel function 0x12: AddToPic(DblList)}
\label{id2505473}\hypertarget{id2505473}{}%


\label{id2505479}kfunct 0x12: AddToPic();
        \newline
        DblList picviews;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{picviews}}}: A doubly linked list of PicViews, i.e. objects that are drawn statically onto the background picture  \\
\end{tabular}


Returns: (void)

This function stores the list of PicViews for later use by the Animate() syscall. See \hyperlink{KAnimate}{Section~{\ref{KAnimate}}} for more details.
\subsubsection{Kernel function 0x13: NewWindow(Rect, HeapPtr, word, word, word, word)}
\label{KNewWindow}\hypertarget{KNewWindow}{}%
\label{id2505531}kfunct NewWindow();
        \newline
        Rect Boundaries, HeapPtr Title, word Flags, word Priority, word FGColor, word BGColor;

\begin{tabular}{l}
(Rect) {\ttfamily\itshape{{Boundaries}}}: The bounding rectangle of the window  \\
(HeapPtr) {\ttfamily\itshape{{Title}}}: A pointer to the window title  \\
(word) {\ttfamily\itshape{{Flags}}}:

\begin{tabular}{l}
bit 0 - transparency  \\
bit 1 - window does not have a frame  \\
bit 2 - the window has a title (starting 10 pixels above the minimum y position specified as the first element of {\ttfamily\itshape{{Boundaries}}})  \\
bit 3-6 - unused  \\
bit 7 - don't draw anything  \\
\end{tabular}
  \\
(word) {\ttfamily\itshape{{Priority}}}: The priority at which the window should be drawn, or -1 to force on-top drawing  \\
(word) {\ttfamily\itshape{{FGColor}}}: The foreground color for the window  \\
(word) {\ttfamily\itshape{{BGColor}}}: The background color  \\
\end{tabular}


Returns: (HeapPtr): The position of the window structure on the heap

This function creates a window (see also \hyperlink{LarsWindows}{Section~{\ref{LarsWindows}}}), sets this window as the active port, draws the window (if neccessary), and returns with the window's heap address.
\subsubsection{Kernel function 0x14: GetPort()}
\label{KGetPort}\hypertarget{KGetPort}{}%
\label{id2505676}kfunct 0x14: GetPort();
        \newline
        ;
Returns: (HeapPtr): A pointer to a record with the internal representation of the currently active port.

Returns a heap pointer to a port structure.
\subsubsection{Kernel function 0x15: SetPort()}
\label{KSetPort}\hypertarget{KSetPort}{}%
\label{id2505704}kfunct 0x15: SetPort();
        \newline
        HeapPtr NewPort;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{NewPort}}}: The new port to set  \\
\end{tabular}


Returns: (void)

This selects the new port which many kernel functions will draw to.

If 0 is passed, the window manager port is selected. The picture window is not accessible using this call. Only other kernel calls like KDrawPic may activate the picture window - and they always save the old port and restore it before they return.
\subsubsection{Kernel function 0x16: DisposeWindow(HeapPtr Window)}
\label{KDisposeWindow}\hypertarget{KDisposeWindow}{}%
\label{id2505756}kfunct 0x16: DisposeWindow();
        \newline
        HeapPtr Window;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{Window}}}: The heap address of the window to destroy  \\
\end{tabular}


Returns: (void)

Destroys a window and frees the associated heap structure.
\subsubsection{Kernel function 0x17: DrawControl(HeapPtr)}
\label{KDrawControl}\hypertarget{KDrawControl}{}%
\label{id2505801}kfunct 0x17: DrawControl();
        \newline
        HeapPtr Control;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{Control}}}: The heap address of the Control to draw  \\
\end{tabular}


Returns: (void)

This function draws a Control (see \hyperlink{LarsWindows}{Section~{\ref{LarsWindows}}} for details). Please note that the correct port must be selected beforehand.
\subsubsection{Kernel function 0x18: HiliteControl(HeapPtr)}
\label{KHiliteControl}\hypertarget{KHiliteControl}{}%
\label{id2505853}kfunct 0x18: HiliteControl();
        \newline
        HeapPtr Control;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{Control}}}: The control to highlight  \\
\end{tabular}


Returns: (void)

This function is used to highlight a control by drawing it with an inverted color scheme. It requires the correct port to be set beforehand. See \hyperlink{LarsWindows}{Section~{\ref{LarsWindows}}} for details on the windowing Control system.
\subsubsection{Kernel function 0x19: EditControl(HeapPtr)}
\label{KEditControl}\hypertarget{KEditControl}{}%
\label{id2505905}kfunct 0x19: EditControl();
        \newline
        HeapPtr Control, HeapPtr Event;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{Control}}}: A heap pointer to the Control to edit  \\
(HeapPtr) {\ttfamily\itshape{{Event}}}: The event to interpret  \\
\end{tabular}


Returns: (void)

This function will apply the event provided to edit a type 3 (Edit window) Control (see \hyperlink{LarsWindows}{Section~{\ref{LarsWindows}}} for a description of the control system). Normal keypresses are added to the area pointed to by Control::text, unless the total string length would be greater than Control::max. Cursor keys, backspace and a few other keys may be used to manipulate the control. In FreeSCI, some of the libreadline control keys can be used to edit and move the cursor as well. If it is called to edit a Control which is not of type 3, it returns without error. Please note that the correct port (usually the window which the Control was drawn in) must be selected beforehand.
\subsubsection{Kernel function 0x1a: TextSize(HeapPtr, HeapPtr, word[, word])}
\label{id2505970}\hypertarget{id2505970}{}%


\label{id2505977}kfunct 0x1a: TextSize();
        \newline
        HeapPtr dest, HeapPtr src, word font[, word maxwidth];

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{dest}}}: The destination to write the rectangle to  \\
(HeapPtr) {\ttfamily\itshape{{src}}}: A pointer to the string to analyze  \\
(word) {\ttfamily\itshape{{font}}}: The number of the font resource to use for this check  \\
(word) {\ttfamily\itshape{{maxwidth}}}: The maximum width to allow for the text (defaults to 192)  \\
\end{tabular}


Returns: (void)

This function calculates the width and height the specified text will require to be displayed with the specified font and the specified maximum width. The result will be written to the (you guessed it) specified destination on the heap. The result is a rectangle structure: The first four bytes equal to zero, the next word is the height, and the last word is the width.
\subsubsection{Kernel function 0x1b: Display(String, word...)}
\label{id2506057}\hypertarget{id2506057}{}%


\label{id2506064}kfunct 0x1b: Display();
        \newline
        String text, word commands...;

\begin{tabular}{l}
 (String) {\ttfamily\itshape{{text}}}: The text to work with  \\
(word) {\ttfamily\itshape{{commands...}}}: A sequence of commands with parameters: \\

\begin{tabular}{l}
100: 2 params, (X,Y) coord of where to write on the port.  \\
101: 1 param, -1, 0 or 1 (align right (-1), left (0) or center (1)  \\
102: 1 param, set the text color.  \\
103: 1 param, set the background color (-1 to draw text with transparent background)  \\
104: 1 param, set the "gray text" flag (1 to draw disabled items)  \\
105: 1 param, (resource number) set the font  \\
106: 1 param, set the width of the text (the text wraps to fit in that width)  \\
107: no param, set the "save under" flag, to save a copy of the pixels before writing the text (the handle to the saved pixels is returned)  \\
108: 1 param, (handle to stored pixels) restore under. With this command, the text and all other parameters are ignored.  \\
\end{tabular}
  \\
\end{tabular}


Returns: (void) or (\&FarPtr)(see above)

This function executes the specified commands, then draws the supplied text to the active port (unless command 108 was executed).
\subsubsection{Kernel function 0x1c: GetEvent(word, HeapPtr)}
\label{KGetEvent}\hypertarget{KGetEvent}{}%
\label{id2506169}kfunct 0x1c: GetEvent();
        \newline
        word Flags, HeapPtr Event;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{Flags}}}: A bitfield: 

\begin{tabular}{l}
bit 0 - 14: Bit mask for the events to be returned.  \\
bit 15: Disable joystick polling  \\
\end{tabular}
  \\
(HeapPtr) {\ttfamily\itshape{{Event}}}: An Object on the stack which the results are written to.  \\
\end{tabular}


Returns: (word): 0 if a null event was created, 1 otherwise.

This function fills an Event object with data from the event queue. The results are written to the "type", "message" and "modifiers" selectors. See \hyperlink{LarsEvents}{Section~{\ref{LarsEvents}}} for details.
\subsubsection{Kernel function 0x1d: GlobalToLocal(HeapPtr Event)}
\label{KGlobalToLocal}\hypertarget{KGlobalToLocal}{}%
\label{id2506259}kfunct 0x1d: GlobalToLocal();
        \newline
        HeapPtr Event;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{Event}}}: pointer to the Event object to convert  \\
\end{tabular}


Returns: (void)

This function converts a screen-relative event to a port-relative one, using the currently active port.
\subsubsection{Kernel function 0x1e: LocalToGlobal(HeapPtr Event)}
\label{KLocalToGlobal}\hypertarget{KLocalToGlobal}{}%
\label{id2506308}kfunct 0x1e: LocalToGlobal();
        \newline
        HeapPtr Event;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{Event}}}: pointer to the Event object to convert  \\
\end{tabular}


Returns: (void)

This function converts a port-relative event to a screen-relative one, using the currently active port.
\subsubsection{Kernel function 0x1f: MapKeyToDir(HeapPtr Event)}
\label{KMapKeyToDir}\hypertarget{KMapKeyToDir}{}%
\label{id2506356}kfunct 0x1f: MapKeyToDir();
        \newline
        HeapPtr Event;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{Event}}}: pointer to the Event object to convert  \\
\end{tabular}


Returns: (HeapPtr): A pointer to the converted object

This function converts a keyboard event to a movement event, if possible. Otherwise, the function returns without error. See \hyperlink{LarsEvents}{Section~{\ref{LarsEvents}}} for details.
\subsubsection{Kernel function 0x20: DrawMenuBar(word)}
\label{id2506403}\hypertarget{id2506403}{}%


\label{id2506410}kfunct 0x20: DrawMenuBar();
        \newline
        word mode;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{mode}}}: 1 to draw, 0 to clear  \\
\end{tabular}


Returns: (void)

Either draws or clears (overdraws with black) the menu bar.
\subsubsection{Kernel function 0x21: MenuSelect(HeapPtr[, word])}
\label{id2506445}\hypertarget{id2506445}{}%
\label{id2506451}kfunct 0x21: MenuSelect();
        \newline
        HeapPtr event[, word flag];

\begin{tabular}{l}
(HeapPtr) event: The event to interpret  \\
(word) flag: (unknown)  \\
\end{tabular}


Returns: (word) The menu index of a selected option, -1 if no menu option was selected, or 0 if the event passed through all of the menu system's filters.

This function interprets the event passed to it by running several checks. First, it tries to determine whether the menu system was activated by pressing the ESC key or clicking on the menu bar. In this case, the interpreter takes over and waits for the player to select a menu option. It then returns the menu option selected (menu number, starting at 1, in the upper 8 bits, item number, starting at 1 as well, in the lower part) or -1 if no active menu item was selected. In any case, the event is claimed. If the menu system was not activated by the event, it checks the event against the key commands or Said Blocks associated with each menu entry. If there is a match, the menu coordinate tuple is returned and the event is claimed, otherwise, 0 is returned.
\subsubsection{Kernel function 0x22: AddMenu(HeapPtr, HeapPtr)}
\label{id2506509}\hypertarget{id2506509}{}%


\label{id2506516}kfunct 0x22: AddMenu();
        \newline
        HeapPtr title, HeapPtr content;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{title}}}: The menu title  \\
(HeapPtr) {\ttfamily\itshape{{content}}}: The menu options  \\
\end{tabular}


Returns: (void)

This function adds a menu to the menu bar. The menu title is passed in the first parameter, the second parameter contains a heap pointer to the menu entries. They are contained in one single string; the following special characters/character combinations are used: 

\begin{tabular}{l}
'`': Right justify the following text  \\
':': Menu item separator  \\
"--!": Seperation line: This menu item is just a separator  \\
'\#': Function key. This is replaced by an F for displaying  \\
'\textasciicircum{}': Control key. This is replaced by \textbackslash001 (CTRL) for displaying  \\
\end{tabular}

\subsubsection{Kernel function 0x23: DrawStatus(HeapPtr)}
\label{id2506595}\hypertarget{id2506595}{}%
\label{id2506600}kfunct 0x23: DrawStatus();
        \newline
        HeapPtr text;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{text}}}: The text to draw  \\
\end{tabular}


Returns: (void)

Draws the specified text to the title bar
\subsubsection{Kernel function 0x24: Parse(HeapPtr, HeapPtr)}
\label{id2506635}\hypertarget{id2506635}{}%


\label{id2506641}kfunct 0x24: Parse();
        \newline
        HeapPtr event, HeapPtr input;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{event}}}: The event to generate  \\
(HeapPtr) {\ttfamily\itshape{{input}}}: The input line to parse  \\
\end{tabular}


Returns: (word) 1 on success, 0 otherwise

This function parses the input line and generates a parse event (type 0x80). See \hyperlink{LarsDMParser}{Section~{\ref{LarsDMParser}}} and \hyperlink{LarsEvents}{Section~{\ref{LarsEvents}}} for details.
\subsubsection{Kernel function 0x25: Said(HeapPtr)}
\label{id2506705}\hypertarget{id2506705}{}%


\label{id2506711}kfunct 0x:25: Said();
        \newline
        HeapPtr said\_block;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{said\_block}}}: Pointer to a Said block  \\
\end{tabular}


Returns: (word) 1 if the line last parsed meets the criteria of the supplied said\_block, 0 otherwise.

This function is only invoked after Parse() was called, and works on output generated by this function. See \hyperlink{LarsDMParser}{Section~{\ref{LarsDMParser}}} and \hyperlink{LarsEvents}{Section~{\ref{LarsEvents}}} for details.
\subsubsection{Kernel function 0x26: SetSynonyms(DblList)}
\label{kfunct-set-synonyms}\hypertarget{kfunct-set-synonyms}{}%
\label{id2506772}kfunct 0x26: SetSynonyms();
        \newline
        HeapPtr list;

\begin{tabular}{l}
(DblList) list: List of script objects to examine  \\
\end{tabular}


Returns: (void)

This function sets the synonyms used by the parser. Synonyms are used to replace specified word groups with other word groups. The list contains a collection of script objects; all synonyms defined by the corresponding script (which can be identified by evaluating the 'number' selector of the script object) are added to the list of active synonyms.
\subsubsection{Kernel function 0x27: HaveMouse()}
\label{id2506810}\hypertarget{id2506810}{}%


\label{id2506816}kfunct 0x27: HaveMouse();
        \newline
        ;


Returns: (word) 1 if a mouse is available, 0 if not.

This function simply returns a flag containing the availability of a pointing device.
\subsubsection{Kernel function 0x28: SetCursor(word, word[, Point])}
\label{id2506839}\hypertarget{id2506839}{}%


\label{id2506846}kfunct 0x28: SetCursor();
        \newline
        word resource, word visible[, Point coordinates];

\begin{tabular}{l}
(word) {\ttfamily\itshape{{resource}}}: The cursor resource to use for drawing the mouse pointer  \\
(word) {\ttfamily\itshape{{visible}}}: 1 if the mouse pointer should be visible, 0 if not  \\
(Point) {\ttfamily\itshape{{coordinates}}}: The coordinates (relative to the wm-port) to move the mouse pointer to  \\
\end{tabular}


Returns: (void)

This function can change the appearance and position of the mouse pointer. If no position is provided, the position remains unchanged.
\subsubsection{Kernel function 0x29: FOpen(String, word)}
\label{id2506911}\hypertarget{id2506911}{}%
\label{id2506916}kfunct 0x29: FOpen();
        \newline
        String fname, word mode;

\begin{tabular}{l}
(String) fname: The file name  \\
(word) mode: The mode to open the file with  \\
\end{tabular}


Returns: (word) a file handle on success, $-1$ on error

Tries to open or create a file in the CWD with the specified file name. The following modes are valid: 

\begin{tabular}{l}
0: open or create: Try to open file, create it if it doesn't exist  \\
1: open or fail: Try to open file, abort if not possible  \\
2: create: Create the file, destroying any content it might have had  \\
\end{tabular}

\subsubsection{Kernel function 0x2a: FPuts(word, String)}
\label{id2506976}\hypertarget{id2506976}{}%
\label{id2506981}kfunct 0x2a: FPuts();
        \newline
        word filehandle, String data;

\begin{tabular}{l}
(word) filehandle: Handle of the file to write to  \\
(String) data: The string to write to the file  \\
\end{tabular}


Returns: (void)

Writes a zero-terminated string to a file
\subsubsection{Kernel function 0x2b: FGets(String, word, word)}
\label{id2507021}\hypertarget{id2507021}{}%
\label{id2507026}kfunct 0x2b: FGets();
        \newline
        String dest, word maxsize, word handle;

\begin{tabular}{l}
(String) dest: Pointer to the destination buffer  \\
(word) maxsize: Maximum number of bytes to read  \\
(word) handle: Handle of the file to read from  \\
\end{tabular}


Returns: (word) The number of bytes actually read


\subsubsection{Kernel function 0x2c: FClose(word)}
\label{id2507073}\hypertarget{id2507073}{}%
\label{id2507078}kfunct 0x2c: FClose();
        \newline
        word filehandle;

\begin{tabular}{l}
(word) filehandle: Handle of the file to close  \\
\end{tabular}


Returns: (void)

Closes a previously opened file.
\subsubsection{Kernel function 0x2d: SaveGame(String, word, String, String)}
\label{id2507111}\hypertarget{id2507111}{}%
\label{id2507118}kfunct 0x2d: SaveGame();
        \newline
        String game\_id, word save\_nr, String save\_description, String version;

\begin{tabular}{l}
(String) game\_id: The game object's ID string (e.g. "SQ3")  \\
(word) save\_nr: "slot" the game is to be saved to  \\
(String) save\_description: String description of the game  \\
(String) version: Stringified game version number  \\
\end{tabular}


Returns: (word) 1 on success, 0 if an error occured while saving

This function saves the game state (heap, windows, call stack, view list, sound state etc.) to the savegame with the numeric id {\ttfamily\itshape{{save\_nr}}} and the description {\ttfamily\itshape{{save\_description}}}. {\ttfamily\itshape{{game\_id}}} and {\ttfamily\itshape{{version}}} are stored alongside, for verification when the game state is restored.
\subsubsection{Kernel function 0x2e: RestoreGame(String, word, String)}
\label{id2507200}\hypertarget{id2507200}{}%
\label{id2507206}kfunct 0x2e: RestoreGame();
        \newline
        String game\_id, word save\_nr, String version;

\begin{tabular}{l}
(String) game\_id: The game object's ID string  \\
(word) save\_nr: Number of the save game to restore  \\
(String) version: The game object's version number  \\
\end{tabular}


Returns: (void)

This function restores a previously saved game. It should only return if restoring failed.
\subsubsection{Kernel function 0x2f: RestartGame()}
\label{id2507254}\hypertarget{id2507254}{}%
\label{id2507260}kfunct 0x2f: RestartGame();
        \newline
        ;
Returns: never

If this function is invoked, the following things happen: 

\begin{tabular}{l}
The restarting flag is set  \\
The menu bar structure is destroyed  \\
All sounds are stopped  \\
All scripts are removed from the script table  \\
The heap status is reset, but the heap is not cleared  \\
\end{tabular}

 After this is done, the engine restarts at a certain point (see \hyperlink{LSExecLoop}{Section~{\ref{LSExecLoop}}}), re-initializes the stack, and executes the replay method of the game object.
\subsubsection{Kernel function 0x30: GameIsRestarting()}
\label{id2507314}\hypertarget{id2507314}{}%


\label{id2507320}kfunct 0x30: GameIsRestarting();
        \newline
        ;


Returns: (word) 1 if the game is restarting, 0 if not


\subsubsection{Kernel function 0x31: DoSound(word, ...])}
\label{id2507341}\hypertarget{id2507341}{}%
\label{id2507347}kfunct 0x31: DoSound();
        \newline
        word action, ...;

\begin{tabular}{l}
(word) action: The sound command subfunction number  \\
\end{tabular}


Returns: (see below)

'action' may be one of the following: 

\begin{tabular}{l}
0x0: INIT  \\
0x1: PLAY  \\
0x2: NOP  \\
0x3: DISPOSE  \\
0x4: SET\_SOUND  \\
0x5: STOP  \\
0x6: SUSPEND  \\
0x7: RESUME  \\
0x8: VOLUME  \\
0x9: UPDATE  \\
0xa: FADE  \\
0xb: CHECK\_DRIVER  \\
0xc: ALL\_STOP  \\
\end{tabular}

 See individual descriptions below for more information.
\subsubsection{Kernel function 0x31: DoSound(INIT, Object)}
\label{id2507430}\hypertarget{id2507430}{}%
\label{id2507436}kfunct 0x31: DoSound();
        \newline
        word 0, Object sound\_obj;

\begin{tabular}{l}
(word) 0: subfunction identifier  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Initializes the specified sound object. This will set the 'status' selector of the object to 1 ('initialized'), and load the sound indicated by the 'number' selector into the sound driver.
\subsubsection{Kernel function 0x31: DoSound(PLAY, Object)}
\label{id2507478}\hypertarget{id2507478}{}%
\label{id2507484}kfunct 0x31: DoSound();
        \newline
        word 1, Object sound\_obj;

\begin{tabular}{l}
(word) 1: The subfunction identifier  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Starts to play the song represented by the specified sound object. This will also set the 'status' selector of the object to 2 ('playing').
\subsubsection{Kernel function 0x31: DoSound(NOP)}
\label{id2507526}\hypertarget{id2507526}{}%
\label{id2507532}kfunct 0x31: DoSound();
        \newline
        word 2;

\begin{tabular}{l}
(word) 2: The sound command subfunction number  \\
\end{tabular}


Returns: (void)

No action appears to be associated with this subfunction call.
\subsubsection{Kernel function 0x31: DoSound(DISPOSE, Object)}
\label{id2507566}\hypertarget{id2507566}{}%
\label{id2507572}kfunct 0x31: DoSound();
        \newline
        word 3, Object sound\_obj;

\begin{tabular}{l}
(word) 3: The sound command subfunction number  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Removes the song indexed by a sound object from the sound server song list
\subsubsection{Kernel function 0x31: DoSound(SET\_SOUND, word)}
\label{id2507613}\hypertarget{id2507613}{}%
\label{id2507619}kfunct 0x31: DoSound();
        \newline
        word 4, word state;

\begin{tabular}{l}
(word) 4: The sound command subfunction number  \\
(word) state: 1 if sound should be active, 0 if it should be turned off  \\
\end{tabular}


Returns: (word) 1 if currently active, 0 if currently muted.

This function completely mutes or un-mutes the sound subsystem. If called with no parameters, it returns the current status.
\subsubsection{Kernel function 0x31: DoSound(STOP, Object)}
\label{id2507662}\hypertarget{id2507662}{}%
\label{id2507668}kfunct 0x31: DoSound();
        \newline
        word 5, Object sound\_obj;

\begin{tabular}{l}
(word) 5: The sound command subfunction number  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Stops playing the song represented by the specified sound object. This will set the object's 'state' selector to 0 ('stopped').
\subsubsection{Kernel function 0x31: DoSound(SUSPEND, Object)}
\label{id2507710}\hypertarget{id2507710}{}%
\label{id2507716}kfunct 0x31: DoSound();
        \newline
        word 6, Object sound\_obj;

\begin{tabular}{l}
(word) 6: The sound command subfunction number  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Suspends the song associated with the specified sound object. Its state is buffered, so that it can be resumed later on. The sound object's 'state' selector is set to 3 ('suspended').
\subsubsection{Kernel function 0x31: DoSound(RESUME, Object)}
\label{id2507758}\hypertarget{id2507758}{}%
\label{id2507765}kfunct 0x31: DoSound();
        \newline
        word 7, Object sound\_obj;

\begin{tabular}{l}
(word) 7: The sound command subfunction number  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Resumes a previously suspended song. The 'state' selector is set to 2 ('playing').
\subsubsection{Kernel function 0x31: DoSound(VOLUME[, word])}
\label{id2507806}\hypertarget{id2507806}{}%
\label{id2507812}kfunct 0x31: DoSound();
        \newline
        word 8[, word volume];

\begin{tabular}{l}
(word) 8: The sound command subfunction number  \\
(word) volume: An optional volume parameter  \\
\end{tabular}


Returns: (word) The currently set sound volume (0 to 0xf)

This subfunction retrieves and returns the current sound volume. If a second parameter is supplied the volume will be set to the value of this parameter.
\subsubsection{Kernel function 0x31: DoSound(UPDATE, Object])}
\label{id2507854}\hypertarget{id2507854}{}%
\label{id2507861}kfunct 0x31: DoSound();
        \newline
        word 9, Object sound\_obj;

\begin{tabular}{l}
(word) 9: The sound command subfunction number  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Notifies the sound server that a sound object was modified. The song priority and number of loops (stored in the 'priority' and 'loop' selectors, respectively) are re-evaulated by the sound system.
\subsubsection{Kernel function 0x31: DoSound(FADE, Object])}
\label{id2507904}\hypertarget{id2507904}{}%
\label{id2507910}kfunct 0x31: DoSound();
        \newline
        word 0xa, Object sound\_obj;

\begin{tabular}{l}
(word) 0xa: The sound command subfunction number  \\
(Object) sound\_obj: The sound object affected  \\
\end{tabular}


Returns: (void)

Fades the specified song. Fading takes approximately two seconds. The song status is set to 'stopped' (0) afterwards.
\subsubsection{Kernel function 0x31: DoSound(CHECK\_DRIVER)}
\label{id2507951}\hypertarget{id2507951}{}%
\label{id2507957}kfunct 0x31: DoSound();
        \newline
        word 0xb;

\begin{tabular}{l}
(word) 0xb: The sound command subfunction number  \\
\end{tabular}


Returns: (word) 1 if the sound driver was installed successfully, 0 if not


\subsubsection{Kernel function 0x31: DoSound(ALL\_STOP)}
\label{id2507991}\hypertarget{id2507991}{}%
\label{id2507997}kfunct 0x31: DoSound();
        \newline
        word 0xc;

\begin{tabular}{l}
(word) 0xc: The sound command subfunction number  \\
\end{tabular}


Returns: (void)

Stops all music and sound effects.
\subsubsection{Kernel function 0x32: NewList()}
\label{id2508031}\hypertarget{id2508031}{}%


\label{id2508037}kfunct 0x32: NewList();
        \newline
        ;


Returns: (DblList) The address of a new node list on the heap

This function allocates and initializes a node list containing no elements.
\subsubsection{Kernel function 0x33: DisposeList(DblList)}
\label{id2508060}\hypertarget{id2508060}{}%


\label{id2508066}kfunct 0x33: DisposeList();
        \newline
        NodeList list;

\begin{tabular}{l}
(NodeList) {\ttfamily\itshape{{list}}}: The list to dispose  \\
\end{tabular}


Returns: (void)

Frees all memory associated to a list
\subsubsection{Kernel function 0x34: NewNode(word, word)}
\label{id2508103}\hypertarget{id2508103}{}%


\label{id2508109}kfunct 0x34: NewNode();
        \newline
        word value, word key;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{value}}}: The node value  \\
(word) {\ttfamily\itshape{{key}}}: The node key (used for searching the list)  \\
\end{tabular}


Returns: (Node) A new node

This function allocates a new node and initializes it with the key and value passed as parameters.
\subsubsection{Kernel function 0x35: FirstNode(DblList)}
\label{id2508159}\hypertarget{id2508159}{}%


\label{id2508165}kfunct 0x35: FirstNode();
        \newline
        DblList list;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{list}}}: The list to examine  \\
\end{tabular}


Returns: (Node) The first node of the list, or 0 if the list is empty


\subsubsection{Kernel function 0x36: LastNode(DblList)}
\label{id2508203}\hypertarget{id2508203}{}%


\label{id2508209}kfunct 0x36: LastNode();
        \newline
        DblList list;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{list}}}: The list to examine  \\
\end{tabular}


Returns: (Node) The last node of the list, or 0 if the list is empty


\subsubsection{Kernel function 0x37: EmptyList(DblList)}
\label{id2508246}\hypertarget{id2508246}{}%
\label{id2508252}kfunct 0x37: EmptyList();
        \newline
        DblList list;

\begin{tabular}{l}
(DblList) list: The list to check  \\
\end{tabular}


Returns: (int) 1 if {\ttfamily\itshape{{list}}} is an empty list, 0 if it isn't.


\subsubsection{Kernel function 0x38: NextNode(Node)}
\label{id2508292}\hypertarget{id2508292}{}%


\label{id2508298}kfunct 0x38: NextNode();
        \newline
        Node node;

\begin{tabular}{l}
(Node) {\ttfamily\itshape{{node}}}: The node whose succcessor is to be found  \\
\end{tabular}


Returns: (Node) The node following the supplied node, or 0 if none is available


\subsubsection{Kernel function 0x39: PrevNode(Node)}
\label{id2508336}\hypertarget{id2508336}{}%


\label{id2508342}kfunct 0x39: PrevNode();
        \newline
        Node node;

\begin{tabular}{l}
(Node) {\ttfamily\itshape{{node}}}: The node whose predecessor is to be determined  \\
\end{tabular}


Returns: (Node) The supplied node's predecessor, or 0 if the node has no predecessor


\subsubsection{Kernel function 0x3a: NodeValue(Node)}
\label{id2508380}\hypertarget{id2508380}{}%


\label{id2508386}kfunct 0x3a: NodeValue();
        \newline
        Node node;

\begin{tabular}{l}
(Node) {\ttfamily\itshape{{node}}}: The node whose value is to be determined  \\
\end{tabular}


Returns: (word) The value associated with the specified node


\subsubsection{Kernel function 0x3b: AddAfter(DblList, Node, Node)}
\label{id2508423}\hypertarget{id2508423}{}%
\label{id2508430}kfunct 0x3b: AddAfter();
        \newline
        DblList list, Node ref\_node, Node new\_node;

\begin{tabular}{l}
(DblList) list: The list to insert into  \\
(Node) ref\_node: The node in {\ttfamily\itshape{{list}}} to insert after  \\
(Node) new\_node: The node to insert  \\
\end{tabular}


Returns: (void)

This function inserts {\ttfamily\itshape{{new\_node}}} into {\ttfamily\itshape{{list}}} as the immediate successor of {\ttfamily\itshape{{ref\_node}}}.
\subsubsection{Kernel function 0x3c: AddToFront(DblList, Node)}
\label{id2508501}\hypertarget{id2508501}{}%


\label{id2508507}kfunct 0x3c: AddToFront();
        \newline
        DblList list, Node node;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{list}}}: The list the node is to be added to  \\
(Node) {\ttfamily\itshape{{node}}}: The node to add  \\
\end{tabular}


Returns: (void)

This function adds a node to the beginning of a doubly linked list.
\subsubsection{Kernel function 0x3d: AddToEnd(DblList, Node)}
\label{id2508557}\hypertarget{id2508557}{}%


\label{id2508563}kfunct 0x3d: AddToEnd();
        \newline
        DblList list, Node node;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{list}}}: The list to add the node to  \\
(Node) {\ttfamily\itshape{{node}}}: The node to add to the list  \\
\end{tabular}


Returns: (void)

This function adds the specified node to the end of the specified list.
\subsubsection{Kernel function 0x3e: FindKey(DblList, word)}
\label{id2508613}\hypertarget{id2508613}{}%


\label{id2508619}kfunct 0x3e: FindKey();
        \newline
        DblList list, word key;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{list}}}: The list in which the key is to be sought  \\
(word) {\ttfamily\itshape{{key}}}: The key to seek  \\
\end{tabular}


Returns: (Node) The node containing the key, or 0 if no node contains it

This function searches for a specific key in the nodes of a doubly linked list.
\subsubsection{Kernel function 0x3f: DeleteKey(DblList, word)}
\label{id2508670}\hypertarget{id2508670}{}%


\label{id2508677}kfunct 0x3f:();
        \newline
        DblList list, word key;

\begin{tabular}{l}
(DblList) {\ttfamily\itshape{{list}}}: The list to examine  \\
(word) {\ttfamily\itshape{{key}}}: The key to find  \\
\end{tabular}


Returns: (void)

This function searches in the supplied list for the specified key and removes the node containing it, if any can be found.
\subsubsection{Kernel function 0x40: Random(word, word)}
\label{id2508727}\hypertarget{id2508727}{}%


\label{id2508733}kfunct 0x40: Random();
        \newline
        word min, word max;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{min}}}: The minimum result  \\
(word) {\ttfamily\itshape{{max}}}: The maximum result  \\
\end{tabular}


Returns: (word) A random number between min and max (inclusive)


\subsubsection{Kernel function 0x41: Abs(word)}
\label{id2508782}\hypertarget{id2508782}{}%


\label{id2508788}kfunct 0x41: Abs();
        \newline
        word value;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{value}}}: The value to absolutize  \\
\end{tabular}


Returns: (word) The absolute value of the specified parameter

This function interprets the supplied value as a signed value and returns its absolute value.
\subsubsection{Kernel function 0x42: Sqrt(word)}
\label{id2508827}\hypertarget{id2508827}{}%


\label{id2508833}kfunct 0x42: Sqrt();
        \newline
        word value;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{value}}}: The value to draw the square root out of  \\
\end{tabular}


Returns: (word) The square root of the supplied value


\subsubsection{Kernel function 0x43: GetAngle(Point, Point)}
\label{id2508870}\hypertarget{id2508870}{}%


\label{id2508876}kfunct 0x43: GetAngle();
        \newline
        Point origin, Point destination;

\begin{tabular}{l}
(Point) {\ttfamily\itshape{{origin}}}: The point to look from  \\
(Point) {\ttfamily\itshape{{destination}}}: The point to look to  \\
\end{tabular}


Returns: (word) A positive angle between the two points, relative to the screen coordinate axis.

This function returns approximately the following value: -(180.0/PI * atan2(destination.y - origin.y, destination.x - origin.x)) + 180; Where atan2(double, double) is the libm function.
\subsubsection{Kernel function 0x44: GetDistance(Point, Point)}
\label{id2508930}\hypertarget{id2508930}{}%


\label{id2508936}kfunct 0x44: GetDistance();
        \newline
        Point foo, Point bar;

\begin{tabular}{l}
(Point) {\ttfamily\itshape{{foo}}}: A point in two-dimensional integer space  \\
(Point) {\ttfamily\itshape{{bar}}}: Another two-dimensional integer point  \\
\end{tabular}


Returns: (int) The euklidian distance between the points foo and bar


\subsubsection{Kernel function 0x45: Wait(word)}
\label{id2508986}\hypertarget{id2508986}{}%


\label{id2508992}kfunct 0x45: Wait();
        \newline
        word ticks;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{ticks}}}: The number of game ticks (60 Hz beats) to wait  \\
\end{tabular}


Returns: (word) The time passed in between the finish of the last Wait() syscall


\subsubsection{Kernel function 0x46: GetTime([word])}
\label{id2509029}\hypertarget{id2509029}{}%


\label{id2509036}kfunct 0x46: GetTime();
        \newline
        word mode;

\begin{tabular}{l}
(wrod) {\ttfamily\itshape{{mode}}}: If this parameter is supplied, the time of day is returned.  \\
\end{tabular}


Returns: (word) Either the time of day in seconds, or the elapsed number of ticks since the interpreter started.

This function is somewhat strange, because it determines its behaviour not by the value of a parameter passed, but by its presence instead. Please note that the time of day in this case does not distinguish between am and pm.
\subsubsection{Kernel function 0x47: StrEnd(HeapPtr)}
\label{id2509078}\hypertarget{id2509078}{}%


\label{id2509084}kfunct 0x47: StrEnd();
        \newline
        HeapPtr string;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{string}}}: The string whose terminator should be found  \\
\end{tabular}


Returns: (HeapPtr) The address of the null terminator of the indexed string


\subsubsection{Kernel function 0x48: StrCat(HeapPtr, HeapPtr)}
\label{id2509122}\hypertarget{id2509122}{}%


\label{id2509128}kfunct 0x48: StrCat();
        \newline
        HeapPtr dest, HeapPtr source;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{dest}}}: The string whose end is appended to  \\
(HeapPtr) {\ttfamily\itshape{{source}}}: The string to append  \\
\end{tabular}


Returns: (HeapPtr) dest

This function concatenates two strings on the heap.
\subsubsection{Kernel function 0x49: StrCmp(HeapPtr, HeapPtr[, word])}
\label{id2509178}\hypertarget{id2509178}{}%


\label{id2509184}kfunct 0x49: StrCmp();
        \newline
        HeapPtr foo, HeapPtr bar[, word length];

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{foo}}}: The one string to compare  \\
(HeapPtr) {\ttfamily\itshape{{bar}}}: The other string to compare  \\
(int) {\ttfamily\itshape{{width}}}: The maximum number of characters to compare  \\
\end{tabular}


Returns: (word) -1 if foo is less than bar, 0 if both are equal, 1 if foo is greater than bar

This function simply encapsulates the libc {\texttt{{strcmp(char *, char *)}}} and {\texttt{{strncmp(char *, char *, int)}}} functions.
\subsubsection{Kernel function 0x4a: StrLen(HeapPtr)}
\label{id2509260}\hypertarget{id2509260}{}%


\label{id2509266}kfunct 0x4a: StrLen();
        \newline
        HeapPtr string;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{string}}}: The string whose length should be calculated  \\
\end{tabular}


Returns: (word) The length of the specified string.


\subsubsection{Kernel function 0x4b: StrCpy(HeapPtr, HeapPtr[, word])}
\label{id2509304}\hypertarget{id2509304}{}%


\label{id2509310}kfunct 0x4b: StrCpy();
        \newline
        HeapPtr dest, HeapPtr src[, word length];

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{dest}}}: The destination to copy the string to  \\
(HeapPtr) {\ttfamily\itshape{{src}}}: The source from which the string is to be copied  \\
(word) {\ttfamily\itshape{{length}}}: The maximum length of the string to copy  \\
\end{tabular}


Returns: (HeapPtr) dest

Copies a string, plus the trailing \textbackslash0 terminator. The length of the string may be reduced with the optional length parameter. This function simply encapsulates the libc {\texttt{{strcpy(char *, char *)}}} and {\texttt{{strncpy(char *, char *, int)}}} fucntions.
\subsubsection{Kernel function 0x4c: Format(HeapPtr, String,...)}
\label{id2509387}\hypertarget{id2509387}{}%


\label{id2509393}kfunct 0x4c: Format();
        \newline
        HeapPtr dest, String format, parameters...;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{dest}}}: The heap destination to write to  \\
(String) {\ttfamily\itshape{{format}}}: The format to use  \\
(misc) {\ttfamily\itshape{{parameters}}}: The values and strings to insert  \\
\end{tabular}


Returns: (HeapPtr) dest

This syscall acts as a frontend to the libc {\texttt{{sprintf(char *, char *)}}} function.
\subsubsection{Kernel function 0x4d: GetFarText(word, word, HeapPtr)}
\label{id2509462}\hypertarget{id2509462}{}%


\label{id2509468}kfunct 0x4d: GetFarText();
        \newline
        word resnr, word stringnr, HeapPtr dest;

\begin{tabular}{l}
(word) {\ttfamily\itshape{{resnr}}}: Number of the text resource to retreive the text from  \\
(word) {\ttfamily\itshape{{stringnr}}}: Number of the string inside the resource to retreive  \\
(HeapPtr) {\ttfamily\itshape{{dest}}}: The destination to write the text to  \\
\end{tabular}


Returns: (HeapPtr) dest

Retreives a string from a text resource and puts it on the heap.
\subsubsection{Kernel function 0x4e: ReadNumber(HeapPtr)}
\label{id2509532}\hypertarget{id2509532}{}%


\label{id2509538}kfunct 0x4e: ReadNumber();
        \newline
        HeapPtr src;

\begin{tabular}{l}
(HeapPtr) {\ttfamily\itshape{{src}}}: The address of the string to interpret as a number  \\
\end{tabular}


Returns: (word) The numeric value of the supplied string

This function acts as a frontend to the libc {\texttt{{atoi(char *)}}} function, with one exception: Numbers beginning with a '\$' are interpreted as hexadecimal numbers.
\subsubsection{Kernel function 0x4f: BaseSetter(HeapPtr)}
\label{id2509584}\hypertarget{id2509584}{}%
\label{id2509590}kfunct 0x4f: BaseSetter();
        \newline
        HeapPtr view\_obj;

\begin{tabular}{l}
(HeapPtr) view\_obj: The view object whose base is to be set  \\
\end{tabular}


Returns: (void)

This method is used to set the bounding rectangle of a view. The bounding rectangle is specified by the set \{brLeft, brRight, brTop, brBottom\} of selectors, which indicate the window-relative boundary points of the object's bounding rectangle. The rectangle defined here is used for colission detection, among other things.

The algorithm employed by FreeSCI to determine these values appears to be either identical or very close to the original algorithm; it depends several of the object's selectors (x, y, z, ystep, view) the width and height of the view indicated by its (view, loop, cel) selectors, and that view's horizontal and vertical pixel offset modifyers (xmod, ymod). The algorithm works as follows: 
\begin{Verbatim}[]

        brLeft := x - xmod - width / 2
        brRight := brLeft + width
        brBottom := y - z - ymod + 1
        brTop := brBottom - ystep

\end{Verbatim}

\subsubsection{Kernel function 0x50: DirLoop(HeapPtr, word)}
\label{id2509655}\hypertarget{id2509655}{}%
\label{id2509662}kfunct 0x50: DirLoop();
        \newline
        HeapPtr object, word angle;

\begin{tabular}{l}
(HeapPtr) object: The object whose loop selector is to be set  \\
(word) angle: The angle which is to be used as a base to choose the loop angle  \\
\end{tabular}


Returns: (void)

This function sets the loop selector of the specified object to a value implied by the 'angle' parameter, according to the following table: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2509702}\hypertarget{id2509702}{}%

\begin{tabular}{|c|c|}
\hline 
{{{\ttfamily\itshape{{angle}}}}} & {{loop value}} \tabularnewline
 \hline 
{{angle \textless{} 45 \docbooktolatexpipe{}\docbooktolatexpipe{} angle \textgreater{}= 314}} & {{3}} \tabularnewline
 \hline 
{{angle \textgreater{}= 45 \&\& angle \textless{} 135}} & {{0}} \tabularnewline
 \hline 
{{angle \textgreater{}= 135 \&\& angle \textless{} 225}} & {{2}} \tabularnewline
 \hline 
{{angle \textgreater{}= 225 \&\& angle \textless{} 314}} & {{1}} \tabularnewline
\hline 
\end{tabular}
\end{center}


\subsubsection{Kernel function 0x51: CanBeHere(HeapPtr [, DblList])}
\label{id2509759}\hypertarget{id2509759}{}%
\label{id2509764}kfunct 0x51: CanBeHere();
        \newline
        HeapPtr obj [, DblList clip\_list];

\begin{tabular}{l}
(HeapPtr) obj: The object to test  \\
(DblList) clip\_list: An optional list of objects to test {\ttfamily\itshape{{obj}}} against  \\
\end{tabular}


Returns: (int) 1 if {\ttfamily\itshape{{obj}}} can be where it is, 0 if not.

This function first retreives {\ttfamily\itshape{{obj}}}'s signal and illegalBits selectors, plus its brRect (boundary rectangle, consisting of brTop, brBottom, brLeft and brRight). If either of the DONT\_RESTORE or IGNORE\_ACTOR flags is set, the function returns 1, otherwise it proceeds with verifying that 

\begin{tabular}{l}
illegalBits bitwise-AND the disjunction of all elements of $\{ 2^n | \exists \textrm{ a pixel with the color value n inside the control map zone delimited by obj's brRect}\}$ equals 0  \\
$\nexists \textrm{pic} \in \textrm{clip\_list}. (\textrm{pic::signal} \& (\textrm{DONT\_RESTORE} \texttt{ | } \textrm{IGNORE\_ACTOR})) = 0 \land \textrm{pic::brRect} \cap \textrm{obj::brRect} \neq \emptyset$  \\
\end{tabular}

 If both conditions are met, 1 is returned. Otherwise, 0 is returned.
\subsubsection{Kernel function 0x52: OnControl(word, Point \docbooktolatexpipe{} Rect)}
\label{KONCONTROL}\hypertarget{KONCONTROL}{}%
\label{id2509873}kfunct 0x52: OnControl();
        \newline
        word map, Point\docbooktolatexpipe{}Rect area;

\begin{tabular}{l}
(word) map: The map to check (bit 0: visual, bit 1: priority, bit 2: special)  \\
(Point) or (Rect) Area: The point or rectangle that is to be scanned  \\
\end{tabular}


Returns: (word) The resulting bitfield

This function scans the indicated point or area on the specified {\ttfamily\itshape{{map}}}, and sets the bit corresponding to each color value found correspondingly. For example, if scanning map 4 (special) would touch two areas, one with color value 1 and one with color value 10, the resulting return value would be 0x0402 (binary 0000010000000010). See also \hyperlink{LARSPICSANDMOVEMENT}{Section~{\ref{LARSPICSANDMOVEMENT}}}.
\subsubsection{Kernel function 0x53: InitBresen(HeapPtr [, word])}
\label{id2509933}\hypertarget{id2509933}{}%
\label{id2509939}kfunct 0x53: InitBresen();
        \newline
        HeapPtr mover, word step\_factor;

\begin{tabular}{l}
(HeapPtr) mover: The mover object to initialize  \\
(word) step\_factor: A factor to multiply the step size with (defaults to 1)  \\
\end{tabular}


Returns: (void)

Initializes a mover object for bresenham movement from the object's client's coordinates to the coordinates specified by its own pair of (x,y) selectors. To do this, it retreives the mover's client, and calculates the result values according to the algorithm for determining the initial values for iterative line drawing according to the Bresenham line algorithm: 
\begin{Verbatim}[]

        client := mover::client
        dx := mover::x - client::x
        dy := mover::y - client::y

        vxmax := client::xStep * step_factor
        vymax := client::yStep * step_factor

        numstepsx := |dx / vxmax|
        numstepsy := |dy / vymax|

        IF numstepsx > numstepsy THEN
                numsteps := numstepsx
                mover::b_xAxis := 1
                d0 := dx
                d1 := dy
                s := client::yStep
        ELSE
                numsteps := numstepsy
                mover::b_xAxis := 0
                d1 := dx
                d0 := dy
                s := client::xStep
        FI

        mover::dx := dx / numsteps
        mover::dy := dy / numsteps

        mover::b_di := - |d0|
        mover::b_i1 := 2 * (|d1| - |s * numsteps|) * |d0|
        mover::b_incr := d1 / |d1|
        mover::b_i2 := mover::b_d1 * 2

\end{Verbatim}

\subsubsection{Kernel function 0x54: DoBresen()}
\label{id2510072}\hypertarget{id2510072}{}%
\label{id2510077}kfunct 0x55: DoBresen();
        \newline
        ;
Returns: (void)

Executes the Bresenham algorithm on the values calculated by InitBresen, and counts down the number of steps. It then invokes CanBeHere() on the resulting coordinates, and sets the new coordinates if it actually Can Be There.
\subsubsection{Kernel function 0x55: DoAvoider(HeapPtr)}
\label{id2510097}\hypertarget{id2510097}{}%
\label{id2510102}kfunct 0x55: DoAvoider();
        \newline
        HeapPtr avoider;
Returns: (word) New direction

This function is a no-op in later SCI games, but is implemented in some or all pre-0.000.576 interpreters.
\subsubsection{Kernel function 0x56: SetJump(?)}
\label{id2510129}\hypertarget{id2510129}{}%


\subsubsection{Kernel function 0x57: SetDebug()}
\label{id2510134}\hypertarget{id2510134}{}%
\label{id2510140}kfunct 0x57: SetDebug();
        \newline
        ;
Returns: (void)

This function forces the interpreter to enter debug mode. It is equivalent to pressing LShift-RShift-PadMinus.
\subsubsection{Kernel function 0x58: InspectObj(?)}
\label{id2510162}\hypertarget{id2510162}{}%


\subsubsection{Kernel function 0x59: ShowSends(?)}
\label{id2510167}\hypertarget{id2510167}{}%


\subsubsection{Kernel function 0x5a: ShowObjs(?)}
\label{id2510180}\hypertarget{id2510180}{}%


\subsubsection{Kernel function 0x5b: ShowFree(?)}
\label{id2510189}\hypertarget{id2510189}{}%


\subsubsection{Kernel function 0x5c: MemoryInfo(word)}
\label{id2510194}\hypertarget{id2510194}{}%
\label{id2510200}kfunct 0x5c: word mode();
        \newline
        word mode;

\begin{tabular}{l}
(word) mode: 0 to 4 (see below)  \\
\end{tabular}


Returns: (word) The amount of free memory on the heap, in bytes

This function returns the total amount of free memory on the heap if mode == 0. If mode equals 1, the total size of the largest chunk of heap memory is returned. In mode 2, the size of the largest available hunk memory block is returned, and mode 3 returns the total amount of free hunk memory, shiftet to the right by 4 bits.

Mode 4 was apparently introduced in SCI01 and reports the amount of free memory provided by DOS in paragraphs.
\subsubsection{Kernel function 0x5d: StackUsage(?)}
\label{id2510247}\hypertarget{id2510247}{}%


\subsubsection{Kernel function 0x5e: Profiler(?)}
\label{id2510256}\hypertarget{id2510256}{}%


\subsubsection{Kernel function 0x5f: GetMenu(word, word)}
\label{id2510265}\hypertarget{id2510265}{}%
\kfuncparamlist
\begin{tabular}{p{2cm}p{2cm}p{9cm}}
\kfuncparam{entry}&\kfuncty{word}&{A pair of bytes. In LE notation, the higher byte is the ``menu ID'', and the lower byte is the ``entry ID''.} \\
\kfuncparam{key}&\kfuncty{word}&{A special key selecting some particular information regarding the menu entry.} \\
\end{tabular}

Retrieves some metainformation about an (existing) menu entry. \textit{entry} selects the menu and
entry the information is recovered with respect to, and \textit{key} specifies which particular
information to recover. At the moment, the following kinds of information are known for \textit{key}:

\begin{tabular}{|l|p{3.5cm}|p{9.5cm}|}
\hline
\textbf{ID} & \textbf{FreeSCI macro (\texttt{MENU\_ATTRIBUTE\_}\ldots)} & \textbf{Description} \\
\hline
\hline
0x6d	& \texttt{SAID}		& The ``\textit{Said}'' spec associated with the menu entry, or a null pointer. If this spec is matched, the next \texttt{GetEvent()} call will behave as if the appropriate menu option had been selected. \\
0x6e	& \texttt{TEXT}		& The string currently displayed for the menu item. \\
0x6f	& \texttt{KEY}		& An optional key (as reported by \texttt{GetKey()}) the menu option should be triggered by. \\
0x70	& \texttt{ENABLED}	& Whether the menu option is enabled or not (in the latter case, it is grayed out and cannot be selected). \\
0x71	& \texttt{TAG}		& A value without special semantics. \\
\hline
\end{tabular}


\subsubsection{Kernel function 0x60: SetMenu(word, [word, any]*)}
\label{id2510273}\hypertarget{id2510273}{}%
\kfuncparamlist
\begin{tabular}{p{2cm}p{2cm}p{9cm}}
\kfuncparam{entry}&\kfuncty{word}&{A pair of bytes. In LE notation, the higher byte is the ``menu ID'', and the lower byte is the ``entry ID''.} \\
\kfuncparam{key}&\kfuncty{word}&{A special key selecting some particular information regarding the menu entry.} \\
\kfuncparam{value}&\kfuncty{word}&{A special key selecting some particular information regarding the menu entry.} \\
\end{tabular}

\texttt{SetMenu} is a varargs function; it takes a menu bar \textit{entry} ID (cf. \texttt{GetMenu}, section \ref{id2510265})
followed by any even number of parameters. Each of these parameter pairs begins with a \textit{key}; the
second entry is a \textit{value}, whose type depends on the key. Semantics of \textit{key} are as in
\texttt{GetMenu} (cf. section \ref{id2510265}).

\subsubsection{Kernel function 0x61: GetSaveFiles(String, String, HeapPtr*)}
\label{id2510279}\hypertarget{id2510279}{}%
\label{id2510285}kfunct 0x61: GetSaveFiles();
        \newline
        String game\_id, String strspace, HeapPtr *ptrs;

\begin{tabular}{l}
(String) game\_id: The game ID as a string  \\
(String) strspace: The string which the result should be stored in  \\
(HeapPtr *) ptrs: The array of pointers which the string pointers are to be stored in  \\
\end{tabular}


Returns: (word) The number of savegames for the specified game\_id.

Returns an array of strings describing the existing save games for game\_id. The strings are put into strspace one by one, and heap pointers to each of them are put into the ptrs array. The number of saved games is returned in the accumulator.
\subsubsection{Kernel function 0x62: GetCWD(HeapPtr)}
\label{id2510339}\hypertarget{id2510339}{}%
\label{id2510345}kfunct 0x62: GetCWD();
        \newline
        HeapPtr address;

\begin{tabular}{l}
(HeapPtr) address: The address to write to  \\
\end{tabular}


Returns: (HeapPtr) The supplied address

This function retreives the current working directory (CWD) and stores its string representation at the location pointed to by the supplied parameter. 

FreeSCI returns a sub-directory of the user's home directory, if applicable, instead of the cwd.


\subsubsection{Kernel function 0x63: CheckFreeSpace(String)}
\label{id2510390}\hypertarget{id2510390}{}%
\label{id2510397}kfunct 0x63: CheckFreeSpace();
        \newline
        String path;

\begin{tabular}{l}
(String) path: The path to examine  \\
\end{tabular}


Returns: (word) 1 if saving is possible, 0 otherwise

Returns TRUE if there would be enough space left on the specified path to save the current game (but doesn't actually save).
\subsubsection{Kernel function 0x64: ValidPath(?)}
\label{id2510437}\hypertarget{id2510437}{}%


\subsubsection{Kernel function 0x65: CoordPri(?)}
\label{id2510445}\hypertarget{id2510445}{}%


\subsubsection{Kernel function 0x66: StrAt (String, word[, char])}
\label{id2510451}\hypertarget{id2510451}{}%
\label{id2510457}kfunct 0x66: StrAt();
        \newline
        String src, word offset[, char replacement];

\begin{tabular}{l}
(String) src: The string to read from  \\
(word) offset: The offset inside the string  \\
(char) replacement: An optional replacement value for the indexed character  \\
\end{tabular}


Returns: (char) The character requested

This function retreives a single character from a string. Optionally, if {\ttfamily\itshape{{replacement}}} is set, the source character will be replaced with the specified {\ttfamily\itshape{{replacement}}}.
\subsubsection{Kernel function 0x67: DeviceInfo(word, String[, String])}
\label{id2510518}\hypertarget{id2510518}{}%
\label{id2510525}kfunct 0x67: DeviceInfo();
        \newline
        word sub\_function, String string1[, String string2];

\begin{tabular}{l}
(word) sub\_function: A numeric value from 0 to 3, inclusive. See below.  \\
(String) string1: See below.  \\
(String) string2: See below.  \\
\end{tabular}


Returns: See below

Depending on the value of sub\_function, this system call executes one of four defined actions: 

\begin{tabular}{ll}
0& GET\_DEVICE  \\
1& GET\_CURRENT\_DEVICE  \\
2& PATHS\_EQUAL  \\
3& IS\_FLOPPY  \\
\end{tabular}

 See the specific function definitions below for more information.
\subsubsection{Kernel function 0x67: DeviceInfo(GET\_DEVICE, String, String)}
\label{id2510593}\hypertarget{id2510593}{}%
\label{id2510599}kfunct 0x67: DeviceInfo();
        \newline
        word GET\_DEVICE, String input, String output;

\begin{tabular}{l}
(word) GET\_DEVICE: Constant sub-function identifier (0)  \\
(String) input: A path whose device identifier should be extracted  \\
(String) output: The destination of the device identifier  \\
\end{tabular}


Returns: (HeapPtr) Points to the terminating zero character of output

GET\_DEVICE returns the drive/device on which "input" resides in output (and a pointer to the terminating NULL in the accumulator).
\subsubsection{Kernel function 0x67: DeviceInfo(GET\_CURRENT\_DEVICE, String output)}
\label{id2510651}\hypertarget{id2510651}{}%
\label{id2510657}kfunct 0x67: DeviceInfo();
        \newline
        word GET\_CURRENT\_DEVICE, String output;

\begin{tabular}{l}
(word) GET\_CURRENT\_DEVICE: Constant sub-function identifier (1)  \\
(String) output: The destination which the CWD device identifier should be written to.  \\
\end{tabular}


Returns: (HeapPtr) Points to the terminating null character of output

GET\_CURRENT\_DEVICE returns the drive/device that contains the current working directory (and a pointer to the terminating NULL in the accumulator)
\subsubsection{Kernel function 0x67: DeviceInfo(PATHS\_EQUAL, String path1, String path2)}
\label{id2510703}\hypertarget{id2510703}{}%
\label{id2510710}kfunct 0x67: DeviceInfo();
        \newline
        word PATHS\_EQUAL, String path1, String path2;

\begin{tabular}{l}
(word) PATHS\_EQUAL: Constant sub-function identifier (2)  \\
(String) path1: First path to compare  \\
(String) path2: Second path to compare  \\
\end{tabular}


Returns: (word) 1 if path1 and path2 point to the same physical location, 0 otherwise.

PATHS\_EQUAL returns TRUE if the two supplied paths point to the same place.
\subsubsection{Kernel function 0x67: DeviceInfo(IS\_FLOPPY, String path)}
\label{id2510759}\hypertarget{id2510759}{}%
\label{id2510766}kfunct 0x67: DeviceInfo();
        \newline
        word IS\_FLOPPY, String path;

\begin{tabular}{l}
(word) IS\_FLOPPY: Constant sub-function identifier (3)  \\
(String) path:  \\
\end{tabular}


Returns: (word) 1 if {\ttfamily\itshape{{path}}} is on a floppy disk, 0 otherwise

PATHS\_EQUAL returns TRUE if the two supplied paths point to the same place.
\subsubsection{Kernel function 0x68: GetSaveDir()}
\label{id2510814}\hypertarget{id2510814}{}%
\label{id2510820}kfunct 0x68: GetSaveDir();
        \newline
        ;
Returns: (String)

This function returns the heap position allocated to store the string representation of the save game directory. This heap space is allocated automatically during startup.
\subsubsection{Kernel function 0x69: CheckSaveGame(String, word[, String])}
\label{id2510840}\hypertarget{id2510840}{}%
\label{id2510846}kfunct 0x69: CheckSaveGame();
        \newline
        String game\_id, word game\_nr[, String version];

\begin{tabular}{l}
(String) game\_id: The savegame ID string  \\
(word) game\_nr: The savegame number  \\
(String) version: An optional game version string  \\
\end{tabular}


Returns: (word) 1 if the savegame is loadable, 0 otherwise

Returns TRUE if the specified save game is valid and loadable (i.e., not for another game/interpreter/version).
\subsubsection{Kernel function 0x6a: ShakeScreen(word[, word])}
\label{id2510896}\hypertarget{id2510896}{}%
\label{id2510903}kfunct 0x6a: ShakeScreen();
        \newline
        word times [, word direction];

\begin{tabular}{l}
(word) {\ttfamily\itshape{{times}}}: Number of times to shake the screen  \\
(word) {\ttfamily\itshape{{direction}}}: See below  \\
\end{tabular}


Returns: (void)

If {\ttfamily\itshape{{direction}}} is not specified, it defaults to 1. It is a bitmask and defined as follows: 

\begin{tabular}{ll}
bit 0& Shake 10 pixels downwards  \\
bit 1& Shake to the right  \\
bit 2& Unknown, but used  \\
\end{tabular}

\subsubsection{Kernel function 0x6b: FlushResources(?)}
\label{id2510981}\hypertarget{id2510981}{}%


\subsubsection{Kernel function 0x6c: SinMult(?)}
\label{id2510990}\hypertarget{id2510990}{}%


\subsubsection{Kernel function 0x6d: CosMult(?)}
\label{id2510998}\hypertarget{id2510998}{}%


\subsubsection{Kernel function 0x6e: SinDiv(?)}
\label{id2511007}\hypertarget{id2511007}{}%


\subsubsection{Kernel function 0x6f: CosDiv(?)}
\label{id2511016}\hypertarget{id2511016}{}%


\subsubsection{Kernel function 0x70: Graph(?)}
\label{id2511024}\hypertarget{id2511024}{}%


\subsubsection{Kernel function 0x71: Joystick(word, word)}
\label{id2511030}\hypertarget{id2511030}{}%
\label{id2511036}kfunct 0x71: Joystick();
        \newline
        word subfunction, word param;

\begin{tabular}{l}
(word) subfunction: Always 0x0c  \\
(word) param: Parameter for the subfunction, purpose unknown.  \\
\end{tabular}


Returns: (void)



% -------------------------------------------------------------
% Chapter SCI in action 
% -------------------------------------------------------------         
\chapter{SCI in action}
\label{id2517484}\hypertarget{id2517484}{}%

% ------------------------   
% Section 
\section{Event handling in SCI}
\label{LarsEvents}\hypertarget{LarsEvents}{}%

By Lars Skovlund

Version 1.0, 12. July 1999

This article will deal with the event manager in SCI. Like several other key parts of the interpreter, this one actively communicates with the SCI application. It directly writes to objects of the Event class, but more on that later.

The different input devices are polled differently: 
\begin{itemize}
%--- Item
\item 
The keyboard is typically polled at each timer tick (which is 60 hz).


%--- Item
\item 
SCI sets up a callback for the PC mouse driver, meaning that the mouse driver "polls itself" and sends information to the interpreter. On non-MS-DOS platforms, this would probably be done in the timer handler. \label{id2517537}\begingroup\catcode`\#=12\footnote{
The default FreeSCI event mechanism uses libgii, which is completely event-based.
}\endgroup\docbooktolatexmakefootnoteref{id2517537}


%--- Item
\item 
The joystick is only polled when the script wants to.

\end{itemize}
\noindent 

Some parts of the event mechanism (in particular, keyboard management) are very PC specific, and a conversion will no doubt have to take place on other platforms.
\subsection{Event types and modifiers}
\label{id2517555}\hypertarget{id2517555}{}%

There are three types of events, distinguished by their "type" property. The possible values are listed below; they are laid out as a bitfield to allow for selective event retrieval, see later. 

\begin{tabular}{ll}
0x00 & Null event  \\
0x01 & Mouse button event  \\
0x02 & Mouse button release event  \\
0x04 & Keyboard event  \\
0x40 & Movement (joystick) event  \\
\end{tabular}


This type is returned to the SCI event managers by the input device drivers along with a "message" and a set of "modifiers". This is the basic event structure, although some event types contain extra information. The latter field is a direct copy of the BIOS shift flags, laid out as follows:


\begin{tabular}{ll}
bit 7 & Insert active  \\
bit 6 & Caps lock active  \\
bit 5 & Num lock active  \\
bit 4 & Scroll lock active  \\
bit 3 & Alt key pressed  \\
bit 2 & Ctrl key pressed  \\
bit 1 & Left shift key pressed  \\
bit 0 & Right shift key pressed  \\
\end{tabular}


It is obvious, then, that these keys by themselves don't generate any keyboard events. They can, however, be combined with other keys or mouse clicks to produce "shift-click" events, for instance.
\subsubsection{The null events}
\label{id2517642}\hypertarget{id2517642}{}%

These are generated when a script wants to see an event, but there isn't one to give. The current tick count and mouse position. The tick count, as explained in another document, is the time passed since the interpreter started, measured in 1/60ths of a second. It doesn't seem to be copied into the event object, however.
\subsubsection{The mouse events}
\label{id2517657}\hypertarget{id2517657}{}%

The mouse position is returned in extra fields in the event record.

If the middle or right button is pressed, this is reflected by the modifiers, in addition to the mouse event. The middle button is translated to the Ctrl key (i.e. set modifiers bit 2), the right button "holds down" both shift keys (setting bits 1 and 0). Every SCI interpreter (at least from 0.000.572 and up) does this, but to my knowledge it is used only in QfG2, where either a shift-click or a right-click is equivalent to typing "look ...".
\subsubsection{The keyboard event}
\label{id2517677}\hypertarget{id2517677}{}%

The keyboard driver also generates events. When a key is pressed, a keyboard event is generated, with the message field set to the scan code of the pressed key. It should be simple enough, right? Not quite so. The script may want to know if a direction key was pressed, and if so, which. It may call the KMapKeyToDir kernel function for this. KMapKeyToDir takes a keyboard event as input and converts it to a movement event, which is described next.
\subsubsection{The movement event}
\label{id2517693}\hypertarget{id2517693}{}%

The movement event is only generated by the joystick driver. However, on request, the keyboard driver can convert keyboard events into movement events as described above. The message field is just a direction code, mapped as follows: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2517705}\hypertarget{id2517705}{}%

\begin{tabular}{|c|c|c|}
\hline 
{{8}} & {{1}} & {{2}} \tabularnewline
 \hline 
{{7}} & {{Center}} & {{3}} \tabularnewline
 \hline 
{{6}} & {{5}} & {{4}} \tabularnewline
\hline 
\end{tabular}
\end{center}



That is, the direction code starts at straight up (code 1), increasing with clockwise movement.

% ------------------------   
% Section 
\section{The Parser}
\label{LarsDMParser}\hypertarget{LarsDMParser}{}%
\subsection{Vocabulary file formats}
\label{id2517775}\hypertarget{id2517775}{}%

By Lars Skovlund

Version 1.0, 30. July 1999
\subsubsection{The main vocabulary (VOCAB.000)}
\label{id2517794}\hypertarget{id2517794}{}%

The file begins with a list of 26 offsets. Each index corresponds to a letter in the (English) alphabet, and points to the first word starting with that letter. The offset is set to 0 if no words start with that letter. If an input word starts with an alphabetical letter, this table is used to speed up the vocabulary searching - though not strictly necessary, this speeds up the lookup process somewhat.

After the offset table are the actual words. A word defition consists of two parts: The actual text of the word, compressed in a special way, and a 24-bit (yes, three bytes) ID. The ID divided in 2 12-bit quantities, a word class (grammatically speaking) mask, and a group number. The class mask is used, among other things, for throwing away unnecessary words. "Take book", for instance, is a valid sentence in parser'ese, while it isn't in English.

The possible values are arranged as a bit field to allow for class masks, see later. Only one bit is actually tested by the interpreter. If a word class equals to 0xff ("anyword"), the word is excluded (allowing for parser'ese). The values go like this: 

\begin{tabular}{lp{13cm}}
0x001 & number (not found in the vocabulary, set internally)  \\
0x002 & special  \\
0x004 & special  \\
0x008 & special\label{id2517843}\begingroup\catcode`\#=12\footnote{
The three special classes are apparently used for words with very specific semantics, such as "if", "not", "and" etc. It is unknown as of yet whether they receive special treatment by the parser.
}\endgroup\docbooktolatexmakefootnoteref{id2517843}  \\
0x010 & preposition  \\
0x020 & article  \\
0x040 & qualifying adjective  \\
0x080 & relative pronoun  \\
0x100 & noun  \\
0x200 & indicative verb (such as "is", "went" as opposed to \_do\_ this or that, which is imperative)  \\
0x400 & adverb  \\
0x800 & imperative verb  \\
\end{tabular}


The group number is used to implement synonyms (words with the same meaning), as well as by the Said instruction to identify words. There is also a way of using synonyms in code, see the appropriate document.

The compression works in this way: Each string starts with a byte-sized copy count. This many characters are retained from the previous string. The actual text comes after, in normal low-ascii. The last character in the text has its high bit set (no null termination!).

Here is an example of the compression scheme: 

\begin{tabular}{ll}
apple & 0,appl\textbackslash0xE5  \\
\end{tabular}


The byte count is 0 because we assume that "apple" is the first word beginning with an a (not likely, though!). 0xE5 is 0x65 (the ascii value for 'e') \docbooktolatexpipe{} 0x80. Watch now the next word: 

\begin{tabular}{ll}
athlete & 1,thlet\textbackslash0xE5  \\
\end{tabular}


Here, the initial letter is identical to that of its predecessor, so the copy count is 1. Another example: 

\begin{tabular}{ll}
atrocious & 2,rociou\textbackslash0xF3  \\
\end{tabular}

\subsubsection{The suffix vocabulary (VOCAB.901)}
\label{id2517937}\hypertarget{id2517937}{}%

For the following section, a reference to a grammar book may be advisable.

The suffix vocabulary is structurally much simpler. It consists of variably-sized records with this layout: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2517953}\hypertarget{id2517953}{}%

\begin{tabular}{|c|c|}
\hline 
{{NULL-TERMINATED}} & {{Suffix string}} \tabularnewline
 \hline 
{{WORD}} & {{The class mask for the suffix}} \tabularnewline
 \hline 
{{NULL-TERMINATED}} & {{Reduced string}} \tabularnewline
 \hline 
{{WORD}} & {{The output word class}} \tabularnewline
\hline 
\end{tabular}
\end{center}



The suffix vocabulary is used by the interpreter in order to parse compound words, and other words which consist of more than one part. For instance, a simple plural noun like "enemies" is reduced to its singular form "enemy", "stunning" is converted to "stun" etc. The point is that the interpreter gets a second chance at figuring out the meaning if the word can not be identified as entered. A word which changes its class does might end up as a different word class, the correct class is always retained. Thus, "carefully", an adverb, is reduced to its adjectival form "careful", and found in the vocabulary as such, but it is still marked as an adverb.

The suffix vocabulary consists of variably-sized records with this layout: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2518025}\hypertarget{id2518025}{}%

\begin{tabular}{|c|c|}
\hline 
{{NULL-TERMINATED}} & {{Suffix string}} \tabularnewline
 \hline 
{{WORD}} & {{The output word class}} \tabularnewline
 \hline 
{{NULL-TERMINATED}} & {{Reduced string}} \tabularnewline
 \hline 
{{WORD}} & {{The allowed class mask for the reduced word}} \tabularnewline
\hline 
\end{tabular}
\end{center}



An asterisk (*) represents the word stem. Taking the above example with "enemies", the interpreter finds this record: 

\begin{tabular}{l}
\texttt{*ies}  \\
0x100  \\
\texttt{*y}  \\
0x100  \\
\end{tabular}

 word class 0x100 being a noun.

The interpreter then tries to replace "enemies" with "enemy" and finds that word in the vocabulary. "Enemy" is a noun (class 1), which it is also supposed to be, according to the suffix vocabulary. Since we succeeded, the word class is set to the output value (which is, incidentally, also 1).
\subparagraph*{Numbers}
\label{id2518113}\hypertarget{id2518113}{}%

If the word turns out to be a number (written with numbers, that is), and that number is not listed explicitly in the vocabulary, it gets an ID of 0xFFD, and a word class of 0x100.
\subsubsection{The tree vocabulary (VOCAB.900)}
\label{id2518126}\hypertarget{id2518126}{}%

This vocabulary is used solely for building parse trees. It consists of a series of word values which end up in the data nodes on the tree. It doesn't make much sense without the original parsing code.
\subsection{The black box: The magic behind Sierra's text parser}
\label{id2518140}\hypertarget{id2518140}{}%

By Lars Skovlund

Version 0.1, 30. July 1999. Incomplete!

This document describes the process of parsing user input and relating it to game actions. This document does not describe the process of the user typing his command; only the "behind-the-scenes" work is described, hence the title.

The process of parsing is two-fold, mainly for speed reasons. The Parse kernel function takes the actual input string and generates a special "said" event (type 0x80) from it. This function is only called once per line. Parse can either accept or reject the input.

A rejection can only occur if Parse fails to identify a word in the sentence.

 Even if Parse accepts the sentence, it does not need to make sense. Still, syntax checks are made - see later.

Assuming that the parsing succeeded, the User object (which encapsulates the parser) then goes on to call the relevant event handlers. These event hand- lerrs in turn call the Said kernel function. This function is potentially called hundreds or even thousands of times, so it must execute as quickly as possible. Said simply determines from the pre-parsed input line whether or not a specific command is desired.

The Parse function must always work on an internal copy of the actual string, because the user must be able to recall his exact last input using the F3 key. The parser's first step is to convert the input line to pure lower case. This is because the vocabulary words are entered in lower case. The parser then searches the main vocabulary (VOCAB.000), hoping to find the word.

This doesn't necessarily happen yet. Consider, for example, the meaning of the word "carefully", which does not appear in the vocabulary, but is found anyway. This is due to the so-called suffix vocabulary, which is discussed in another document.

If the word still can't be found, the interpreter copies the failing word into a buffer temporarily allocated on the heap (remember, the interpreter operates on its own local buffers). It then calls the Game::wordFail method which prints an appropriate message. The interpreter then deallocates the buffer and exits (it does, however, still return an event. The claimed property of that event is set to TRUE to indicate that the event has already been responded to (error message printed)).

If the interpreter succeeds in identifying all the words, it then goes on to check the syntax of the sentence - it builds a parse tree. See the appropri- ate document.

If the syntax of the sentence is invalid, the interpreter calls Game::syntaxFail, passing the entire input line. As for the error situation, the event is claimed.

As mentioned in the beginning of this text, this function generates an event. This event, apart from its type id, does not contain any data. Rather, all pertinent data is kept in the interpreter.

The Said kernel function is called for each command which the game might respond to at any given time. Its only parameter is a pointer to a said information block which resides in script space. This block is described below (see \hyperlink{CRSaidSpec}{Section~{\ref{CRSaidSpec}}}).

The Said function first does some sanity checking on the event pointer which Parse stored earlier. It must be a said event (type property), and it must not have been handled by an earlier call to Said (claimed property).

It then word-extends the passed said block into a temporary buffer (command codes are byte-sized, remember?). This is supposedly just for convenience/speed, and not really needed.
\subsection{The Parse tree}
\label{id2518253}\hypertarget{id2518253}{}%


This and the two following sections borrow some ideas and structures from abstract language theory. Readers might want to consider related literature.

Most of the information explained here was gathered by Lars Skovlund, and, before that, Dark Minister.



After tokenizing, looking up, and finally aliasing the data found in the parsed input string, the interpreter proceeds to build a parse tree $T_\Pi$ from the input tokens
\[ I := w_0, w_1, w_2 \ldots w_{n-1} \]
 where 
\begin{itemize}
\item $w_j \in W$
\item $\gamma_j \in \Gamma$
\item $\mu_j \in 2^C$
\item $w_j = (\gamma_j, \mu_j$
\end{itemize}
 with $W$ being the set of all words, $\Gamma$ being the set of all word groups, $C$ being the set of all class masks $\{1, 2, 4, 8, 10, 20, 40, 80, 100\}$, $\gamma_j$ being the word group $w_j$ belongs to, and $\mu_j$ being its class mask, as described above.

For the following sections, we define
\begin{itemize}
\item $\textrm{group}: W \to \Gamma. \textrm{group}: (\gamma, \mu) \mapsto \gamma$
\item $\textrm{classes}: W \to C. \textrm{classes}: (\gamma, \mu) \mapsto \mu$
\item $ C_x = \{ w | w \in W. x \in \textrm{class}(w) \}$
\end{itemize}

 To do that, it uses the class masks $M$ as input for a pushdown automaton (PDA) A built from a parser grammar; if $M$ was accepted by $A$, the parse tree $T_\Pi$ will be built from the matching syntax tree to represent the semantics.

The PDA is defined by a grammar $G=(V, \Sigma, P, s)$, most of which, along with its semantics, is stored in \resource{vocab.900}. This resource contains a parser rule at every 20 bytes, starting with a non-terminal symbol $v$ (one word) and a null-terminated list of up to five tuples $\tuple{\sigma_i, m_i}$, both of which are words. In these tuples, $m_i$ is a terminal or non-terminal symbol (determined by $\sigma_i$), and $\sigma_i$ is the meaning of $m_i$: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2518409}\hypertarget{id2518409}{}%

\begin{tabular}{|c|c|p{5cm}|}
\hline 
{{$\sigma_i$}} & {{Type}} & {{Meaning}} \tabularnewline
 \hline 
{{0x141}} & {{Non-terminal}} & {{Predicate part: This identifies the first part of a sentence}} \tabularnewline
 \hline 
{{0x142}} & {{Non-terminal}} & {{Subject part: This identifies the second part of a sentence}} \tabularnewline
 \hline 
{{0x143}} & {{Non-terminal}} & {{Suffix part: This identifies the third and last part of a sentence}} \tabularnewline
 \hline 
{{0x144}} & {{Non-terminal}} & {{Reference part: This identifies words that reference another word in the same sentence part}} \tabularnewline
 \hline 
{{0x146}} & {{Terminal}} & {{Match on class mask: Matches if $m_i \in \textrm{classes}(w_j)$}} \tabularnewline
 \hline 
{{0x14d}} & {{Terminal}} & {{Match on word group: Matches if ($m_i = \textrm{group}(w_j)$}} \tabularnewline
 \hline 
{{0x154}} & {{Terminal}} & {{"Force storage": Apparently, this was only used for debugging.}} \tabularnewline
\hline 
\end{tabular}
\end{center}

 With the notable exception of the first rule, these rules constitute $P$. $V := \{ x | \exists R \in P. x \in R \}$; typically, $V = \{0x12f ... 0x13f\}$. $s = m_0$ of the first rule encountered; in all games observed, it was set to 0x13c. $\Sigma$ contains all word groups and class masks. For the sake of simplicity, we will consider rules matching composite class masks to be several rules. Here is a simplified example of what such a grammar might look like (the hexadecimal prefix '0x' is omitted for brevity): 
\begin{example}%
\hypertarget{id2518423}{}%
\captionswapskip{}{{\caption{Parse grammar example}\label{id2518423}}}
\captionswapskip{}
\begin{eqnarray*}
G & = & \tuple \{12f ... 13e\}, \{C_1, C_2, C_4, \ldots, C_100\}, P, 13c) \\
P & = & \{ \begin{array}{rcl}
           13c &\to& 13b\ 134 \\
           13c &\to& 13b\ 13d\ 133 \\
           13c &\to& 13b\ 13d \\
           13c &\to& 13b\\ 
           13c &\to& 13b\ 13d\ 13b\ 13d \\
           13b &\to& 131\ 134 \\
           13b &\to& 131\ 13d\ 13d \\
           13b &\to& 131 \\
           13d &\to& 134 \\
           131 &\to& C_80 \\
           133 &\to& C_20 \\
           134 &\to& C_10 \}
          \end{array}
\end{eqnarray*}

\end{example}

 In addition to this grammar, each right-hand non-terminal $m_i$ carries its semantic value $\rho_i$, which is not relevant for constructing a syntax tree, but must be considered for the semantic tree $T_\Pi$. These values were omitted in the example above. As in the example above, the grammar is a context-free (type 2) grammar, almost in Chomsky Normal Form (CNF) in SCI; constructing a grammar with CNF rules from it would be trivial. \label{id2518628}\begingroup\catcode`\#=12\footnote{
FreeSCI constructs a GNF (Greibach Normal Form) representation from these rules for parsing.
}\endgroup\docbooktolatexmakefootnoteref{id2518628} 
\begin{example}%
\hypertarget{id2518637}{}%
\captionswapskip{}{{\caption{Parser example}\label{id2518637}}}
\captionswapskip{}
Parse is called with ``\texttt{open door}''.
\begin{itemize}
\item $\textrm{``\texttt{open}''} \in \tuple{842, \{C_80\}}$ (an imperative word of the word group 0x842)
\item $\textrm{``\texttt{door}''} \in \tuple{917, \{C_10\}}$ (a substantive of the word group 0x917)
\item $I = \tuple{842, \{C_80\}}, \tuple{917, \{C_10\}}$
\end{itemize}
 I is clearly accepted by automatons based on the grammar described above. Here are two possible derivations:
\begin{eqnarray*}
                        & D_0 = & 13c \\
(13c \to 13b 134)       &&      \vdash 13b\ 134 \\
(13b \to 131)           &&      \vdash 131\ 134 \\
(131 \to C_{80})        &&      \vdash C_{80}\ 134 \\
(134 \to C_{10})        &&      \vdash C_{80}\ C_{10}
\end{eqnarray*}

\begin{eqnarray*}
                        & D_1 = & 13c \\
(13c \to 13b)           &&      \vdash 13b \\
(13b \to 131 134)       &&      \vdash 131\ 134 \\
(131 \to C_{80})        &&      \vdash C_{80}\ 134 \\
(134 \to C_{10})        &&      \vdash C_{80}\ C_{10}
\end{eqnarray*}

\end{example}

 Obviously, G is an ambiguous grammar. In SCI, rule precedence is implied by rule order, so the resulting left derivation tree is well-defined (in the example, it would be defined by $D_0$) \label{id2518727}\begingroup\catcode`\#=12\footnote{
In FreeSCI, you can use the "parse" console command to retreive all possible left derivation trees
}\endgroup\docbooktolatexmakefootnoteref{id2518727}.
\subsubsection{Semantics}
\label{id2518734}\hypertarget{id2518734}{}%

This is important, since the parser does much more than just accept or discard input. Using the semantic tags applied to each non-terminal on the right-hand side of a rule, it constructs what I will call the semantic parse tree $T_{\Pi}$, which attempts to describe what the input means. For each non-terminal rule

\[
r = v_0 \to v_1 v_2 \ldots v_n
\]

 there are semantic tags $\sigma_{r,1}, \sigma_{r,2} \ldots \sigma_{r,n} \in S$, as explained above. $T_{\Pi}$ is now constructed from the resulting derivation and the semantic tags assiociated with each non-terminal of the rule used. The construction algorithm is explained below with $T_{\Pi}$ being constructed from nodes, which have the following structure:
\[
\Node = \{\diamond\} \cup S \times V \times (\Node \cup \Gamma)*;
\]

 Where S is the set of possible semantic values, and V is the set of non-terminals as defined in the grammar. We will also use the sequence $\gamma_{0}, \gamma_{1}, \gamma_{2} \ldots \gamma_{k-1}$, which will represent the word groups the input tokens belonged to (in the exact order they were accepted), and the sequence $r_{0}, r_{1}, r_{2} \ldots r_{l-1}$, which will be the list of rules used to create the left derivation tree as described in the previous section. 
\begin{Verbatim}[]

              Helper function sci_said_recursive: S \times V \times (V \cup \Sigma)* \to \Node
              Parameters: s \in S, Rule r \in V \times (V \cup \Sigma): v0 \to v1 v2 ... vi
              cnmr = cnr
              \Node n := s, v0
              FOR j := 1 TO i
                        IF (vj \in \Sigma) THEN
                                n := n, \gammacn\gamma
                                cn\gamma := cn\gamma + 1
                        ELSE
                                cnoldr := cnr
                                cnr := cnr + 1
                                n := n, sci_said_recursive(\sigmarmr,j, rcnoldr)
                        FI
              ROF
              RETURN (n)


              Helper function get_children: \Node \to \Node*
                              get_children((s, v, n0, n1 ... nm)) := n0, n1 ... nm


              Algorithm SCI-SAID-TREE
              cn\gamma := 0;
              cnr := 1;
              ntemp := ntemp, SCI-SAID-RECURSIVE(0, r0)
              root(T\Pi) := (141, 13f, get_children(ntemp))
                            
\end{Verbatim}
 Here is an example, based on the previous one: 
\begin{example}%
\hypertarget{id2518966}{}%
\captionswapskip{}{{\caption{Semantic tree example}\label{id2518966}}}
\captionswapskip{}

\begin{itemize}
\item $k = 2$
\item $\gamma_{0} = 842$
\item $\gamma_{1} = 917$
\item $l = 4$
\item $r_0 = 13c \to 13b\ 134$
\item $\sigma_{{r_0},1} = 141$
\item $\sigma_{{r_0},2} = 142$
\item $r_1 = 13b \to 131$
\item $\sigma_{r_{1},1} = 141$
\item $r_2 = 131 \to C_{80}$
\item $r_3 = 134 \to C_{10}$
\end{itemize}
 The resulting tree would look like this:
\begin{verbatim}
(141 13f
        (141 13b
                (141 131 842)
        )
        (142 134 917)
)
\end{verbatim}
\end{example}


\subsection{Said specs}
\label{CRSaidSpec}\hypertarget{CRSaidSpec}{}%

To test what the player wanted to say, SCI compares $T_\Pi$ with a second tree, $T_\Sigma$, which is built from a so-called Said spec. A Said spec is a variable-sized block in SCI memory which consists of a set of byte-sized operators and special tokens (stored in the range 0xf0 to 0xf9) and word groups (in big-endian notation, so that they don't conflict with the operators); it is terminated by the special token 0xff. The meanings of the operators and special tokens are as follows: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2519056}\hypertarget{id2519056}{}%

\begin{tabular}{|c|c|p{4cm}|}
\hline 
{{Operator}} & {{Byte representation}} & {{Meaning}} \tabularnewline
 \hline 
{{,}} & {{f0}} & {{"OR". Used to specify alternatives to words, such as "take , get".}} \tabularnewline
 \hline 
{{\&}} & {{f1}} & {{Unknown. Probably used for debugging.}} \tabularnewline
 \hline 
{{/}} & {{f2}} & {{Sentence part separator. Only two of these tokens may be used, since sentences are split into a maximum of three parts.}} \tabularnewline
 \hline 
{{(}} & {{f3}} & {{Used together with ')' for grouping}} \tabularnewline
 \hline 
{{)}} & {{f4}} & {{See '('}} \tabularnewline
 \hline 
{{[}} & {{f5}} & {{Used together with '[' for optional grouping. "[ \textit{a} ]" means "either \textit{a} or nothing"}} \tabularnewline
 \hline 
{{]}} & {{f6}} & {{See '['.}} \tabularnewline
 \hline 
{{\#}} & {{f7}} & {{Unknown. Assumed to have been used exclusively for debugging, if at all.}} \tabularnewline
 \hline 
{{\textless{}}} & {{f8}} & {{Semantic reference operator (as in "get \textless{} up").}} \tabularnewline
 \hline 
{{\textgreater{}}} & {{f9}} & {{Instructs Said() not to claim the event passed to the previous Parse() call on a match. Used for successive matching.}} \tabularnewline
\hline 
\end{tabular}
\end{center}



This sequence of operators and word groups is now used to build the Said tree $T_{\Sigma}$. I will describe the algorithm used to generate $T_{\Sigma}$ by providing a grammar $G_{\Sigma}$, with $L(G_{\Sigma})$ containing all valid Said specs. The semantics will be provided under each rule with a double arrow: 
\begin{Verbatim}[]

        G\Sigma = ({saidspec, optcont, leftspec, midspec, rightspec, word, cwordset, wordset, expr, cwordrefset, wordrefset, recref}, \Gamma, P, saidspec)

        P := {
          saidspec \to   leftspec optcont
                                \Rightarrow (141 13f leftspec optcont)
                        | leftspec midspec optcont
                                \Rightarrow (141 13f leftspec midspec optcont)
                        | leftspec midspec rightspec optcont
                                \Rightarrow (141 13f leftspec midspec rightspec optcont)



          optcont \to   e
                                \Rightarrow
                        | >
                                \Rightarrow (14b f900 f900)



          leftspec \to  e
                                \Rightarrow
                        | expr
                                \Rightarrow (141 149 expr)



          midspec \to    / expr
                                \Rightarrow (142 14a expr)
                        | [ / expr ]
                                \Rightarrow (152 142 (142 14a expr))
                        | /
                                \Rightarrow



          rightspec \to  / expr
                                \Rightarrow (143 14a expr)
                        | [ / expr ]
                                \Rightarrow (152 143 (143 14a expr))
                        | /
                                \Rightarrow


          word \to       \gamma \in \Gamma
                                \Rightarrow (141 153 \gamma)


          cwordset \to   wordset
                                \Rightarrow (141 14f wordset)
                        | [ wordset ]
                                \Rightarrow (141 14f (152 14c (141 14f wordset)))


          wordset \to    word
                                \Rightarrow word
                        | ( expr )
                                \Rightarrow (141 14c expr)
                        | wordset , wordset
                                \Rightarrow wordset wordset
                        | wordset , [ wordset ]
                                \Rightarrow wordset wordset


          expr \to               cwordset cwordrefset
                                \Rightarrow cwordset cwordrefset
                        | cwordset
                                \Rightarrow cwordset
                        | cwordrefset
                                \Rightarrow cwordrefset
        

          cwordrefset \to        wordrefset
                                \Rightarrow wordrefset
                        | [ wordrefset ]
                                \Rightarrow (152 144 wordrefset)


          wordrefset \to        < wordset recref
                                \Rightarrow (144 14f word) recref
                        | < wordset
                                \Rightarrow (144 14f word)
                        | < [ wordset ]
                                \Rightarrow (152 144 (144 14f wordset))


          recref \to    < wordset recref
                                \Rightarrow (141 144 (144 14f wordset) recref)
                        | < wordset
                                \Rightarrow (141 144 (144 14f wordset))
        }
                  
\end{Verbatim}

\subsection{Matching the trees}
\label{id2519261}\hypertarget{id2519261}{}%

The exact algorithm used to compare $T_{\Pi}$ to $T_{\Sigma}$ is not known yet. The one described here is based on the approximation used in FreeSCI, which is very similar to the original SCI one.

First, we need to describe a set of functions for traversing the nodes of $T_\Sigma$ and $T_\Pi$, and doing some work. They will be operating on the sets $\nat$ (all non-negative integral numbers), $\bool = \{\Btt, \Bff\}$ (Booleans), and $\Node$ (which we defined earlier).

\begin{eqnarray}
\textrm{first}: && \Node \to S \\
\textrm{first}: && \tuple{s, v, n_{0}, n_{1} \ldots n_{i}} \mapsto s \\
\\
\textrm{second}: && Node \to V \\
\textrm{second}: && \tuple{s, v, n_{0}, n_{1} \ldots n_{i}} \mapsto v \\
\\
\textrm{word}: && Node \to \Gamma \\
\textrm{word}: \tuple{s, v, \gamma} \mapsto \gamma \\
\\
\textrm{children}: && \Node \to \Node* \\
\textrm{children}: \tuple{s, v, n_{0}, n_{1} \ldots n_{i}} \mapsto \{ m | \forall m.m\in\{ n_{0}, n_{1} \ldots n_{i} \} \land m\in Node \} \\
\\
\textrm{all\_children}: && \Node \to \Node* \\
\textrm{all\_children}: n \mapsto \textrm{children}(n) \cup \{ m \docbooktolatexpipe{} \exists l.l \in\textrm{all\_children}(n).m\in l \} \\
\\
\textrm{is\_word} : && \Node \to B \\
\textrm{is\_word} : \tuple{s, v, n_{0}, n_{1} \ldots n_{i}} = \Btt \iff (i = 0) \land n_{0} \in \Gamma \\
%\textrm{contains\_word}: && \Node \times S \times \Gamma \to B contains\_word(n, s, \gamma) = tt \gamma = 0xfff\label{id2519386}\begingroup\catcode`\#=12\footnote{
%This is the so-called "anyword". Words with a word group of 0xfff match any other word.
%}\endgroup\docbooktolatexmakefootnoteref{id2519386} \lor (\iff \exists m.m\in\textrm{all\_children}(n).(s = \textrm{second}(m)) \land (\textrm{is\_word}(m) \land (\textrm{word}(m) = \gamma))) \\
\textrm{verify\_sentence\_part\_elements}: && \Node \times \Node \to B \\
\textrm{verify\_sentence\_part\_elements}: && \tuple{n_{p}, n_{s}} \mapsto \Btt \iff (\textrm{first}(n_{s} = 152) \land ((\forall m.m \in \Node.\textrm{verify\_sentence\_part\_elements}(m, n_{s}) \iff \{ w \docbooktolatexpipe{} \exists t.t \in \textrm{all\_children}(m).w = \textrm{word}(t)\} = \emptyset) \lor \exists m \in \textrm{children}(n_{s}).\textrm{verify\_sentence\_part\_elements}(m, n_{s})) ) \lor ((\textrm{second}(n_{s}) = 153) \land (\exists m.m \in \textrm{children}(n_{s}).(\exists o \in \textrm{all\_children}(n_{s}).(\textrm{first}(o) = \textrm{first}(n_{p})) \land \textrm{word}(o) = \textrm{word}(m))) ) \lor ((\textrm{second}(n_{s}) \in \{144, 14c\}) \land (\exists m.m \in \textrm{children}(n_{s}).verify\_sentence\_part(m, n_{s}))) \\
\\
\textrm{verify\_sentence\_part}: && \Node \times \Node \to B \\
\textrm{verify\_sentence\_part}: && \tuple{n_{p}, n_{s}} \mapsto \Btt \iff \forall n.n \in \textrm{children}(n_{s}):\exists m.m\in\textrm{children}(n_{p}).(\textrm{first}(m) = \textrm{first}(n)) \land \textrm{verify\_sentence\_part\_elements}(n, m) \\
\\
\textrm{verify\_sentence\_part\_brackets}: && \Node \times \Node \to B \\
\textrm{verify\_sentence\_part\_brackets}: && \tuple{n_{p}, n_{s}} \mapsto \Btt \iff (\textrm{first}(n_{p}) = 152 \land (\forall m.m\in \Node.(\textrm{first}(m) = \textrm{first}(n_{s})) \land (\textrm{second}(m) = \textrm{second}(n_{s})). \textrm{verify\_sentence\_part}(n_{p}, m) \iff \{ w \docbooktolatexpipe{} \exists t.t \in \textrm{all\_children}(m).w = \textrm{word}(t)\} = \emptyset)) \lor ((\textrm{first}(n_{p}) \in \{141, 142, 143\}) \land \textrm{verify\_sentence\_part}(n_{p}, n_{s})) \\
\end{eqnarray}

 With these functions, we can now define an algorithm for augmenting $T_{\Pi}$ and $T_{\Sigma}$:

Algorithm SCI-AUGMENT matched := $\Btt \textrm{claim\_on\_match} := \Btt \texttt{ FOREACH } n \in \textrm{root}(T_{\Sigma}) \texttt{ IF } ((\textrm{first}(n) = 14b) \land (\textrm{second}(n) = f900)) \texttt{ THEN } \textrm{claim\_on\_match} := \Bff \texttt{ ELSE IF } \neg \textrm{verify\_sentence\_part\_brackets}(n, \textrm{root}(T_{\Pi})) \texttt{ THEN } \textrm{matched} := \Bff \texttt{ END-FOREACH}$



 Augmenting succeeded if matched = tt; in this case, $T_{\Pi}$ is one of the trees accepted by the description provided by $T_{\Sigma}$. In this case, Said() will return 1. It will also claim the event previously provided to Parse(), unless claim\_on\_match = $\Bff$.

% ------------------------   
% Section 
\section{Views and animation in SCI}
\label{LarsAnim}\hypertarget{LarsAnim}{}%

by Lars Skovlund

Version 0.2, 4. January 2002, with notes by Christoph Reichenbach

This chapter deals with a rather complex subject within SCI. The subsystem described here is one of the "bad boys" in SCI, since it calls functions in user space, as well as changing the value of various selectors. This document is not necessarily complete. There are several things I have not covered - because they are better off in a separate document, or simply because I haven't yet figured that part out. IOW, this stuff is incomplete. Things may change.

After drawing a pic on the screen (which is DrawPic's job, that doesn't surprise now, does it?), some views have to be added to it. There are two ways of doing this; the AddToPic and the Animate call. While AddToPic is used for static views, Animate lets each animated view in the cast list perform an "animation cycle".

An animation cycle is done entirely in SCI code (with the aid of some kernel calls). It involves two other objects; the mover and the cycler. The mover is responsible for controlling the motion of an actor towards a specific point, while the cycler changes the image of the actor, making him appear to walk, for instance.

The behaviour of a view is controlled by its signal property. This property contains a bitfield which describes a lot of animation-related stuff. The bits can be roughly divided into two groups; the script and interpreter bits (I had called them Option and State bits at first, but that is not entirely accurate). The first group allows the script to influence the drawing pro- cess somewhat, the other are used internally by the interpreter. The two groups overlap a bit, though. 
% table ------------------------------------------------------
\begin{table}[htb]
\begin{center}%
\hypertarget{id2519626}{}%
\captionswapskip{}{{\caption{SCI and FreeSCI signal bits}\label{id2519626}}}
\captionswapskip{}\begin{minipage}{\linewidth}

\begin{tabular}{|c|c|p{3.5cm}|p{8cm}|}
\hline 
{{Bit \#}} & {{Name}} & {{FreeSCI constant {\texttt{\_K\_VIEW\_SIG\_FLAG\_} \ldots}}} & {{Meaning}} \tabularnewline
 \hline 
{{0}} & {{}} & {{STOP\_UPDATE}} & {{A view updating process has ended}} \tabularnewline
 \hline 
{{1}} & {{}} & {{UPDATED}} & {{The view object is being updated}} \tabularnewline
 \hline 
{{2}} & {{noUpd}} & {{NO\_UPDATE}} & {{Don't actually draw the view}} \tabularnewline
 \hline 
{{3}} & {{}} & {{HIDDEN}} & {{The view is hidden from sight. Often, if an actor is supposed to enter and exit a room (such as the guards in the plazas in QfG2), this bit is used. When he's supposed to enter the room, bit 3 in his signal is cleared. When he leaves, bit 3 is set, but his SCI object is not deleted.}} \tabularnewline
 \hline 
{{4}} & {{fixPriOn}} & {{FIX\_PRI\_ON}} & {{if this bit is set, the priority of the view never changes (if it isn't, the interpreter recalculates the priority automagically).}} \tabularnewline
 \hline 
{{5}} & {{}} & {{ALWAYS\_UPDATE}} & {{}} \tabularnewline
 \hline 
{{6}} & {{}} & {{FORCE\_UPDATE}} & {{}} \tabularnewline
 \hline 
{{7}} & {{}} & {{REMOVE}} & {{The view should be removed from the screen (an interpreter bit - its corresponding script bit is bit 3). If bit 3 isn't set as well, the view reappears on the next frame.}} \tabularnewline
 \hline 
{{8}} & {{}} & {{FROZEN}} & {{Deactivates the mover object of the view (it is "frozen" - the view can still turn, however).}} \tabularnewline
 \hline 
{{9}} & {{isExtra}} & {{IS\_EXTRA}} & {{}} \tabularnewline
 \hline 
{{10}} & {{}} & {{HIT\_OBSTACLE}} & {{The view hit an obstacle on the last animation cycle}} \tabularnewline
 \hline 
{{11}} & {{}} & {{DOESNT\_TURN}} & {{Meaningful for actors only. Means that the actor does not turn, even though he is walking the "wrong way".}} \tabularnewline
 \hline 
{{12}} & {{}} & {{NO\_CYCLER}} & {{The view cycler is disabled. This makes the view float instead of walk.}} \tabularnewline
 \hline 
{{13}} & {{ignoreHorizon}} & {{IGNORE\_HORIZON}} & {{}} \tabularnewline
 \hline 
{{14}} & {{ignrAct}} & {{IGNORE\_ACTOR}} & {{Actors can walk in the rectangle occupied by the view. The behaviour of this bit is odd, and best expressed by example. The Guild Master in QfG1 has his bit 14 set. This means that ego (or someone else) can walk all the way to his chair (try sneaking in on him from behind). If we clear this bit, we can't sneak in on him.}} \tabularnewline
 \hline 
{{15}} & {{}} & {{DISPOSE\_ME}} & {{The view should be disposed}} \tabularnewline
 \hline 
{{\label{animate-flags-freesci}\begingroup\catcode`\#=12\footnote{
This flag is used internally in FreeSCI; it can't be found in the view objects, only in their copies in the dynview widget list.
}\endgroup\docbooktolatexmakefootnoteref{animate-flags-freesci}}} & {{}} & {{FREESCI\_PRIVATE}} & {{Used as an intermediate result by the interpreter; marks views that are going to have their nsRect/lsRect regions redrawn (for the test in the main draw algorithm's step 17.1., below)}} \tabularnewline
 \hline 
{{\docbooktolatexusefootnoteref{animate-flags-freesci}}} & {{}} & {{FRESCI\_STOPUPD}} & {{View has been 'stopupdated'. This flag is set whenever the view has the STOP\_UPDATE bit set, and cleared as soon as it moves again. Stopupdated views are collided against differently than normal views.}} \tabularnewline
\hline 
\end{tabular}
\end{minipage}
\end{center}
\end{table}

 The unlisted bits are probably all interpreter bits. They don't seem to have an effect when set. Many bits seem to be involved in the decision whether to display a view or not. I have not completely figured this out. \label{id2520000}\begingroup\catcode`\#=12\footnote{
The bit names I have written come from some debug information I got from QfG2 - type "suck blue frog" then Ctrl-W to save the cast list!
}\endgroup\docbooktolatexmakefootnoteref{id2520000}

Animate (see \hyperlink{KAnimate}{Section~{\ref{KAnimate}}}) can be called in two ways: 

\begin{tabular}{l}
Animate(DblList cast, bool cycle)  \\
Animate()  \\
\end{tabular}

 If the second syntax is used, the two parameters are assumed to be zero.

The cast list is just a list of the views to draw. Animate creates a backup of this list for updating purposes. However, this backup cast list isn't just a normal copy. The interpreter copies some selectors from the view (view, loop, cel, nsRect) and places them in a special data structure. This indicates to me that there is a possibility that the view objects may be deleted even though an update is anticipated.

The general pseudocode for Animate goes as follows: 
\begin{Verbatim}[]

0. Backup PicNotValid: PicNotValid' := PicNotValid
1. If we don't have a new cast:
    1.1. if PicNotValid is set:
        1.1.1. Redraw picture with opening animation
    1.2. exit
2. For each view in the cast list:
    2.1. If view is not frozen:
        2.1.1. call view::doit(), performing an animation cycle
3. Prepare a list of y coordinates by traversing the cast list
4. For each view in the cast list:
    4.1. If the view resource view::view has not been loaded yet:
        4.1.1. Load view.nr, where nr=view::view
5. For each view in the cast list:
    5.1. If view::loop is invalid, set view::loop := 0
    5.2. If view::cel is invalid, set view::cel := 0
6. Sort the cast list, first by y, then by z
7. For each view in the cast list: Update view::nsRect (SetNowSeen())
8. For each view in the cast list: Unless the views' priority is fixed, recalculate it
9. For each view in the cast list:
    9.1. If NO_UPDATE is set for the view:
        9.1.1. If the following holds:
            9.1.1.1.     (VIEW_UPDATED || FORCE_UPDATE)
            9.1.1.2.  || (!(VIEW_UPDATED || FORCE_UPDATE) && !IS_HIDDEN && REMOVE_VIEW)
            9.1.1.3.  || (!(VIEW_UPDATED || FORCE_UPDATE) && !IS_HIDDEN && !REMOVE_VIEW && ALWAYS_UPDATE)
            9.1.1.4.  || (!(VIEW_UPDATED || FORCE_UPDATE) && IS_HIDDEN && ALWAYS_UPDATE)
            9.1.1.5. then increase PicNotValid by one.
        9.1.2. Clear the STOP_UPDATE flag
    9.2. otherwise:
        9.2.1. If (STOP_UPDATE and !ALWAYS_UPDATE) or (!STOP_UPDATE and ALWAYS_UPDATE)
            9.2.1.1. Increase PicNotValid by one
        9.2.2. Clear the FORCE_UPDATE flag
10. If PicNotValid is now greater than zero, call the sub-algorithm described separately
11. For each view: If NO_UPDATE, IS_HIDDEN and ALWAYS_UPDATE are not set:
    11.1. [12] Save the area covered by the view's nsRect, store the handle in view::underBits
    11.2. [13] Draw the view object
    11.3. [14] If the view IS_HIDDEN, clear the REMOVE_VIEW bit (don't need to hide it twice)
    11.4. [15] Insert the view into the backup cast list
16. If PicNotValid', our copy of the initial value of PicNotValid, is non-zero:
    16.1. Refresh entire screen with opening animation
    16.2. PicNotValid := 0
17. For each view in the cast list:
    17.1. [18] If the view was changed in step 10 and neither REMOVE_VIEW nor NO_UPDATE is set:
        17.1.1. [19] Redraw the nsRect and lsRect areas
        17.1.2. [20] Copy the nsRect to the lsRect
        17.1.3. [21] If IS_HIDDEN, set REMOVE_VIEW as well
22. For each view in the reverse cast list:
    22.1. [23] If neither NO_UPDATE nor REMOVE_VIEW is set:
        22.1.1. Restore the underbits
        22.1.2. Clear the underbits
    22.2. [24] if DISPOSE_ME is set, call view::dispose to dispose it

\end{Verbatim}
 With the sub-algorithm being: 
\begin{Verbatim}[]

1. For each view from the cast list:
    1.1. [2] If NO_UPDATE is set:
        1.1.1. [3] If REMOVE_VIEW is set:
            1.1.1.1. If PicNotValid is 0, restore the area covered by view::underBits
            1.1.1.2. Free view::underBits
        1.1.2. [4] Clear FORCE_UPDATE
        1.1.3. [5] If VIEW_UPDATED is set: Clear VIEW_UPDATED and NO_UPDATE
    1.2. otherwise (if NO_UPDATE is not set):
        1.2.1. Clear STOP_UPDATE
        1.2.2. Set NO_UPDATE
6. For each view from the cast list:
    6.1. [7] Draw the view
    6.2. [8] If ALWAYS_UPDATE, clear STOP_UPDATE, VIEW_UPDATED, NO_UPDATE, FORCE_UPDATE
    6.3. [9] Clip the nsRect against the boundaries of the "natural" priority band of the view
    6.4. [10] If IGNORE_ACTOR is clear, fill the area found in 6.3. with 0xf on the control map
11. For each view from the view list:
    11.1. if NO_UPDATE is set:
        11.1.1. [12] If IS_HIDDEN, then set REMOVE_VIEW, otherwise:
            11.1.1.1. clear REMOVE_VIEW
            11.1.1.2. [13] Save the area covered by the nsRect in the underBits
14. For each view from the cast list:
    14.1. If NO_UPDATE is set and IS_HIDDEN is clear:
        14.1.1. [15] Draw the view

\end{Verbatim}


Note that the ReAnimate subfunction (0x0D) of the Graph kernel call redraws parts of the maps using the cast list created by Animate, whereas the ShowBits call (0x0C) copies parts of the active map to the physical screen.

\section{The message subsystem}
The message subsystem developed out of a desire to lessen the amount
of coordinative work between dialogue writers and programmers. The
text resource of early SCI suffered from the limitation of using a
tuple $\langle \textit{module}, \textit{message-id}\rangle$%
\footnote{While \textit{module} was traditionally called \textit{room}
  or \textit{resource number}, I have chosen to use the terminology of
  the later message interface here.}
as index into the text resources. Worse, text resources were often
generated by using special syntax in the source code, thus making the
ordering prone to change as the code was extended and reorganized. 

In 1990, Sierra had released its first icon-driven game, King's
Quest~V. The icon-based approach required a new approach to event
handling. Each clickable object would be represented as an SCI
instance. When an object was clicked, a method the corresponding
instance would be called with a parameter specifying which icon was
used. The action linked to each icon was called a verb, and the method
doVerb.

Later, when creating the message interface, it was natural to re-use
this notion, and couple the module and verb with a unique number for
each clickable object (since the instance addresses are
unpredictable). Although later versions of the message system were
more complicated, these are the essentials of its first iteration.

Soon introduced was the concept of stage directions. They are
directions to the voice talents in CD-ROM games. The important bit
here is that the stage directions \textit{are still present} in the
shipped message files, and the interpreter must know how to remove
them. Any string in parentheses \textbf{not} containing any lower case
characters or digits \textit{including} any whitespace following it is
considered to be stage directions and is stripped before the script
sees it. Character escapes (either in the form of literal-character
escapes, such as $\backslash($, or escapes using the ASCII % )
value in hex, such as $\backslash 30$) were supported in some
versions.

Many versions of the message resource also support longer comments,
meant for writer/coder communication. It is unclear how to derive
their offsets in the resource, though.

The writers soon realised that the indexing model presented
above was too simplistic. Developments in the game plot were still not
handled adequately by the system, and required programmer
assistance. In addition, the response to each action had to fit in one
message box. Therefore, Sierra's programmers added two fields to the
indexing model, namely \textit{condition} (sometimes known as \textit{case}) and
\textit{sequence}. The condition signified the state of the noun
with respect to the game plot, in a manner of
speaking. The sequence number allowed writers to write more than one
screenful of text. Also, a piece of satellite data was introduced,
namely the \textit{talker}. The game might use this to display the face
of the speaker on screen. One talker value was reserved for narrated
parts, which don't display a face (but this is game-specific, and
really outside the domain of the interpreter). 

Even later, recursion was added. Actually, two kinds of recursion,
which it is necessary to distinguish, were
added. One involved resource-internal recursion, in which the writer
decides to re-use a part of another dialogue by including a reference to
it. This type of recursion was limited, though; it was impossible to
refer to other modules, and the reference always pointed to the first
message in a sequence. The other kind of recursion was controlled by
the script, and was useful for such things as cut-scenes. The two
types of recursion could be mixed freely, which is why there are both
message stacks and message stack stacks in Sierra SCI (no kidding! see
the included error message file INTERP.ERR or SIERRA.ERR).

\subsection{Ties to audio}
Of course, the story does not end there. CD-ROM games contain audio,
and having two addressing schemes would have been a mess. So
naturally, the same scheme was used. However, this poses another
problem: Individual resources are usually addressed by just a type and a
number, not by a message tuple like the one we saw above. Sierra's
solution was to add a new resource type, other resource files and maps beside the main
one. The extra resource files are called something like
\texttt{RESOURCE.AUD} and \texttt{RESOURCE.SFX}, and their maps are
contained in map resources, either in the main resource file or
separately as patches. The resource type is called audio36, and there
is a sync36 type as well which provides cueing capabilities to these
resources (like sync does to ordinary audio resources, see section
???).

The maps are indexed by module (room number), so that 100.map contains
map entries for all the message tuples that have the module number
100. Map number 65535 ($2^{16}-1$) is special -- it indexes ordinary
audio resources. 

To patch resources of this kind, Sierra used a base-36 encoding of the
message tuple as the file name. Since this results in oddly looking
names, the patch files, if any, are usually stored in a separate
directory on the CD. 
\subsection{File formats}
As can be seen from figure \ref{fig:versiontable}, the message file format and
interfaces changed quite a bit over time. Interestingly, as perhaps
the only part of the SCI system, message resource files incorporated a
version number, with one exception. It is marked 'early' in the table.
It is still possible to discern them from a corrupt resource, though.

\newcommand{\yes}{\ensuremath\surd}
\begin{figure}
\fbox{
\begin{minipage}{\linewidth}
\begin{center}
\begin{tabular}{lcccc}
\textbf{Ver.}&\textbf{StD}&\textbf{Cond/Seq}&\textbf{Rec}&\textbf{SRec}\\
\midrule
early\footnote{May not include a version number (needs confirmation)}\\
$2.101$&\yes\\
$3.340$&\yes&\yes&\yes\\
$3.411$&\yes&\yes&\yes\\
$4.000$&\yes&\yes&\yes\\
$4.010$&\yes&\yes&\yes\\
$4.211$&\yes&\yes&\yes\\ 
$4.321$&\yes&\yes&\yes&\yes\\
$5.000$&\yes&\yes&\yes&\yes\\
\end{tabular}
\end{center}
\end{minipage}
}
\caption{SCI message resources and their capabilities}
\label{fig:versiontable}
\end{figure}
The version numbers given in the table were divided
by~1000 to yield an real-numbered representation; thus, the message format
represented as $2.101$ had a version tag of \texttt{0x835}. 

All versions can be said to follow the general pattern given below; on
the following pages, specific file formats are given for each version.

\bigskip
\begin{tabular}{l}
\textsc{header}\\
\textsc{message offsets}\\
\textsc{actual text}\\
\textsc{comments/debug}\\
\end{tabular}
\newenvironment{fileformat}
{\nopagebreak\par\bigskip\begin{tabular}{lll}
\textbf{Offset}&\textbf{Size (bytes)}&\textbf{Description}\\
\midrule}{\end{tabular}\par\bigskip}
\subsection{early}
The exact file format is still not known, but seems to be the same as
2.101, without either the version number or the zero (Drantin?).
\subsection{Version 2.101}
The message resource begins with a 6-byte header, laid out thus:
\begin{fileformat}
0&2&Version number (== 0x835)\\
2&2&Always zero\\
4&2&Number of messages in file ($n$)\\
\end{fileformat}
\noindent The $n$ offset records are laid out as follows:
\begin{fileformat}
0&1&Noun\\
1&1&Verb\\
2&2&Offset to text (from beginning of resource)
\end{fileformat}
\subsection{Version 3.411}
The message resource begins with an 8-byte header, laid out thus:
\begin{fileformat}
0&2&Version number (== 0xd53)\\
2&2&Always zero\\
4&2&Pointer to first byte past text data, not counting this header\\
6&2&Number of messages in file ($n$)\\
\end{fileformat}
\noindent The $n$ offset records are laid out as follows:
\begin{fileformat}
0&1&Noun\\
1&1&Verb\\
2&1&Condition\\
3&1&Sequence\\
4&1&Talker\\
5&2&Offset to text (from beginning of resource)\\
7&3&Unknown\\
\end{fileformat}
\subsection{Version 4.010}
The message resource begins with an 8-byte header, laid out thus:
\begin{fileformat}
0&2&Version number (== 0xfaa)\\
2&2&Always zero\\
4&2&Pointer to first byte past text data, not counting this header\\
6&2&Number of messages in file ($n$)\\
\end{fileformat}
\noindent The $n$ offset records are laid out as follows:
\begin{fileformat}
0&1&Noun\\
1&1&Verb\\
2&1&Condition\\
3&1&Sequence\\
4&1&Talker\\
5&2&Offset to text (from beginning of resource)\\
7&1&Noun of referenced message\\
8&1&Verb of referenced message\\
9&1&Condition of referenced message
\end{fileformat}
The reference fields are set to zero if no reference is intended.
\newcommand{\msgtuple}
{\ensuremath{\langle\textit{module}, \textit{noun}, \textit{verb},
    \textit{cond},\textit{seq}\rangle}\xspace}
\section{Notes on the kernel calls}
Two versions of this API were used, the early GetMessage() which had
only one function, and a later subfunction-based one. While GetMessage()
required one to specify noun/module/verb on every call, the later
Message() was able to remember this for you (by way of GET and NEXT
subfunctions) -- hence the appeal of recursion. Unless otherwise noted,
a missing message causes the functions to copy a dummy message to the
output buffer. The sequence number is incremented \textbf{after}
fetching the message, but not tested for validity until a subsequent
call to NEXT.
\begin{kernelcall*}{GetMessage}
\callsynt{noun module verb buffer}
Copies the message given by the tuple $\langle \textit{module},
\textit{noun}, \textit{verb}\rangle$ to the output buffer.
\returns{The buffer address}
\end{kernelcall*}
\begin{kernelcall*}{Message}
\begin{subfx}
\callsynt{GET module noun verb cond seq buffer}
If \parameter{buffer} is non-NULL, copies the message given by the
message tuple to the output buffer. Resets any resource-internal recursion
(but not the script-controlled ditto). 

If \parameter{buffer} is NULL, nothing is copied (obviously). Although
recursion is followed for purposes of returning a talker value, the
stack is left pointing at the tuple given in the parameters -- the
sequence number is not incremented either. Also affects the LASTMESSAGE
subfunction, q.\@v.
\returns On success, the talker value associated with the message is
returned in both cases. On failure, 0 is returned.

\callsynt{NEXT buffer}
Same as above, except that the message returned is the one following
the previously returned one, where ``following'' means having the
immediately following sequence number. If no such message is found,
NEXT continues at the message given by the last stack frame
(script-controlled recursion being ignored). If the stack is empty, a
dummy message is returned.

\callsynt{SIZE module noun verb cond seq}
Returns the size (in bytes) of the message given by the message
tuple, including the terminating zero. Does not touch the GET/NEXT
stack, although recursion is otherwise handled normally.  

\callsynt{REFCOND module noun verb cond seq}
If the indicated message recurses, returns the \textit{condition} it
recurses to, $-1$ otherwise.

\callsynt{REFVERB module noun verb cond seq}
If the indicated message recurses, returns the \textit{verb} it
recurses to, $-1$ otherwise.

\callsynt{REFNOUN module noun verb cond seq}
If the indicated message recurses, returns the \textit{noun} it
recurses to, $-1$ otherwise.

\callsynt{PUSH}
Saves the current resource-internal recursion context on a stack.

\callsynt{POP}
Restores the last resource-internal recursion context.

\callsynt{LASTMESSAGE *tuple}
\parameter{*tuple} is a pointer to an array. The message tuple of the
last proper message is stored in this array. By ``proper'' I mean that
recursion pointers are followed and instances where \parameter{buffer} was NULL
are ignored.
\end{subfx}
\end{kernelcall*}
% -------------------------------------------------------------
% Chapter FreeSCI 
% -------------------------------------------------------------         
\chapter{FreeSCI}
\label{id2521434}\hypertarget{id2521434}{}%

% ------------------------   
% Section 
\section{Basic differences to Sierra's SCI}
\label{id2521440}\hypertarget{id2521440}{}%

Sierra's SCI engine, written back in the late 80s, was designed and built to be fast and efficient. Some evil compromises were made (especially in the animation cycle) that sacrificed cleanness for extra cycles. Also, it was designed to use only a very limited amount of memory, which led to more compromises.

The primary design goal of FreeSCI, on the other hand, was Portability. Written in the late 90s, memory constraints were practically nonexistant, since all game data could easily be stored in memory\label{id2520244}\begingroup\catcode`\#=12\footnote{
This is not true for the speech support some of the later SCI1 and SCI32/SCIWin come with, of course. At the time of this writing, SCI1 support is still non-existant, but later versions of FreeSCI will have to allow for dynamical loading of cdaudio resources.
}\endgroup\docbooktolatexmakefootnoteref{id2520244}. Thus, resource loading and hunk memory management is of no importance to FreeSCI. The kernel call "Load", which is used to load a resource to hunk space, simply returns the resource identifier of the resource it is supposed to load, as opposed to a pointer to a pointer to hunk memory.

Apart from that, FreeSCI simply abuses the fact that SCI was designed to be used by various different graphics adapters and sound devices. The graphics and sound commands each had to be interpreted by the currently active sound and graphics drivers, and FreeSCI does nothing more than to interpret them in its own way.

Of course, FreeSCI has to accomodate for versions differences between different SCI builds. These are generally minor issues (like the default alignment of text), but they have to be taken care of in one single program, as opposed to several builds as in the case of Sierra's SCI (some SCI games still ship with old versions of the interpreter, because they assume default values that were changed later on).

Finally, there is the built-in debugger. Sierra SCI used a quick and efficient design, while FreeSCI provides a Command-line interface to the debugger, and several additional commands.

% ------------------------   
% Section 
\section{The built-in debugger}
\label{id2521469}\hypertarget{id2521469}{}%
\subsection{Concepts and basic functionality}
\label{id2521474}\hypertarget{id2521474}{}%

The built-in debugger takes advantage of a built-in command interpreter (which is not to be confused with the SCI command interpreter). It's appearance is going to vary in between versions (at the time of this writing, it runs on the terminal FreeSCI was started on, in text mode; later versions will likely integrate the debugger to the graphics screen), but all versions of FreeSCI will come with a working debugger\label{id2521491}\begingroup\catcode`\#=12\footnote{
That's what I hope, anyway.
}\endgroup\docbooktolatexmakefootnoteref{id2521491}. Consult the documentation of your specific release for details on how to invoke it, if it is not activated automatically.

If activated, the debugger is called in between operation fetching and operation execution. It will show the command that is to be executed next, predicting the action done by send, super, and self calls where possible, and displaying any parameters to calling operations. It will also display the current register values and the number of operations that have been executed. It then waits for user input.

In order to simply execute the next operation, execute the "{\texttt{{s}}}" command. This will do one step of execution. If you want to execute more than one command, invoke "{\texttt{{s [number-of-steps]}}}". Other ways to step forward are "{\texttt{{snk}}}" (Step until the Next Kernel function is invoked) and "function/sret/" (Step until the interpreter RETurns from this function).

Speaking of functions, the FreeSCI interpreter also keeps a list of the call stack. This is similar to what the Sierra SCI interpreter provides as the "send stack", but it also includes call, calle and callb commands. Please note that callk commands are not included (some kernel functions actually call functions in user space). To display this list, invoke "{\texttt{{bt}}}". This function will list all calls on the stack, the parameters they carried, from where they were invoked, and the called object\label{id2521559}\begingroup\catcode`\#=12\footnote{
This is note quite correct: The object listed is, in fact, the object which is used as the base object for execution. This only makes a difference if the {\texttt{{super}}} operation is executed, but it may be confusing. Consider it a bug.
}\endgroup\docbooktolatexmakefootnoteref{id2521559} and selector (where applicable).

Selectors are not only used for functions, of course, they are also used as variables. To inspect the selectors of the current object, use the "{\texttt{{obj}}}" operation. Sometimes you might want to inspect how a send operation influenced an object; do so by calling "{\texttt{{accobj}}}", which will show the selectors of the object indexed by the accumulator register (as used in sends).

For a complete listing of debugging commands, refer to the next chapter.
\subsection{Debugger commands}
\label{id2521602}\hypertarget{id2521602}{}%

The FreeSCI built-in debugger provides the following commands:
\subsubsection{accobj}
\label{id2521613}\hypertarget{id2521613}{}%

The send operation requires a target object, which needs to be stored in the accumulator. This operation makes it possible to check if there is an object at the location indexed by acc, and, if it is, dump the type of object (Class, Object, or Clone), the object's name, and some other interesting stuff (selector names and values, funcselector names and addresses).
\subsubsection{bpdel (index)}
\label{id2521630}\hypertarget{id2521630}{}%

Deletes a breakpoint from the specified index of the list of active breakpoints.
\subsubsection{bpe (script, index)}
\label{id2521641}\hypertarget{id2521641}{}%

Add a breakpoint terminating when the specified exported function of a script is called
\subsubsection{bplist}
\label{id2521652}\hypertarget{id2521652}{}%

Lists all active breakpoints.
\subsubsection{bpx (method)}
\label{id2521662}\hypertarget{id2521662}{}%

Adds a breakpoint to the specified method.
\subsubsection{bt}
\label{id2521672}\hypertarget{id2521672}{}%

Backtrace: Shows the execution stack, bundled with call parameters and selector names where appropriate.
\subsubsection{classtable}
\label{id2521684}\hypertarget{id2521684}{}%

One of the nice things about FreeSCI is that it doesn't hide its class table as Sierra SCI appears to do. With this command, you have the power to unravel the mysteries of classes and superclasses at your fingertips.
\subsubsection{clear\_screen}
\label{id2521697}\hypertarget{id2521697}{}%

Clears the screen background from all dynviews, i.e. only picviews, dropped dynviews and the background pic resource are displayed.
\subsubsection{clonetable}
\label{id2521709}\hypertarget{id2521709}{}%

FreeSCI doesn't take Clone()ing lightly. It carefully notes which clone was created and tracks its current position. This function allows you to find them all, and in the darkness bind them.
\subsubsection{debuglog [mode]}
\label{id2521722}\hypertarget{id2521722}{}%

FreeSCI keeps an internal list of flags for specific areas of the game that should be watched more closely. The 'debuglog' command activates or deactivates debug output for each of those areas. Each area is described by a letter; to activate debugging for that area, use "debuglog +x", where x is the area you want to debug. "debuglog -x" deactivates debugging for that area. To activate or deactivate multiple areas, concatenate their single-letter descriptions. Run "debuglog" without parameters to get a listing of all active modes. The modes and describing letters are listed below. 

\begin{tabular}{lp{13cm}}
a& The audio subsystem  \\
b& The Bresenham line algorithm functions  \\
c& Character and string handling  \\
d& System graphics display and management  \\
f& Function calls  \\
F& File IO  \\
g& Graphics  \\
l& List and node handling  \\
m& Memory management  \\
M& Menu system  \\
p& The command parser  \\
s& Base setter: Draws the bases of each actor as colored rectangles  \\
S& Said specs  \\
t& Time functions  \\
u& Unimplemented functionality  \\
*& Everything at once. Use with care.  \\
\end{tabular}

\subsubsection{die}
\label{id2521810}\hypertarget{id2521810}{}%

Exits the interpreter ungracefully.
\subsubsection{disasm (address) [number]}
\label{id2521820}\hypertarget{id2521820}{}%

The debugger is able to disassemble code parts on the fly. Just give it an {\ttfamily\itshape{{address}}} to dissassemble (and a {\ttfamily\itshape{{number}}} of commands to dump, if you're feeling bold enough to look at more than one of them simultaneously). Unfortunately, it can only do send prediction and parameter resolution if it is disassembling the PC.
\subsubsection{dissectscript (script))}
\label{id2521847}\hypertarget{id2521847}{}%

Dumps a script resource (with the specified number) and examines it. Lists classes, static objects, relocation tables, and all the other stuff contained in scripts.
\subsubsection{dm\_*}
\label{id2521860}\hypertarget{id2521860}{}%

These are dmalloc utility functions. They are described in the dmalloc section below.
\subsubsection{draw\_viewobj (object)}
\label{id2521871}\hypertarget{id2521871}{}%

This operation draws the boundaries of the cel described by the indicated SCI object to the screen. The nsRect is drawn in green, the brRect in dark blue, and the position is marked by a small cross in the cel's priority, within a black box.
\subsubsection{dump (restype, resnr)}
\label{id2521886}\hypertarget{id2521886}{}%

Displays a hex dump of the specified resource.
\subsubsection{dumpnodes (index)}
\label{id2521896}\hypertarget{id2521896}{}%

Lists up to {\ttfamily\itshape{{index}}} nodes of the parse tree.
\subsubsection{dumpwords}
\label{id2521912}\hypertarget{id2521912}{}%

Lists all parser words
\subsubsection{gfx\_current\_port}
\label{id2521922}\hypertarget{id2521922}{}%

Prints the port ID of the current port.
\subsubsection{gfx\_debuglog [mode]}
\label{id2521931}\hypertarget{id2521931}{}%

Toggles debug flags for the graphics driver. Using "+x", the flag 'x' can be enabled, "-x" disables it. Multiple flags can be set at once, e.g. "+abc" or "-abc". With no parameters, all flags currently enabled are displayed. Note that, depending on the graphics driver in use, some flags might not be used. The list of supported flags follows. 

\begin{tabular}{ll}
b& Basic driver features  \\
p& Pointing device management  \\
u& Screen updates  \\
x& Pixmap operations  \\
\end{tabular}

\subsubsection{gfx\_draw\_cel (view) (loop) (cel)}
\label{id2521968}\hypertarget{id2521968}{}%

Draws a single cel to the center of the screen (augmented by the cel's delta-x and -y values). Depending on your graphics driver, you may have to refresh the screen for this to become visible.
\subsubsection{gfx\_draw\_rect (x) (y) (width) (height) (color)}
\label{id2521981}\hypertarget{id2521981}{}%

Draws a single rectangle to the screen. The {\texttt{{color}}} parameter describes an EGA color (0-15) which will be the rectagle's color'
\subsubsection{gfx\_drawpic (pic) [palette] [flags]}
\label{id2521999}\hypertarget{id2521999}{}%

Renders a pic resource. The {\em{palette}} value specifies the pic's palette to use; if not specified, 0 will be assumed. {\em{flags}} set any of the pic drawing flags used in the operational layer (see \hyperlink{fsci-gfx-op}{Section~{\ref{fsci-gfx-op}}}).
\subsubsection{gfx\_fill\_screen (color)}
\label{id2522025}\hypertarget{id2522025}{}%

Fills the entire screen (visual back and front buffer) with an EGA color.
\subsubsection{gfx\_free\_widgets}
\label{id2522035}\hypertarget{id2522035}{}%

This will free the main visual widget and all widgets it contains. Since it essentially invalidates the structured representation of the screen content, this will make the interpreter run into segfaults if you resume. It is intended for memory profiling and heap testing.
\subsubsection{gfx\_print\_dynviews}
\label{id2522049}\hypertarget{id2522049}{}%

Prints the current dynview list. This list is generated by the Animate() kernel call and represents the visual state of all dynamical images on the screen. Documentation regarding the meaning of the widget descriptions can be found in \hyperlink{fsci-gfx-widgets-string}{Section~{\ref{fsci-gfx-widgets-string}}}.
\subsubsection{gfx\_print\_port [port]}
\label{id2522070}\hypertarget{id2522070}{}%

Dumps the contents of the port specified (or, if omitted, the current port) to the output stream. Documentation regarding the meaning of the widget descriptions can be found in \hyperlink{fsci-gfx-widgets-string}{Section~{\ref{fsci-gfx-widgets-string}}}.
\subsubsection{gfx\_print\_visual}
\label{id2522088}\hypertarget{id2522088}{}%

Prints the visual widget, and, recursively, its contents; this widget is the root widget, therefore, the structured representation of all graphical information will be print. Documentation regarding the meaning of the widget descriptions can be found in \hyperlink{fsci-gfx-widgets-string}{Section~{\ref{fsci-gfx-widgets-string}}}.
\subsubsection{gfx\_widget [widget]}
\label{id2522108}\hypertarget{id2522108}{}%

(This function is only available if the interpreter was compiled with widget debugging enabled)

If the parameter is not specified, this will print a list of all used widget debug slots (each widget goes into exactly one slot); if the parameter is specified, it is used as an index in the widget debug slot list, causing the corresponding widget to be print. Documentation regarding the meaning of the widget descriptions can be found in \hyperlink{fsci-gfx-widgets-string}{Section~{\ref{fsci-gfx-widgets-string}}}.
\subsubsection{gfx\_priority [priority]}
\label{id2522134}\hypertarget{id2522134}{}%

If no parameter is supplied, the start and end values of the priority line list will be print. Otherwise, this function prints the first line of the specified priority region.
\subsubsection{gfx\_propagate\_rect (x) (y) (width) (height) (buffer)}
\label{id2522146}\hypertarget{id2522146}{}%

Propagates a rectangular zone from the back buffer (0) or static buffer (1) to the next higher buffer.
\subsubsection{gfx\_show\_map [nr]}
\label{id2522158}\hypertarget{id2522158}{}%

Draws one of the screen maps to the visual back buffer and updates the front buffer. The maps are numbered as follows: 

\begin{tabular}{ll}
0 & Visual buffer  \\
1 & Priority buffer (z buffer)  \\
2 & Control buffer  \\
\end{tabular}

 Buffers 1 and 2 will be rendered in EGA colors, with color values representing the associated priority/control values (this is identical to Sierra SCI behaviour).
\subsubsection{gfx\_update\_zone (x) (y) (width) (height)}
\label{id2522188}\hypertarget{id2522188}{}%

Propagates a rectangle from the back buffer to the front buffer; the rectangle's origin and dimensions are passed as parameters.
\subsubsection{gnf}
\label{id2522200}\hypertarget{id2522200}{}%

Lists the rules of the GNF grammar used internally in FreeSCI to parse input.
\subsubsection{go}
\label{id2522210}\hypertarget{id2522210}{}%

Deactivates debug mode and runs the game. Debug mode can be re-activated in the usual ways.
\subsubsection{heapdump (address) (number)}
\label{id2522222}\hypertarget{id2522222}{}%

Invoking this function will spit out {\ttfamily\itshape{{number}}} bytes, starting at {\ttfamily\itshape{{address}}}.
\subsubsection{heapdump\_all}
\label{id2522245}\hypertarget{id2522245}{}%

Prints all heap segments, including information whether they are allocated or not.
\subsubsection{heapfree}
\label{id2522255}\hypertarget{id2522255}{}%

Dumps a list of the free heap space (free, not gratis).
\subsubsection{heapobj (address)}
\label{id2522266}\hypertarget{id2522266}{}%

This is the same as {\texttt{{accobj}}}, but it can interpret any object on the heap. Note that the "home" address of objects (as used here) are 8 bytes into the object structure (which starts with the magic number 0x34 0x12), and points to the first (zeroeth?) selector.
\subsubsection{hexgrep (resource, hex 2-tuples+)}
\label{id2522287}\hypertarget{id2522287}{}%

Searches for a list of hexadecimal numbers inside a single resource (if specified like "script.042"), or in a set of resources (if specified like "pic").
\subsubsection{list (string+)}
\label{id2522299}\hypertarget{id2522299}{}%

If called without parameters, it lists all things it can list. Among these are: 

\begin{tabular}{ll}
\texttt{vars}& Global interpreter variables  \\
\texttt{cmds}& All available commands  \\
\texttt{restypes}& All resource types  \\
\texttt{selectors}& All selectors  \\
\texttt{syscalls}& All kernel functions  \\
\textit{[resource]}& All resources of that type (e.g.: "list view")  \\
\end{tabular}

\subsubsection{list\_sentence\_fragments}
\label{id2522338}\hypertarget{id2522338}{}%

Lists all parser rules in their normal almost-CNF representation.
\subsubsection{listinfo (address)}
\label{id2522349}\hypertarget{id2522349}{}%

So FreeSCI doesn't have an interactive list debugger as in Sierra SCI. But it has something better\label{id2522358}\begingroup\catcode`\#=12\footnote{
Well, this is debatable.
}\endgroup\docbooktolatexmakefootnoteref{id2522358}: A list dumper, which lists all list elements, keys, and heap positions.
\subsubsection{man (command)}
\label{id2522367}\hypertarget{id2522367}{}%

Shows a short descriptive message to the command.
\subsubsection{meminfo}
\label{id2522377}\hypertarget{id2522377}{}%

Prints information about heap and hunk memory allocation.
\subsubsection{obj}
\label{id2522387}\hypertarget{id2522387}{}%

This is, in essence, the same function as {\texttt{{accobj}}}, but it checks the current base object as opposed to the object indexed by the accumulator.
\subsubsection{objs}
\label{id2522405}\hypertarget{id2522405}{}%

Lists all objects, classes, and clones that are currently on the stack. They are identified by their properties, and prefixed with an asterisk ('*') if they are clones, or a percent sign ('\%') if they are classes.
\subsubsection{parse (string)}
\label{id2522417}\hypertarget{id2522417}{}%

Attempts to parse a single string, and displays the word groups, word classes and the resulting parse tree, if successful.
\subsubsection{print (variable)}
\label{id2522429}\hypertarget{id2522429}{}%

Prints the contents of one global interpreter variable.
\subsubsection{quit}
\label{id2522439}\hypertarget{id2522439}{}%

Exits the interpreter gracefully, by shutting down all resources manually.
\subsubsection{redraw\_screen}
\label{id2522449}\hypertarget{id2522449}{}%

This function retrieves the background picture, puts it on the foreground, and redraws everything. It's not inherently useful, though.
\subsubsection{registers}
\label{id2522461}\hypertarget{id2522461}{}%

This function will show the current values of the program counter, the accumulator, the frame pointer, the stack pointer, the prev register, and the \&rest modifier. It will also print the addresses of the current base object, of the global variables, and of the stack.
\subsubsection{resource\_id (number)}
\label{id2522477}\hypertarget{id2522477}{}%

FreeSCI packs resource type and number into the usual resource id combination. Use this little helper function to unpack it.
\subsubsection{restart [string]]}
\label{id2522490}\hypertarget{id2522490}{}%

Forces a restart of the current game. The string parameter is meaningless now.
\subsubsection{restore\_game (name)}
\label{id2522500}\hypertarget{id2522500}{}%

Tries to restore a game state from the specified directory. See \hyperlink{freesci-savegames}{Section~{\ref{freesci-savegames}}} for details about this.
\subsubsection{s [number]}
\label{id2522518}\hypertarget{id2522518}{}%

This function will execute {\ttfamily\itshape{{number}}} steps, or one if number was not specified.
\subsubsection{save\_game (name)}
\label{id2522535}\hypertarget{id2522535}{}%

Saves the current game state to a directory with the specified {\ttfamily\itshape{{name}}}. The directory is created automatically; everything inside is deleted, and the game data is stored. See \hyperlink{freesci-savegames}{Section~{\ref{freesci-savegames}}} for details about this.
\subsubsection{sci\_version}
\label{id2522560}\hypertarget{id2522560}{}%

Prints the SCI interpreter version currently being emulated
\subsubsection{scripttable}
\label{id2522570}\hypertarget{id2522570}{}%

Lists all scripts that have been loaded, their positions in memory, and the position of their local variables and exports.
\subsubsection{se}
\label{id2522582}\hypertarget{id2522582}{}%

Steps forward until an SCI keyboard event is received.
\subsubsection{set (variable, int)}
\label{id2522591}\hypertarget{id2522591}{}%

Sets the specified variable to a new value.
\subsubsection{set\_acc (number)}
\label{id2522601}\hypertarget{id2522601}{}%

Frobbing the accumulator is not recommended, but it may be fun at times. Use this command to set your favourite register to an arbitrary value and watch things blow up.
\subsubsection{set\_parse\_nodes}
\label{id2522614}\hypertarget{id2522614}{}%

Sets the nodes of the parse tree, and shows the result in list representation. Useful to display information gathered from a certain hacked version of Sierra's SCI interpreter in a more readable fashion.
\subsubsection{set\_vismap (mapnr)}
\label{id2522627}\hypertarget{id2522627}{}%

Sets the visual display map. Mapnr can be any of the following: 

\begin{tabular}{ll}
0 & Visual map  \\
1 & Priority map  \\
2 &  Control map  \\
4 & Auxiliary map \label{id2522654}\begingroup\catcode`\#=12\footnote{
Not really meaningful; only used while pic resources are drawn.
}\endgroup\docbooktolatexmakefootnoteref{id2522654}  \\
\end{tabular}

 This function is a no-op since FreeSCI 0.3.1.
\subsubsection{simkey (keynr)}
\label{id2522664}\hypertarget{id2522664}{}%

Simulates a keypress of a key with the specified key number. Modifiers are not applied.
\subsubsection{size (restype, resnr)}
\label{id2522676}\hypertarget{id2522676}{}%

Displays the total byte size of one single resource.
\subsubsection{snd \ldots}
\label{id2522686}\hypertarget{id2522686}{}%

This executes a sound command. Due to the nature of pipelining between the sound server and the interpreter, it is possible that the result messages of those operations will not be print immediately, so you may have to issue a second command in order for the results of the first command to be displayed.

Also, please note that after entering the debug console, the sound server is, by default, suspended, so you will have to issue an explicit {\ttfamily\bfseries{{snd resume}}} to do anything useful.
\subsubsection{snd stop}
\label{id2522714}\hypertarget{id2522714}{}%

Suspends the sound server. This is the opposite of 'snd resume'.
\subsubsection{snd resume}
\label{id2522725}\hypertarget{id2522725}{}%

Resumes the sound server after it has been suspended.
\subsubsection{snd play (song)}
\label{id2522736}\hypertarget{id2522736}{}%

Instructs the sound server to play the indicated song with a handle of 42.
\subsubsection{snd mute\_channel (channel)}
\label{id2522747}\hypertarget{id2522747}{}%

Mutes the indicated MIDI channel; events sent to this channel will be discarded before they reach the sound hardware.
\subsubsection{snd unmute\_channel (channel)}
\label{id2522760}\hypertarget{id2522760}{}%

Undoes a previous 'mute\_channel' command, or part of a previous 'snd mute'
\subsubsection{snd mute}
\label{id2522772}\hypertarget{id2522772}{}%

Mutes all channels (as per 'snd mute\_channel')
\subsubsection{snd unmute}
\label{id2522782}\hypertarget{id2522782}{}%

Unmutes all channels (as per 'snd unmute\_channel')
\subsubsection{snd solo (channel)}
\label{id2522793}\hypertarget{id2522793}{}%

Mutes all but one channel
\subsubsection{snd printchannels}
\label{id2522804}\hypertarget{id2522804}{}%

Lists all channels, and the instruments currently playing on them
\subsubsection{snd printmaps}
\label{id2522815}\hypertarget{id2522815}{}%

Prints the instrument names and all General MIDI mappings for the song currently playing. This operation will only work correctly if MT-32 to General MIDI translation is being performed.
\subsubsection{snd songid}
\label{id2522829}\hypertarget{id2522829}{}%

Retreives the numerical ID of the song currently playing from the sound server. Songs started with 'snd play' have a song ID of 42.
\subsubsection{sndmap \ldots}
\label{id2522841}\hypertarget{id2522841}{}%

Executes MT32 to GM sound mapping commands.
\subsubsection{sndmap mute (instr)}
\label{id2522852}\hypertarget{id2522852}{}%

Mutes the specified instrument
\subsubsection{sndmap percussion (instr) (gm-percussion)}
\label{id2522863}\hypertarget{id2522863}{}%

Maps the specified instrument to a GM percussion instrument
\subsubsection{sndmap instrument (instr) (gm-instrument)}
\label{id2522875}\hypertarget{id2522875}{}%

Maps the instrument to a normal GM instrument
\subsubsection{sndmap shift (instr) (shift-value)}
\label{id2522887}\hypertarget{id2522887}{}%

Sets the shift value for the instrument
\subsubsection{sndmap finetune (instr) (val)}
\label{id2522898}\hypertarget{id2522898}{}%

Fine-tunes the instrument, as via the MIDI command
\subsubsection{sndmap bender (instr) (bender)}
\label{id2522910}\hypertarget{id2522910}{}%

Chooses a bender range for the instrument
\subsubsection{sndmap volume (instr) (vol)}
\label{id2522921}\hypertarget{id2522921}{}%

Sets a relative instrument volume, ranging from 0 to 128.
\subsubsection{snk [number]}
\label{id2522933}\hypertarget{id2522933}{}%

Another step command: Step until the interpreter hits a callk command. If you're hunting for a very specific kernel call, just add its number as a parameter. Syscall hunting has never been so easy.
\subsubsection{so}
\label{id2522946}\hypertarget{id2522946}{}%

"Steps over" one instruction, i.e. continues executing until that instruction has been completed (useful for send, call, and related functions)
\subsubsection{sret}
\label{id2522958}\hypertarget{id2522958}{}%

Step until RETurning. If you're bored of the function you're debugging, just invoke this command. It will step forward until the current function returns.
\subsubsection{stack (number)}
\label{id2522970}\hypertarget{id2522970}{}%

Can't remember what you pushed on that stack, and in which order? This command will display as many stack elements as you want, starting at the TOS.
\subsubsection{version}
\label{id2522983}\hypertarget{id2522983}{}%

Displays the interpreter and SCI game versions
\subsubsection{viewinfo (number)}
\label{id2522993}\hypertarget{id2522993}{}%

Examines the specified view resource and displays the number of loops it has, the number of cels for each loop, and the size for each cel.
\subsubsection{vmvarlist}
\label{id2523005}\hypertarget{id2523005}{}%

Lists the heap positions of the current global, local, parameter, and temporary variables.
\subsubsection{vmvars (type) (index) [value])}
\label{id2523016}\hypertarget{id2523016}{}%

Reads or sets a global, local, temporary, or parameter value. Type must be any of 'g', 'l', 'p', 't', to select global, local, parameter or temporary variables (respectively), while index represents the variable index. If value is not provided, that variable will be displayed; otherwise, it will be set to value.
\subsection{Console interaction with dmalloc}
\label{id2523032}\hypertarget{id2523032}{}%

The FreeSCI console proivdes an interface to the dmalloc memory debugger/profiler, if the interpreter was compiled with dmalloc support enabled. The following commands are provided:
\subsubsection{dm\_log\_heap}
\label{id2523044}\hypertarget{id2523044}{}%

Prints the current heap state into the dmalloc log file
\subsubsection{dm\_stats}
\label{id2523054}\hypertarget{id2523054}{}%

Prints memory usage statistics to the output file
\subsubsection{dm\_log\_unfreed}
\label{id2523064}\hypertarget{id2523064}{}%

Lists unfreed pointers in the dmalloc output file
\subsubsection{dm\_verify (pointer)}
\label{id2523074}\hypertarget{id2523074}{}%

Verifies a pointer and prints the result to the dmalloc output file. Specifying 0 instead of a pointer will verify all pointers currently known to dmalloc.
\subsubsection{dm\_debug (mode)}
\label{id2523086}\hypertarget{id2523086}{}%

Sets the dmalloc debug flags (please refer to the dmalloc documentation for a description)
\subsubsection{dm\_mark}
\label{id2523096}\hypertarget{id2523096}{}%

Gets a mark describing the current heap situation (see also 'dm\_chmark')
\subsubsection{dm\_chmark (mark)}
\label{id2523107}\hypertarget{id2523107}{}%

Compares a mark retreived by 'dm\_mark' with the current heap situation, and prints the results to the dmalloc output file.
\subsubsection{dm\_print (output)}
\label{id2523118}\hypertarget{id2523118}{}%

Prints arbitrary output to the dmalloc output file

% ------------------------   
% Section 
\section{Header files}
\label{id2523130}\hypertarget{id2523130}{}%

This section explains what some of the header files are good for.
\subsection{Core headers}
\label{id2523141}\hypertarget{id2523141}{}%

The following headers provide what should be considered core functionality:
\subsubsection{scitypes.h}
\label{id2523150}\hypertarget{id2523150}{}%

This file, included from {\texttt{{resource.\dbz{}h}}}, provides some of the basic types used in FreeSCI, including some of the types used for specific functions, but also the gu?int(8\docbooktolatexpipe{}16\docbooktolatexpipe{}32) types, which provide (unsigned) types for 8, 16, and 32 bits.
\subsubsection{resource.h}
\label{id2523169}\hypertarget{id2523169}{}%

The main OS abstraction header file; includes {\texttt{{scitypes.\dbz{}h}}} and provides functions for the following: Queues, memory checks, time inspection, directory traversion, case-insensitive file opening, the 'sciprintf()' function, which is the primary output function in FreeSCI, functions to retreive the user's home directory and the cwd, to create a complete path in the file system, yield to the scheduler (where possible) or trigger a breakpoint.
\subsubsection{sci\_conf.h}
\label{id2523192}\hypertarget{id2523192}{}%

In here, the configuration options (as parsed from the \textasciitilde{}/.freesci/config file) are listed in a structure; includes function definitions for handling configuration.
\subsubsection{versions.h}
\label{id2523204}\hypertarget{id2523204}{}%

Lists certain SCI versions and functions/macros to examine these versions. Some kernel functions have bugs or changed their behaviour in some versions of SCI; these version numbers should be listed in this file.
\subsubsection{sciresource.h}
\label{id2523216}\hypertarget{id2523216}{}%

Provides definitions, strings, and functions for SCI resource management, including the resource manager function prototypes.
\subsubsection{sci\_memory.h}
\label{id2523228}\hypertarget{id2523228}{}%

Prototypes for the sci\_alloc(), sci\_free() etc. functions for memory management, plus the debug switches available for them.
\subsubsection{console.h}
\label{id2523239}\hypertarget{id2523239}{}%

Prototypes for the SCI console, including functions to hook up SCI console functions and variables.
\subsubsection{sbtree.h}
\label{id2523250}\hypertarget{id2523250}{}%

This header file is only used by the gfx subsystem right now. It provides statically generated binary trees.
\subsection{VM headers}
\label{id2523262}\hypertarget{id2523262}{}%

The most central VM header file is {\texttt{{engine.\dbz{}h}}}, which contains the state\_t structure and several global definitions related to savegame and general path management. This file includes a number of other headers, including the following core VM ones.
\subsubsection{script.h}
\label{id2523283}\hypertarget{id2523283}{}%

Provides definitions for opcodes and script segment types
\subsubsection{vm.h}
\label{id2523293}\hypertarget{id2523293}{}%

Definitions for handling objects on the heap, script and class objects, the selector map, execution stack and breakpoint typedefs, a few global variables for debugging the VM, functions for initializing and running it, for looking up selectors in an object, to save and load the game state and pretty much everything else that involves running SCI scripts.
\subsubsection{heap.h}
\label{id2523309}\hypertarget{id2523309}{}%

Prototypes and definitions for FreeSCI's SCI heap implementation.
\subsubsection{vocabulary.h}
\label{id2523319}\hypertarget{id2523319}{}%

This header file provides definitions and declares functions for decoding vocab resources, from parser rules to VM opcode names to selector names. It also lists explains the functions used for parsing.
\subsubsection{kdebug.h}
\label{id2523332}\hypertarget{id2523332}{}%

Provides the SCIkdebug() and SCIkwarn() functions (and their arguments) for selectively debugging kernel functions.
\subsubsection{kernel.h}
\label{id2523343}\hypertarget{id2523343}{}%

Provides GET\_HEAP(), PUT\_HEAP(), GET\_SELECTOR() etc., also predicates to determine whether heap objects are lists and objects, and a generic text resource lookup function that distinguishes between heap text data and text resources. Also includes priority band information, view signals, and other definitions for kernel functions, plus a listing of all kernel functionality.
\subsubsection{menubar.h}
\label{id2523358}\hypertarget{id2523358}{}%

In here, functions for handling menu bar objects are described, as are a number of constants and values that can be used to customize menu bar displaying. The menubar functions call some gfx functions, but are themselves called from the kernel's menubar handling functions.
\subsubsection{sci\_graphics.h}
\label{id2523372}\hypertarget{id2523372}{}%

Provides the SELECTOR\_STATE and MAX\_TEXT\_WIDTH definitions for a number of graphical kernel functions.
\subsection{Graphics subsystem headers}
\label{id2523384}\hypertarget{id2523384}{}%

The gfx subsystem's functionality is described in \hyperlink{freesci-gfx-subsystem}{Section~{\ref{freesci-gfx-subsystem}}}. Most of the header files it uses are prefixed with "gfx\_".
\subsubsection{gfx\_system.h}
\label{id2523402}\hypertarget{id2523402}{}%

Provides debug functionality, the core data types (points, rectangles, pixmaps, etc), rectangle and point operations (inlined) and enums and definitions for more complex functions.
\subsubsection{uinput.h}
\label{id2523414}\hypertarget{id2523414}{}%

Describes input events (type, modifiers, etc).
\subsubsection{gfx\_driver.h}
\label{id2523424}\hypertarget{id2523424}{}%

Documents the gfx\_driver\_t structure, and the functions and capability flags it can/must provide.
\subsubsection{gfx\_options.h}
\label{id2523435}\hypertarget{id2523435}{}%

This file covers configuration options that can be provided to the gfx subsystem's operational layer. It defines a structure that is also used by {\texttt{{sci\_\dbz{}conf.\dbz{}h}}}.
\subsubsection{gfx\_widgets.h}
\label{id2523452}\hypertarget{id2523452}{}%

Describes graphical widgets and the functionality they provide, including constructors for each widget.
\subsubsection{gfx\_state\_internal.h}
\label{id2523464}\hypertarget{id2523464}{}%

This file covers the "hidden" (non-public) part of graphical widgets and includes many gory details regarding their implementation.
\subsubsection{sci\_widgets.h}
\label{id2523475}\hypertarget{id2523475}{}%

Provides more complex widgets that are specific to the needs of SCI.
\subsubsection{gfx\_tools.h}
\label{id2523485}\hypertarget{id2523485}{}%

Provides utility functions, primarily for gfx driver writers, but also some functions used in the operational layer.
\subsubsection{gfx\_resmgr.h}
\label{id2523496}\hypertarget{id2523496}{}%

Describes the gfx subsystem's resource manager's functions, as used by the operational layer, and prototypes for functions implemented by the interpreter specific part.
\subsubsection{gfx\_resource.h}
\label{id2523508}\hypertarget{id2523508}{}%

Functions for operating on gfx resources in general, and also functions for loading/drawing particular resources.
\subsubsection{gfx\_operations.h}
\label{id2523519}\hypertarget{id2523519}{}%

Describes the operational layer of the gfx subsystem. Provides an extensive set of 2D graphics functionality.

% ------------------------   
% Section 
\section{Savegames}
\label{freesci-savegames}\hypertarget{freesci-savegames}{}%

FreeSCI attempts to store savegames portably; for this reason, most of the game data is saved as plain text, while the graphics are written to png\label{id2523548}\begingroup\catcode`\#=12\footnote{
Portable Network Graphics. A very portable graphics format with lossless compression, a free reference implementation, and dozens of useful features.
}\endgroup\docbooktolatexmakefootnoteref{id2523548} files.
\subsection{Savegame directory policy}
\label{id2523557}\hypertarget{id2523557}{}%

The general FreeSCI directory policy is simple: If there is a \texttt{\$HOME}, use \texttt{\textasciitilde{}/.freesci/\textit{[game name]}/} as your playground, if there is no home, use the current working directory. Savegames are true to that policy. Each save game has a directory associated with itself, and this directory is relative to the directory mentioned above. For example, if you execute ``\texttt{save\_game frobnitz}'' in SQ3 on your *BSD box while your \texttt{\$HOME} is set to \texttt{/home/rogerw}, the save game files would be written to\\ \texttt{/home/rogerw/.freesci/SQ3/frobnitz/}.
\subsection{Files}
\label{id2523577}\hypertarget{id2523577}{}%
\subsubsection{state}
\label{id2523581}\hypertarget{id2523581}{}%

This is the main save file. It contains huge amounts of text data, which are an almost-complete replication of the game internal state\_t structure. The code used to read and write this file is automatically generated by a script called cfsml.pl, and it is believed to be rather flexible; i.e. you should be able to insert blank lines, comment lines, (Using the hash ('\#') sign), move assignements around, and change values. The identifiers used in this file are identical to the identifiers used in the c code.
\subsubsection{heap}
\label{id2523611}\hypertarget{id2523611}{}%

This is a binary copy of the heap data. Heap data is internally structured to be identical to SCI heap data (little endian, 16 bit), so it is portable to all platforms.
\subsubsection{hunk*}
\label{id2523624}\hypertarget{id2523624}{}%

These files contain raw hunk data. SCI code may allocate raw hunk data, but it can't do anything with it (except unallocate it again). It is unlikely that you are going to encounter a hunk file in normal SCI code. This may change for later SCI versions.
\subsubsection{song.*}
\label{id2523638}\hypertarget{id2523638}{}%

Songs stored by the sound subsystem.
\subsubsection{sound}
\label{id2523648}\hypertarget{id2523648}{}%

Contains the state of the sound subsystem. The syntax is identical to the used in the "state" file.
\subsubsection{*.id}
\label{id2523659}\hypertarget{id2523659}{}%

Savegame name file for one SCI game. The file names are chosen by taking the game's "unique" identifier and appending a suffix of ".id". This file contains the savegame name in plain text.
\subsection{Obsolete files}
\label{id2523672}\hypertarget{id2523672}{}%

The following files were generated by earlier versions of FreeSCI, but are no longer used:
\subsubsection{*map.png}
\label{id2523682}\hypertarget{id2523682}{}%

The four maps of the main picture are stored in four separate png files: 

\begin{tabular}{l}
visual\_map.png  \\
priority\_map.png  \\
control\_map.png  \\
auxiliary\_map.png  \\
\end{tabular}

 The meanings of those files should be rather obvious.

visual\_map.png contains regular palette or color information, so it is, in fact, a screenshot of the game (the mouse pointer is not shown, since it is not stored in the display maps). The other three png files each contain a greyscale gradient palette.
\subsubsection{buffer*}
\label{id2523722}\hypertarget{id2523722}{}%

These are png files containing the various graphical buffers used in the game. buffer\_x.1 is the visual buffer, buffer\_x.2 is the priority buffer, and buffer\_x.4 is the control buffer. Any combination of these three buffers is possible.

Control and priority buffers contain a grayscale gradient palette.
\subsection{Caveats}
\label{id2523742}\hypertarget{id2523742}{}%

FreeSCI's file saving and restoration functionality isn't perfect. Please be aware of the following flaws and limitations before you dig out your flame thrower:
\subsubsection{File handles}
\label{id2523753}\hypertarget{id2523753}{}%

Open file handles are NOT stored or loaded. If you try to save the game with the built-in debugger while file handles are still open, you will be warned about this and saving will abort, unless you preceed your save directory name with an underscore ('\_').
\subsubsection{Kernel functions}
\label{id2523768}\hypertarget{id2523768}{}%

SCI kernel functions are able to call the virtual machine. In practice, this means that you may have two or more vm function calls on your system stack; it is not easily possible to store the game state in this case. FreeSCI does not allow it, and, as far as I know, no Sierra SCI code ever tries to do that.

To determine whether or not this applies to you, run "bt" in the debugger; the "base" number in the first line must be zero, or you won't be able to save the game (restoring should work, though).

% ------------------------   
% Section 
\section{The graphics subsystem}
\label{freesci-gfx-subsystem}\hypertarget{freesci-gfx-subsystem}{}%

Christoph Reichenbach, April 2nd, 2000

Up until version 0.3.0, FreeSCI used a graphics subsystem which used per-pixel operations on three 320x200 8 bit buffers. This concept, while being simple to implement for driver writers, proved to have several disadvantages: 

\begin{tabular}{l}
Non-native memory layout: Using a fixed 8bpp visual buffer meant that, for each update, all graphics would have to be translated to the graphics driver's native format, unless it already was running in 8bpp.  \\
No use of accellerated drawing functions: Many of the targetted graphics drivers supported hardware-accelerated drawing of rectangles or lines; this could not be taken advantage of, due to the per-pixel access  \\
Scalability moved to the drivers: Each driver would have to take care of magnifying the resulting picture by itself (if it wanted to support it at all), since the base buffer was at a fixed size.  \\
Manual graphics buffer access: This was in fact used in many places, making it hard to keep track of modifications, which, in turn, would have inhibited attempts to track modifications of the visual buffer. However, without those, either each drawing operation would have enforce an update, causing flickering in the general case, or the full screen would have to be re-drawn each time (which was what actually was done), resulting in major performance penalites, especially for remote displays.  \\
\end{tabular}

 Combined with some cases of code rot, these problems suggested a re-write of the complete graphics subsystem, and a more modular re-design in preparation for supporting later revisions of SCI (and, possibly, related engines such as AGI).

This documentation section will describe the architecture and functionality of the new graphics subsystem, which has been in operation since FreeSCI 0.3.1. I will start by giving a general overview of the various components involved and how they interact, and then give a more detailed description of each of those components in sequence.
\subsection{Architecture}
\label{id2523867}\hypertarget{id2523867}{}%

In extension of the architecture used up until FreeSCI 0.3.0, the new graphics subsystem now uses a total of six buffers: 
% tabular ------------------------------------------------------
\begin{center}
\label{id2523876}\hypertarget{id2523876}{}%

\begin{tabular}{c|c|c|c}
{{Map Name}} & {{\# of buffers}} & {{scaled}} & {{bpp}} \tabularnewline
 \hline 
{{visual}} & {{3}} & {{yes}} & {{determined by driver}} \tabularnewline
 \hline 
{{priority}} & {{2}} & {{yes}} & {{8}} \tabularnewline
 \hline 
{{control}} & {{1}} & {{no}} & {{8}} \tabularnewline
\end{tabular}
\end{center}

 Of these, the visual and priority buffers have to be provided by the graphics driver, since they are relevant for display and may actually be present physically (since the priority map is nothing other than a Z buffer). The control map, a special buffer used by the interpreter to check whether moving objects hit obstacles on the screen or touch zones with special meanings, is only relevant for the interpreter and therefore handled one level above the graphics driver.

I will refer to the level above as the "operational layer". This layer handles all of the primitive graphical operations. It performs clipping, keeps track of modified regions, and emulates functions required but not supported natively by the graphics driver.

The operational layer is also responsible for the four pixmap operations, which draw background pictures, images, text, or mouse pointers. These pointers are only referred to by their respective ID numbers; they are retreived from the graphical resource manager. This graphical resource manager (GRM) is another separate subsystem- it retreives graphical resources in one of a set of standard formats, and translates them to the graphics driver's native format in one of several possible ways. It also receives hints from the operational layer to improve its caching strategy.

Finally, above the operational layer, another layer is situated: This widget layer provides abstract descriptions of things on the screen as objects, so-called widgets. It provides the primary interface for the interpreter to interact with.
\subsection{Standard data types}
\label{id2523999}\hypertarget{id2523999}{}%

There are a number of standard data types defined in {\texttt{{src/\dbz{}include/\dbz{}gfx\_\dbz{}system.\dbz{}h}}} which are used all over the place in the graphics subsystem; therefore, they warrant some special attention in order to understand how it works.
\subsubsection{point\_t}
\label{id2524017}\hypertarget{id2524017}{}%

This data type is nothing more than a tuple ({\texttt{{x}}},{\texttt{{y}}}). It describes a coordinate on the screen; a one-line way to generate a point\_t is to use the function {\texttt{{gfx\_point(x,y)}}}.
\subsubsection{rect\_t}
\label{id2524049}\hypertarget{id2524049}{}%

This type describes a rectangular area on the screen, as a four-tuple ({\texttt{{x}}},{\texttt{{y}}},{\texttt{{xlen}}}, {\texttt{{ylen}}}), where the point ({\texttt{{x}}}, {\texttt{{y}}}) describes the upper left point of the rectangle, whereas {\texttt{{xlen}}} and {\texttt{{ylen}}} are the number of pixels the rectangle extends to the right on the x and downwards on the y axis, respectively. A rect\_t can be generated in-line by the function {\texttt{{gfx\_rect(x,y,xl,yl)}}}.

A number of functions are available to operate on rect\_ts. These functions are 'pure' in the functional sense, meaning that they do not modify the original rectangle, but, rather, return a new one (of course, an optimizing compiler will make this a moot point from a performance perspective).
\subparagraph*{gfx\_rect\_equals(rect\_a, rect\_b)}
\label{id2524130}\hypertarget{id2524130}{}%

This function is a predicate that returns non-zero iff {\texttt{{rect\_\dbz{}a}}} describes the same rectangle as {\texttt{{rect\_\dbz{}b}}}.
\subparagraph*{gfx\_rect\_translate(rect, point)}
\label{id2524153}\hypertarget{id2524153}{}%

Returns a rectangle which equals {\texttt{{rect}}} translated (moved) by the ({\texttt{{x}}}, {\texttt{{y}}}) tuple described by the {\texttt{{point}}} parameter (i.e. {\texttt{{point}}} is interpreted as a relative coordinate).
\subparagraph*{gfx\_rect\_subset(rect\_a, rect\_b)}
\label{id2524193}\hypertarget{id2524193}{}%

A predicate to determine whether all pixels contained in the area described by {\texttt{{rect\_\dbz{}a}}} are also contained in the area described by {\texttt{{rect\_\dbz{}b}}}. Reflexive and transitive.
\subparagraph*{gfx\_rects\_overlap(rect\_a, rect\_b)}
\label{id2524217}\hypertarget{id2524217}{}%

A predicate to test whether there exists a pixel in the area described by {\texttt{{rect\_\dbz{}a}}} which is contained in the area described by {\texttt{{rect\_\dbz{}b}}}. Reflexive and symmetric.
\subparagraph*{gfx\_rects\_merge(rect\_a, rect\_b)}
\label{id2524241}\hypertarget{id2524241}{}%

Returns the smallest rectangle containing both {\texttt{{rect\_\dbz{}a}}} and {\texttt{{rect\_\dbz{}b}}}.
\subsubsection{gfx\_pixmap\_color\_t}
\label{id2524264}\hypertarget{id2524264}{}%

This structure describes a single color in a pixmap. It consists of 8 bit {\texttt{{r}}}, {\texttt{{g}}}, {\texttt{{b}}} values to describe a color; when used in a pixmap, it is part of a palette of gfx\_pixmap\_color\_ts where the entry at index {\texttt{{i}}} describes the color of the respective color index {\texttt{{i}}} inside the pixmap.

In palette mode, the {\texttt{{global\_\dbz{}index}}} entry is used to store the color index entry of the global palette that correlates with the pixmap index (or {\texttt{{GFX\_\dbz{}COLOR\_\dbz{}INDEX\_\dbz{}UNMAPPED}}} if this value has not been determined yet).
\subsubsection{gfx\_color\_t}
\label{id2524328}\hypertarget{id2524328}{}%

gfx\_color\_t structures contain color information for all three color maps. They consist of a gfx\_pixmap\_color\_t structure, {\texttt{{visual}}}, which describes the effects of the color on the visual map, an {\texttt{{alpha}}} entry to describe the color's transparency (0 means 'opaque', 255 means 'totally transparent', although graphics drivers may choose to slighly alter those meanings for performance considerations), {\texttt{{priority}}} and {\texttt{{control}}} values for the respective maps, and a {\texttt{{mask}}} to determine the maps affected.

This mask is a bitwise-OR of the constants {\texttt{{GFX\_\dbz{}MASK\_\dbz{}VISUAL}}} (meaning "draw to the visual map"), {\texttt{{GFX\_\dbz{}MASK\_\dbz{}PRIORITY}}} ("draw to the priority map") and {\texttt{{GFX\_\dbz{}MASK\_\dbz{}CONTROL}}} (guess).
\subsubsection{gfx\_mode\_t}
\label{id2524405}\hypertarget{id2524405}{}%

The FreeSCI graphics subsystem only supports a small subset of all possible graphics modes; specifically, it only supports modes where the integer value of each pixel can be stored in 8, 16, 24, or 32 bits. Color index mode is supported, but non-indexed mode has additional requirements: Each color aspect of red, green, and blue must be represented by a consecutive sub-vector \textless{}$v_{c}$, $v_{c+1}$, \ldots ,$v_{c+n-1}$\textgreater{} of the total color vector \textless{}$v_{0}$, $v_{1}$, \ldots ,$v_{b-1}$\textgreater{}, where $n$ and $c$ are non-negative integers, and $c+n \leq b$ holds. With $v_{b}$ being the most significant bit of the total bit vector, we also require that for each {\texttt{{m}}} where 0 \textless{} m \textless{} n the bit $v_{c+m}$ should, if set, increase brightness about twice as much as setting $v_{c+m-1}$ would. This allows us to represent each color aspect by means of an AND bitmask and an integer shift value.

This, along with a global palette and the scaling factors, is the core of the gfx\_mode\_t data. It also contains a shift values and an AND bitmask for alpha values; if these values are set to non-zero by the graphics driver, alpha channel information will be written to the same block of data the color values are written to when pixmaps are calculated. If they are not set, a separate 8bpp alpha data block will be added to the pixmaps.
\subsubsection{gfx\_pixmap\_t}
\label{id2524505}\hypertarget{id2524505}{}%

The gfx\_pixmap\_t structure is another fundamental element of the graphics subsystem. It describes a single pixmap, such as a background picture, a cel, a mouse pointer, or a single line of text. It contains up to two references to the graphical data it describes: One unscaled block of color-indexed data ({\texttt{{index\_\dbz{}data}}}, and another block scaled and in the graphics driver's native format ({\texttt{{data}}}).

Each pixmap contains a local palette of {\texttt{{colors\_\dbz{}nr}}} gfx\_pixmap\_color\_t entries, called {\texttt{{colors}}}. This palette is allocated dynamically and may be NULL if no {\texttt{{index\_\dbz{}data}}} block is present.

Also, a tuple ({\texttt{{xoffset}}}, {\texttt{{yoffset}}}) describes the pixmap's 'hot spot'. This is a relative offset into the unscaled data; it is used to describe the point which drawing operations will refer to. This means that pixmap draw operations on this pixmap will cause it to be drawn {\texttt{{xoffset}}} pixels (unscaled) to the left of the coordinate specified.

Next comes the unscaled pixmap data, called {\texttt{{index\_\dbz{}data}}}, which occupies a size of {\texttt{{index\_\dbz{}xl}}} * {\texttt{{index\_\dbz{}yl}}} bytes. Each byte is either a reference into the palette, or {\texttt{{GFX\_\dbz{}COLOR\_\dbz{}INDEX\_\dbz{}TRANSPARENT}}} (0xff), which means that it describes a transparent pixel, unless 256 colors are indeed present in the palette\label{id2524619}\begingroup\catcode`\#=12\footnote{
This may cause a problem for SCI1 support, which explicitly allows for 256 separate colors to be used alongside with transparency. Possible solutions include a separate transparency bitmap or increasing the number of bits per {\texttt{{index\_\dbz{}data}}} entry to 16bpp.
}\endgroup\docbooktolatexmakefootnoteref{id2524619}

The pointer {\texttt{{data}}}, unless NULL, points to a block of data allocated to contain the translated graphical data in the graphics driver's native format. The number of bytes per pixel equals the {\texttt{{bytespp}}} property of the gfx\_mode\_t structure it was allocated for, whereas its horizontal and vertical extensions are stored in the {\texttt{{xl}}} and {\texttt{{yl}}} properties. Unless the graphics mode indicated that it supports an alpha channel itself, a separate {\texttt{{alpha\_\dbz{}map}}} is also provided, at 8bpp.

Each pixmap also comes with a {\texttt{{pixmap\_\dbz{}internal}}} block, which may be used by graphics drivers to store internal information (like pixmap repository handles).

Finally, each pixmap comes with a set of {\texttt{{flags}}} with the following meanings: 
\begin{itemize}
%--- Item
\item 
{\texttt{{GFX\_\dbz{}PIXMAP\_\dbz{}FLAG\_\dbz{}SCALED\_\dbz{}INDEX}}}: The pixmaps index data is already scaled; any algorithm for calculating {\texttt{{data}}} (and, possibly, {\texttt{{alpha\_\dbz{}map}}}) therefore must not scale it again.


%--- Item
\item 
{\texttt{{GFX\_\dbz{}PIXMAP\_\dbz{}FLAG\_\dbz{}EXTERNAL\_\dbz{}PALETTE}}}: The palette supplied with the pixmap is stored externally, meaning that it must not be freed when the pixmap itself is freed


%--- Item
\item 
{\texttt{{GFX\_\dbz{}PIXMAP\_\dbz{}FLAG\_\dbz{}INSTALLED}}}: The pixmap has been installed in the pixmap repository (used by the operational layer, although graphics drivers may choose to verify this if they don't trust that layer


%--- Item
\item 
{\texttt{{GFX\_\dbz{}PIXMAP\_\dbz{}FLAG\_\dbz{}PALETTE\_\dbz{}ALLOCATED}}}: (only relevant for color index mode) The pixmap's palette colors have been allocated in the internal palette listing and have been set appropriately in the palette


%--- Item
\item 
{\texttt{{GFX\_\dbz{}PIXMAP\_\dbz{}FLAG\_\dbz{}PALETTE\_\dbz{}SET}}}: (only relevant in color index mode) The pixmap's palette colors have been propagated to the graphics driver


%--- Item
\item 
{\texttt{{GFX\_\dbz{}PIXMAP\_\dbz{}FLAG\_\dbz{}DONT\_\dbz{}UNALLOCATE\_\dbz{}PALETTE}}}: (only relevant in color index mode) Instructs the pixmap freeing operations not to free the palette colors allocated by the pixmap. This is used in cases where the palette is stored externally.

\end{itemize}
\noindent 

{\texttt{{src/\dbz{}include/\dbz{}gfx\_\dbz{}tools.\dbz{}h}}} defines many functions for creating pixmaps, allocating index data blocks, copying pixmap regions etc.
\subsubsection{gfx\_bitmap\_font\_t}
\label{id2524802}\hypertarget{id2524802}{}%

These structures provide a bitmap lookup table intended for up to 256 entries. In practice, they are used to store font data. There is little surprising about this structure, with the possible exception of the difference between the {\texttt{{height}}} and {\texttt{{line\_\dbz{}height}}} variables: {\texttt{{height}}} describes the actual character size, whereas {\texttt{{line\_\dbz{}height}}} only describes how many pixels the text rendering functions should leave in between text lines.
\subsection{Graphics drivers}
\label{id2524842}\hypertarget{id2524842}{}%

Every FreeSCI graphics driver provides an individual implementation for one specific target platform, such as the X Window System. In order to work correctly, it needs to implement the interface outlined in {\texttt{{src/\dbz{}include/\dbz{}gfx\_\dbz{}driver.\dbz{}h}}} and list itself in {\texttt{{src/\dbz{}include/\dbz{}gfx\_\dbz{}drivers.\dbz{}h}}}. Drivers have some freedom in determining which features they want to provide and which they want to have emulated. These features are determined by flags contained in its variable {\texttt{{capabilities}}}.

Graphics drivers must provide at least five buffers: Both priority buffers, and the three visual buffers. They are grouped in three sets labelled the Front Buffer (only one visual buffer), the Back Buffer, and the Static Buffer (both containing both a priority and a visual buffer). Most graphical operations operate on the back buffer, with their results being propagated to the front buffer by means of explicit buffer operations\label{id2524886}\begingroup\catcode`\#=12\footnote{
These operations operate on partial buffer contents and expect the back buffer's contents to be unmodified after the transfer. This is unlike the OpenGL back buffer concept.
}\endgroup\docbooktolatexmakefootnoteref{id2524886}.

Driver implementations with limited or no hardware accelleration support, such as those operating on plain frame buffers, may use some shared functionality exported for their benefit. Those functions are listed in the appropriate function definitions below.

Unless specified differently, each function must return {\texttt{{GFX\_\dbz{}OK}}} on success, {\texttt{{GFX\_\dbz{}ERROR}}} on failure, and {\texttt{{GFX\_\dbz{}FATAL}}} if and only if a fatal and unrecoverable error occured, such as the target display being closed by external means.

Functions that receive color parameters must respect those parameters' mask values for {\texttt{{GFX\_\dbz{}MAP\_\dbz{}MASK}}}.
\subsubsection{I/O and debug functionality}
\label{id2524938}\hypertarget{id2524938}{}%

For basic input and output, the {\texttt{{GFXDEBUG()}}}, {\texttt{{GFXWARN()}}} and {\texttt{{GFXERROR()}}} macros defined in {\texttt{{src/\dbz{}include/\dbz{}gfx\_\dbz{}system.\dbz{}h}}} can be used. Also, there is another variable, {\texttt{{debug\_\dbz{}flags}}} defined for drivers; while it cannot be changed during runtime (yet), it may be used in combination with the various GFX\_DEBUG\_ constants to selectively enable and disable debugging for certain parts of the driver during development.

For further debugging, the FreeSCI functions {\texttt{{sciprintf()}}} (a printf clone), {\texttt{{MEMTEST()}}} (tries to detect heap corruption), and {\texttt{{BREAKPOINT()}}} (Sets a debugger breakpoint on Alpha, ia32 and SPARC) may be used.
\subsubsection{Initialization and shutdown functionality}
\label{id2525008}\hypertarget{id2525008}{}%

None of the functions defined in here are optional. They are called during startup or shutdown and need not be considered performance critical.
\subparagraph*{set\_parameter(attribute, value)}
\label{id2525020}\hypertarget{id2525020}{}%

This function is completely driver specific. Drivers may use it to allow external configuration of options not covered by the standard FreeSCI set of configuration options. It must be implemented to operate correctly both if {\texttt{{init()}}} has already been called and if it hasn't, although it may choose to ignore any options set afterwards.

Documentation of this function's options is up to the graphics driver's maintainer.
\subparagraph*{init\_specific(xscale, yscale, bytespp)}
\label{id2525045}\hypertarget{id2525045}{}%

Initializes a graphics driver to a pre-determined mode, where {\texttt{{xscale}}} and {\texttt{{yscale}}} are the requested horizontal and vertical scaling factors (integers \textgreater{} 0), and {\texttt{{bytespp}}} is the number of bytes per pixel on the target display.

The function may set a higher resolution, provided that no matching resolution is available. The {\texttt{{mode}}} structure (stored locally to the driver structure) must be set by this function if it succeeds; for this, the function {\texttt{{gfx\_new\_mode()}}}, defined in {\texttt{{src/\dbz{}include/\dbz{}gfx\_\dbz{}tools.\dbz{}h}}}, may be used.

{\texttt{{GFX\_\dbz{}OK}}} must be returned iff the initialization succeeded; otherwise, {\texttt{{GFX\_\dbz{}ERROR}}} must be reported, unless the graphics target is not (or no longer) able to provide any of the supported modes (e.g. if a required external module was not found, or if the driver detected during run-time that the target does not support any appropriate graphics mode).
\subparagraph*{init()}
\label{gfx-driver-init-specific}\hypertarget{gfx-driver-init-specific}{}%

This operation initializes the driver's default graphics mode. Determining this mode is up to the graphics driver; if its target platform has no means for determining an appropriate mode, it may choose to invoke init\_specific() repeatedly with educated guesses. It must return one of {\texttt{{GFX\_\dbz{}OK}}} or {\texttt{{GFX\_\dbz{}FATAL}}}.

See \hyperlink{gfx-driver-init-specific}{Section~{\ref{gfx-driver-init-specific}}} for details.
\subparagraph*{exit()}
\label{id2525164}\hypertarget{id2525164}{}%

Deinitializes the graphics driver, frees all resources allocated by it and just generally performs clean-up. This function must succeed (so it does not have a return value). It may use {\texttt{{gfx\_free\_mode()}}} (from {\texttt{{src/\dbz{}include/\dbz{}gfx\_\dbz{}tools.\dbz{}h}}}) to free the data allocated in the gfx\_mode\_t structure.
\subsubsection{Primitive drawing operations}
\label{id2525194}\hypertarget{id2525194}{}%

"Primitive drawing operations" here are operations that draw primitives. FreeSCI uses only two graphics primitives: Lines and solid boxes, both of which are commonly provided by graphics libraries. Both operations draw to the back buffer; they also must respect the priority aspect of the primary color used on them.
\subparagraph*{draw\_line(line, color, line\_mode, line\_style)}
\label{id2525209}\hypertarget{id2525209}{}%

Draws a single line. The {\texttt{{line}}} parameter describes the starting point and a relative coordinates of the line to draw in the specified {\texttt{{color}}}, whereas {\texttt{{line\_\dbz{}mode}}} specifies the line mode to use. This value may be {\texttt{{GFX\_\dbz{}LINE\_\dbz{}MODE\_\dbz{}FAST}}}, which means that the line's thickness is roughly about the average of the horizontal and vertical scaling factors. The other two values need not be supported (they should fall back to {\texttt{{GFX\_\dbz{}LINE\_\dbz{}MODE\_\dbz{}FAST}}} if they're used'): 

\begin{tabular}{l}
{\texttt{{GFX\_\dbz{}LINE\_\dbz{}MODE\_\dbz{}FAST}}}: Line thickness is averate of x and y scale factors  \\
{\texttt{{GFX\_\dbz{}LINE\_\dbz{}MODE\_\dbz{}CORRECT}}}: Lines are scaled separately for x and y and have correct widths there  \\
{\texttt{{GFX\_\dbz{}LINE\_\dbz{}MODE\_\dbz{}THIN}}}: Line has a width of 1  \\
\end{tabular}


The other parameter, {\texttt{{line\_\dbz{}style}}}, may be either of {\texttt{{GFX\_\dbz{}LINE\_\dbz{}STYLE\_\dbz{}NORMAL}}} or {\texttt{{GFX\_\dbz{}LINE\_\dbz{}STYLE\_\dbz{}STIPPLED}}}, although the latter is used iff the capability flag {\texttt{{GFX\_\dbz{}CAPABILITY\_\dbz{}STIPPLED\_\dbz{}LINES}}} is set.

This function must return GFX\_OK or GFX\_FATAL.
\subparagraph*{draw\_filled\_rect(rect, color1, color2, shade\_mode)}
\label{id2525322}\hypertarget{id2525322}{}%


\subsubsection{Pixmap operations}
\label{id2525333}\hypertarget{id2525333}{}%


\subsubsection{Buffer operations}
\label{id2525343}\hypertarget{id2525343}{}%


\subsubsection{The mouse pointer}
\label{id2525353}\hypertarget{id2525353}{}%


\subsubsection{Palette}
\label{id2525363}\hypertarget{id2525363}{}%


\subsubsection{Event management}
\label{id2525371}\hypertarget{id2525371}{}%


\subsubsection{Capability flag summary}
\label{id2525380}\hypertarget{id2525380}{}%


\subsection{The graphical resource manager (GRM)}
\label{id2525390}\hypertarget{id2525390}{}%


\subsubsection{The operational layer}
\label{fsci-gfx-op}\hypertarget{fsci-gfx-op}{}%


\subsubsection{FreeSCI graphical widgets}
\label{fsci-gfx-widgets}\hypertarget{fsci-gfx-widgets}{}%


\subsubsection{Printing widgets}
\label{fsci-gfx-widgets-string}\hypertarget{fsci-gfx-widgets-string}{}%

By means of each widget's {\texttt{{print}}} method, its state can be written to the FreeSCI output stream. Output of the {\em{STATE}} is as follows: \begin{quote}

{\em{STATE}} ::= {\em{VALIDITY}} "S"{\em{SERIAL}} {\em{ID}} [{\em{BOUNDS}}] {\em{FLAGS}} {\em{WIDGET-INFO}} {\em{VALIDITY}} ::= "v" /* widget is valid */ \docbooktolatexpipe{} "NoVis" /* Valid, but does not have a visual- internal error, unless it's a visual itself */ \docbooktolatexpipe{} "INVALID" /* Widget was invalidated */ \docbooktolatexpipe{} /* empty: Should never happen */ {\em{SERIAL}} ::= {\texttt{{HEXNUMBER}}} /* The widget's unique serial number */ {\em{ID}} ::= /* No ID */ \docbooktolatexpipe{} "\#"{\em{HEXNUMBER}} /* ID assigned to the widget- typically an SCI heap address */ {\em{BOUNDS}} ::= ({\em{X-COORDINATE}},{\em{Y-COORDINATE}})({\em{WIDTH}},{\em{HEIGHT}}) /* Full extension of the graphics described by the widget */
\end{quote}
 The {\em{FLAGS}} are described by a sequence of characters; their meanings are listed below: 

\begin{tabular}{ll}
\texttt{V}& Widget is visible  \\
\texttt{O}& Widget is completely opaque, i.e. fully covers all area in its bounds  \\
\texttt{C}& Widget is a container  \\
\texttt{D}& Widget is "dirty", i.e. will be redrawn at the next update  \\
\texttt{T}& Widget has been tagged for clean-up  \\
\texttt{M}& The widget's ID is not considered to be unique  \\
\texttt{I}& Widget will not be freed if a snapshot is resored  \\
\end{tabular}

 The widget's ID will generally be considered to be unique within the container it is appended to, unless the Multi-ID flag ('M') is set. Functionally, this means that a widget {\texttt{{w}}} is appended to a list containing one or more widgets with an ID identical to its own, it overwrites the first widget with a matching ID, unless {\texttt{{w}}} itself has the {\em{M}} flag set.

The {\em{WIDGET-DESCRIPTION}} part of a widget starts with a string describing the widget's type; this is followed by widget- specific information.
\subsection{Interpreter interaction}
\label{id2525595}\hypertarget{id2525595}{}%



% ------------------------   
% Section 
\section{Kernel hacking}
\label{id2525605}\hypertarget{id2525605}{}%

Kernel functions are the bridge between the abstract virtual machine, and the world of real programs. The VM may be able to solve RPN equations in the blink of an eye, but what good is this if it can't read input or produce output?\label{id2525618}\begingroup\catcode`\#=12\footnote{
It could be used to produce benchmarks.
}\endgroup\docbooktolatexmakefootnoteref{id2525618}

All of the kernel functions are stored in src/core/kernel.c. Since kernel function mapping is done during runtime by string comparison, each kernel function and its name have to be registered in the array kfunct\_mappers[]. Note that each version of the SCI interpreter (at least each pre-1.000.000 version) comes with one unidentified kernel function, which is handled by {\texttt{{k\_Unknown}}}.
\subsection{Kernel basics}
\label{id2525640}\hypertarget{id2525640}{}%

Each kernel function is declared like this: 
\begin{Verbatim}[]

              void
              kFooBar(state_t *s, int funct_nr, int argc, heap_ptr argp);
              
\end{Verbatim}
 So this is how you should start. The four parameters (think of them as the Four Accessories of a kernel function) mean the following: 

\begin{tabular}{lp{13cm}}
\texttt{state\_t *s}& A pointer to the state you are operating on.  \\
\texttt{int funct\_nr}& The number of this function. Mostly irrelevant.  \\
\texttt{int argc}& The number of arguments.  \\
\texttt{heap\_ptr argp}& Heap pointer to the first argument.  \\
\end{tabular}

 "s" contains a lot of important and interesting data. Have a look at src/include/engine.h for a complete description. What you will probably need mostly will be the heap, (s-\textgreater{}heap), a unsigned char pointer, and the accumulator (s-\textgreater{}acc), a word (guint16), which is used to return values to the SCI program.

Some kernel functions don't even need to refer to the heap. However, most of them are passed at least one, if not more parameters. This may sound shocking to you, but there is an easy way to work around the neccessity of peeling them off the heap manually: Use the PARAM macros. They are used as follows: 

\begin{tabular}{lp{11cm}}
\texttt{PARAM(\textit{x})}	& Returns the value of the parameter \texttt{\textit{x}}. Does not check for validity.  \\
\texttt{UPARAM(\textit{x})}	& Same as \texttt{PARAM(\textit{x})}, but casts the parameter to be unsigned.  \\
\texttt{PARAM\_OR\_ALT(\textit{x}, \textit{y})}		& Checks if \texttt{PARAM(\textit{x})} is valid and returns it, or returns \texttt{\textit{y}} if \texttt{PARAM(\textit{x})} is invalid.  \\
\texttt{UPARAM\_OR\_ALT(\textit{x}, \textit{y})}	& \texttt{PARAM\_OR\_ALT(\textit{x}, \textit{y})} unsigned.  \\
\end{tabular}

 Several kernel functions assume default values if a specific parameter is not present, to simplify the use of optional parameters. Use the \texttt{U?PARAM\_OR\_ALT(x, y)} macros to detect this case, and you'll rarely have to care about using argc directly.
\subsection{Hunk and heap}
\label{id2525728}\hypertarget{id2525728}{}%

Accessing the heap for both reading and writing is surprisingly important for the kernel, especially when it has to deal with functions that would usually belong into user space, like handling of doubly-linked lists. To ease this, three macros are available: 

\begin{tabular}{lp{12cm}}
\texttt{GET\_HEAP(\textit{x})} & reads a signed SCI word (gint16) from heap address x  \\
\texttt{UGET\_HEAP(\textit{x})} & reads an unsigned SCI word (guint16)  \\
\texttt{PUT\_HEAP(\textit{x}, \textit{foo})} & writes the value foo to the specified heap address  \\
\end{tabular}


Some kernel functions, especially graphical kernel functions, additionally require the usage of what Sierra referred to as "hunk space". This is dynamically allocated memory; it can even be allocated and unallocated manually from SCI scripts by using the Load() and UnLoad() system calls (this is the sci\_memory resource). To allow usage of this kind of memory, three functions have been provided: 

\begin{tabular}{lp{9cm}}
\texttt{int kalloc(state\_t *, space)} & allocate space bytes and return a handle  \\
\texttt{byte *kmem(state\_t *, handle)} & resolve a handle and return the memory address it points to  \\
\texttt{int kfree(state\_t *, handle)} & unallocate memory associated with a handle. Returns 0 on success, 1 otherwise  \\
\end{tabular}

\subsection{Error handling and debugging}
\label{id2525793}\hypertarget{id2525793}{}%

Error handling and debugging probably are the most important aspects of program writing. FreeSCI provides three macros for printing debug output: 

\begin{tabular}{lp{11cm}}
\texttt{SCIkwarn(\textit{text}, \ldots)} & Print a warning message  \\
\texttt{SCIkdebug(\textit{text}, \ldots)} & Print a debug message  \\
\texttt{CHECK\_THIS\_KERNEL\_FUNCTION} & print the function name and parameters  \\
\end{tabular}
 The difference between SCIkwarn and SCIkdebug is that the latter can be easily removed (by commenting out the \#define SCI\_KERNEL\_DEBUG on or about line 39). In practice this means that SCIkwarn should be used for warning or error messages in cases where it is likely that the vm or the kernel function are doing something wrong; e.g. if the program refers to a non-existant resource file, if a node list command does not come with a pointer to a node list, or if the number of parameters is insufficient. These messages are important and may point to misperceptions of details of the SCI engine. SCIkdebug, on the other hand, is your every-day "flood me with information until I'm blind" debug macro.

Sometimes it may happen that something goes wrong inside the kernel; e.g. a kernel function runs out of memory handles, or an internal variable somehow was set to an invalid value. In this case, {\texttt{{kernel\_oops(state\_t *, char *)}}} should be used. It prints an error message and halts the VM, which none of the macros does.
\subsection{Selectors}
\label{id2525854}\hypertarget{id2525854}{}%

Selectors are very important for some of the kernel functions. BaseSetter(), Animate(), Display(), GetEvent() and others take data from or write directly to selectors of a specified object (passed as a parameter or retreived from a node list), or even call object methods from kernel space\label{id2525867}\begingroup\catcode`\#=12\footnote{
Yes, this is evil. Don't do this at home, kids!
}\endgroup\docbooktolatexmakefootnoteref{id2525867} To prepare the usage of selectors, a variable has do be declared (in src/include/vm.h, selector\_map\_t). This variable will carry the numeric selector ID during run time. Now, the selector has to be mapped- this is happens once during initialization, to save time. It is performed by script\_map\_selectors(), which is located at the end of src/core/script.c (just use the "FIND\_SELECTOR" macro).

If everything went right, accessing selectors should be really easy now. Just use the GET\_SELECTOR(obj, selector) and PUT\_SELECTOR(obj, selector, value) macros, where obj is a heap\_ptr pointing to the object you want to read from or write to, and selector is the name of the selector to use. 
\begin{example}%
\hypertarget{id2525889}{}%
\captionswapskip{}{{\caption{An example for PUT\_SELECTOR and GET\_SELECTOR}\label{id2525889}}}
\captionswapskip{}
\begin{Verbatim}[]

              void
              kSwapXY(state_t *s, int funct_nr, int argc, heap_ptr argp)
              {
                int posx, posy;
                heap_ptr obj = PARAM(0);

                posx = GET_SELECTOR(obj, x);
                posy = GET_SELECTOR(obj, y); /* x and y are defined in selector_map_t */

                PUT_SELECTOR(obj, y, posx);
                PUT_SELECTOR(obj, x, posy);
              }
              
\end{Verbatim}
\end{example}



Also, it may be neccessary to invoke an actual method. To do this, a varargs macro has been provided: INVOKE\_SELECTOR(obj, selector, argc\ldots). In theory, this macro can be used to set and read selectors as well (it would even handle multiple sends correctly), but this is discouraged for the sake of clarity.

INVOKE\_SELECTOR works very much like the other macros; it must be called directly from a kernel function (or from any function supplying valid argc, argp and s). 
\begin{example}%
\hypertarget{id2525921}{}%
\captionswapskip{}{{\caption{An example for INVOKE\_SELECTOR}\label{id2525921}}}
\captionswapskip{}
\begin{Verbatim}[]

                INVOKE_SELECTOR(obj, doit, 0); /* Call doit() without any parameters */
                INVOKE_SELECTOR(s->game_obj, setCursor, 2, 999, 1);
                                /* Call game_obj::setCursor(999, 1) */
              
\end{Verbatim}
\end{example}



\end{document}

